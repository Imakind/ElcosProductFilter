<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Корзина</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
<div class="container">
    <h2 class="mb-4">Корзина</h2>

    <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
            <thead class="table-light">
            <tr>
                <th>№</th>
                <th>Наименование</th>
                <th>Артикул</th>
                <th>Бренд</th>
                <th>Кол-во</th>
                <th>Базовая цена</th>
                <th>Сумма базовая</th>
                <th>Коэф.</th>
                <th>Цена</th>
                <th>Сумма</th>
                <th>Маржа</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="product, iterStat : ${cartProducts}">
                <td th:text="${iterStat.count}">1</td>
                <td th:text="${product.name}">Название</td>
                <td th:text="${product.articleCode}">Код</td>
                <td th:text="${product.brand.brandName}">Бренд</td>
                <td>
                    <input type="number" min="1" class="form-control form-control-sm text-center"
                           th:id="'counter-' + ${product.productId}"
                           th:value="${quantities[product.productId]}"
                           onchange="manualQuantityChange(this)">
                </td>
                <td th:text="${#numbers.formatDecimal(product.price, 1, 'COMMA', 1, 'POINT')}">0</td>
                <td th:id="'base-sum-' + ${product.productId}"
                    th:text="${#numbers.formatDecimal(product.price * quantities[product.productId], 1, 'COMMA', 1, 'POINT')}">0</td>
                <td>
                    <input type="number" step="0.1" class="form-control form-control-sm text-center"
                           th:id="'coefficient-' + ${product.productId}"
                           th:value="${coefficientMap[product.productId] != null ? coefficientMap[product.productId] : 1.0}"
                           oninput="coefficientInputChanged(this)">
                </td>
                <td th:id="'unit-price-' + ${product.productId}">0</td>
                <td th:id="'total-sum-' + ${product.productId}">0</td>
                <td th:id="'margin-' + ${product.productId}">0</td>
            </tr>
            </tbody>
            <tfoot>
            <tr class="fw-bold">
                <td colspan="4" class="text-end">Итого:</td>
                <td th:text="${totalQuantity}">0</td>
                <td></td>
                <td th:id="total-base">0</td>
                <td></td>
                <td></td>
                <td th:id="total-final">0</td>
                <td th:id="total-margin">0</td>
            </tr>
            </tfoot>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('tr[id^="product-"]');
        recalculateAll();

        document.querySelectorAll('input[id^="coefficient-"]').forEach(input => {
            input.addEventListener('input', () => recalculateAll());
        });
    });

    function manualQuantityChange(input) {
        const productId = input.id.split('-')[1];
        const qty = parseFloat(input.value);
        if (qty > 0) {
            fetch('/cart/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'productId=' + productId + '&quantity=' + qty
            }).then(() => recalculateAll());
        }
    }

    function coefficientInputChanged(input) {
        const productId = input.id.split('-')[1];
        const value = parseFloat(input.value);
        if (!isNaN(value) && value > 0) {
            fetch('/cart/coefficient', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'productId=' + productId + '&coefficient=' + value
            }).then(() => recalculateAll());
        }
    }

    function recalculateAll() {
        let totalBase = 0;
        let totalFinal = 0;

        document.querySelectorAll('input[id^="counter-"]').forEach(counterInput => {
            const productId = counterInput.id.split('-')[1];
            const qty = parseFloat(document.getElementById('counter-' + productId)?.value || 1);
            const base = parseFloat(document.getElementById('base-sum-' + productId)?.innerText.replace(',', '.') || 0);
            const coeff = parseFloat(document.getElementById('coefficient-' + productId)?.value || 1);

            const unitPrice = (base / qty) * coeff;
            const total = unitPrice * qty;
            const margin = total - base;

            document.getElementById('unit-price-' + productId).innerText = unitPrice.toFixed(1);
            document.getElementById('total-sum-' + productId).innerText = total.toFixed(1);
            document.getElementById('margin-' + productId).innerText = margin.toFixed(1);

            totalBase += base;
            totalFinal += total;
        });

        document.getElementById('total-base').innerText = totalBase.toFixed(1);
        document.getElementById('total-final').innerText = totalFinal.toFixed(1);
        document.getElementById('total-margin').innerText = (totalFinal - totalBase).toFixed(1);
    }
</script>
</body>
</html>
