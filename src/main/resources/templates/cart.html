<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Корзина</title>

    <!-- безопасно даже при отключённом CSRF -->
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root { --gap:16px; }
        body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0f0f0f; color:#eaeaea; }
        a, button, input, select { color:inherit; }
        .page { padding: 20px; max-width: 1280px; margin: 0 auto; }
        h1 { margin: 0 0 16px; font-size: 22px; }

        .cart-layout { display: grid; grid-template-columns: clamp(380px, 30vw, 520px) 1fr; gap: var(--gap); align-items: start; }
        .panel { border: 1px solid #2a2a2a; border-radius: 12px; padding: 12px; background:#151515; }
        .panel h3 { margin: 0 0 8px; font-size: 16px; display:flex; align-items:center; gap:8px; }

        .hint { font-size:12px; opacity:.75; }
        .muted { opacity:.85; }

        .tree { max-height: calc(100vh - 320px); overflow: auto; padding-right: 4px; }
        .tree ul { list-style: none; padding-left: 16px; margin: 6px 0; }
        .tree li { margin: 2px 0; }
        .node-row { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 8px; cursor: pointer; }
        .node-row:hover { background:#1e2833; }
        .node-row .icon { width: 22px; text-align: center; opacity:.8; }
        .node-row .label {
            flex: 1;
            min-width: 0;
            line-height: 1.3;
            white-space: normal;
            word-break: break-word;
        }
        .node-row .label.selected { text-decoration: none; font-weight: 600; }
        .node-row.selected {
            background:#253244;
            outline: 1px solid #334;
        }

        .folder-products { margin-top:10px; border-top:1px solid #2a2a2a; padding-top:8px; }
        .folder-products h4 { font-size:13px; margin:0 0 6px; opacity:.85;}
        .folder-products ul { list-style:none; padding:0; margin:0; max-height:200px; overflow:auto;}
        .folder-products li { font-size:12px; padding:3px 0; opacity:.92; }
        .folder-products li a { text-decoration:none; border-bottom:1px dashed #444; cursor:pointer; }
        .folder-products .empty { opacity:.6; font-size:12px; }

        .btn { border:1px solid #2a2a2a; background:#202020; border-radius:10px; padding:6px 10px; cursor:pointer; text-decoration:none; display:inline-block; }
        .btn:hover { background:#262626; }
        .btn-primary { border-color:#345; background:#1c2430; }
        .btn-primary:hover { background:#222c3a; }
        .btn-danger { border-color:#553; background:#2a1a1a; }
        .btn-danger:hover { background:#311; }

        .summary { display:flex; gap:16px; align-items:center; margin:8px 0 16px; font-size:14px; opacity:.95; flex-wrap:wrap; }
        .summary .pill { border:1px solid #2a2a2a; border-radius:999px; padding:6px 10px; background:#161616; }
        .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-left:auto }

        .save-form { display:flex; gap:8px; align-items:center; }
        .save-form input { background:#1a1a1a; border:1px solid #2a2a2a; border-radius:8px; padding:6px 10px; }

        .subtoolbar { display:flex; gap:8px; margin:10px 0; flex-wrap:wrap; align-items:center; }
        input[type="text"], input[type="number"], select { background:#1a1a1a; border:1px solid #2a2a2a; border-radius:8px; padding:6px 8px; color:#eaeaea; }

        table.list { width:100%; border-collapse: collapse; }
        table.list th, table.list td { padding:6px 8px; border-bottom:1px solid #212121; vertical-align: middle; }
        table.list th { text-align:left; font-weight:600; opacity:.9; position:sticky; top:0; background:#151515; z-index:1; }
        table.list tr:hover { background:#1a1a1a; }
        tr[data-draggable="true"] { cursor: grab; }
        tr[data-draggable="true"]:active { cursor: grabbing; }
        .price, .sum { white-space:nowrap; text-align:right; }
        .qty, .coeff { width:92px; }
        .folder-select { min-width: clamp(220px, 26vw, 360px); padding: 8px 10px; height: 36px; }
        table.list th:nth-child(5),
        table.list td:nth-child(5) { width: clamp(220px, 26vw, 360px); }

        .cluster { display:flex; align-items:center; gap:8px; flex-wrap:nowrap; white-space:nowrap; }

        @media (max-width: 1200px){
            .subtoolbar .folder-select { min-width: 200px; }
        }
        @media (max-width: 980px){
            .subtoolbar .folder-select { min-width: 160px; }
        }

        /* Контекстное меню */
        .context-menu {
            position: fixed;
            z-index: 9999;
            min-width: 200px;
            background:#1b1b1b;
            border:1px solid #2a2a2a;
            border-radius:10px;
            padding:6px;
            box-shadow: 0 8px 24px rgba(0,0,0,.4);
        }
        .context-menu .item {
            padding:8px 10px;
            border-radius:8px;
            cursor:pointer;
            user-select:none;
            font-size:14px;
        }
        .context-menu .item:hover { background:#262626; }
        .context-menu .item[disabled] { opacity:.5; pointer-events:none; }
        .context-menu .sep { height:1px; background:#2a2a2a; margin:6px 0; }

        /* Модалка перемещения папки */
        /* ===== Новая модалка перемещения папки ===== */

        /* ===== Новая модалка перемещения папки (НЕ Bootstrap) ===== */

        .folder-move-backdrop {
            position: fixed;
            inset:0;
            z-index:9998;
            background: rgba(0,0,0,.55);
            display:flex;
            align-items:center;
            justify-content:center;
            opacity:0;
            pointer-events:none;
            transition:opacity .18s ease;
        }

        .folder-move-backdrop.show {
            opacity:1;
            pointer-events:auto;
        }

        .folder-move-modal {
            background:#161616;
            border:1px solid #2a2a2a;
            border-radius:12px;
            padding:12px;
            min-width:320px;
            max-width:90vw;
            color:#eaeaea;
            box-shadow:0 16px 40px rgba(0,0,0,.5);
            opacity:0;
            transform:scale(.92);
            transition:opacity .18s ease, transform .18s ease;
        }

        .folder-move-backdrop.show .folder-move-modal {
            opacity:1;
            transform:scale(1);
        }


        .modal h4 { margin:0 0 8px; font-size:16px; }
        .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
        .modal select { width:100%; background:#1a1a1a; border:1px solid #2a2a2a; border-radius:8px; padding:6px 8px; color:#eaeaea; }
        .modal .btn { border-radius:8px; }

        #currentFolderLabel {
            font-weight: 700;
            padding: 2px 6px;
            background:#202a36;
            border:1px solid #2a2a2a;
            border-radius: 6px;
        }

        /* === Калькулятор: плавающая панель справа + кнопка-стрелка === */

        .calc-toggle-floating {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            border-radius: 12px 0 0 12px;
            border: 1px solid #2a2a2a;
            border-right: none;
            background:#202020;
            width: 32px;
            height: 64px;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            z-index: 10001;
            font-size:18px;
            padding:0;
        }
        .calc-toggle-floating:hover { background:#262626; }

        .calc-panel-floating {
            position: fixed;
            top: 50%;
            right: 56px;
            transform: translateY(-50%);
            width: 340px;
            max-height: 80vh;
            overflow:auto;
            z-index: 10000;
            display:none;
        }
        .calc-panel-floating.visible {
            display:block;
        }

        .calc-header {
            display:flex;
            align-items:center;
            justify-content:space-between;
            margin:0 0 6px;
            cursor:move;
            gap:8px;
        }
        .calc-header-title { font-size:15px; font-weight:600; }
        .calc-header .btn {
            padding:2px 6px;
            border-radius:6px;
            font-size:12px;
        }

        .calc-table {
            width:100%;
            border-collapse:collapse;
            font-size:13px;
        }
        .calc-table td {
            padding:3px 4px;
            border-bottom:1px solid #202020;
        }
        .calc-table .section-row td {
            padding-top:6px;
            font-weight:600;
            background:#191919;
        }
        .calc-table input[type="number"]{
            width:100%;
            box-sizing:border-box;
            padding:4px 6px;
            font-size:13px;
        }
        .calc-table .result-row td {
            background:#152016;
            font-weight:600;
        }
        .calc-table .result-row strong {
            font-size:13px;
        }
        .calc-result {
            text-align:right;
            white-space:nowrap;
        }

        .name-cell{
            position: relative;
            overflow: visible;
        }

        /* popover СКРЫТ без display */
        .params-popover{
            position:absolute;
            left:0;
            top:100%;
            margin-top:6px;

            background: rgba(18,18,18,0.92);
            border: 1px solid #2f2f2f;
            border-radius: 10px;
            padding: 8px 10px;

            font-size:12px;
            line-height:1.35;
            color:#eaeaea;

            max-width: 360px;
            width: max-content;
            z-index: 999;
            box-shadow: 0 8px 24px rgba(0,0,0,.45);
            backdrop-filter: blur(4px);

            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity .12s ease;
        }

        /* hover-show без рефлоу */
        .name-cell:hover .params-popover{
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }

        /* поддержка тача/клика */
        .name-cell.popover-open .params-popover{
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
        }


        /* локальный popover больше не показываем (он только как шаблон) */
        .params-popover { display:none !important; }

        /* глобальный tooltip */
        .vp-tooltip{
            position: fixed;
            z-index: 20000;
            background: rgba(18,18,18,0.94);
            border:1px solid #2f2f2f;
            border-radius:10px;
            padding:8px 10px;
            font-size:12px;
            line-height:1.35;
            color:#eaeaea;
            max-width:360px;
            box-shadow:0 8px 24px rgba(0,0,0,.45);
            backdrop-filter: blur(4px);
            pointer-events:none;
            display:none;
        }
        .vp-tooltip .params-title{
            font-weight:600;
            margin-bottom:4px;
            opacity:.9;
        }

        /* Кнопки всегда читаемые */
        .btn,
        .btn * {
            color:#eaeaea !important;
            opacity:1 !important;
        }

        .btn-primary,
        .btn-danger,
        .btn-secondary,
        .btn-success {
            color:#fff !important;
        }

        .calc-section{
            margin-top:8px;
            margin-bottom:8px;
            padding:8px 10px;
            border-radius:10px;
            background:#181818;
            border:1px solid #232323;
        }
        .calc-section-title{
            font-size:13px;
            font-weight:600;
            margin-bottom:6px;
            opacity:.9;
        }
        .calc-grid{
            display:grid;
            grid-template-columns:1fr 1fr;
            gap:6px 12px;
        }
        .calc-field-row{
            display:flex;
            flex-direction:column;
            font-size:12px;
        }
        .calc-label{
            margin-bottom:2px;
            opacity:.9;
        }
        .calc-field-row input{
            width:100%;
            box-sizing:border-box;
            padding:4px 6px;
            font-size:13px;
        }
        .calc-results{
            margin-top:4px;
            font-size:12px;
        }
        .calc-results-row{
            display:flex;
            justify-content:space-between;
            gap:8px;
            margin-bottom:2px;
        }
        .calc-results-row span:last-child{
            font-variant-numeric:tabular-nums;
        }
        .calc-mat-list{
            max-height:220px;
            overflow:auto;
            padding-right:4px;
        }
        .calc-mat-row{
            border-top:1px solid #222;
            padding-top:6px;
            margin-top:6px;
        }
        .calc-mat-name{
            font-size:12px;
            margin-bottom:4px;
        }
        .calc-mat-fields{
            display:flex;
            flex-direction:column;
            gap:4px;
            font-size:12px;
        }
        .calc-field-inline{
            display:flex;
            align-items:center;
            gap:4px;
        }
        .calc-mat-input{
            flex:0 0 90px;
        }
        .calc-mat-sum{
            font-size:12px;
            opacity:.9;
        }
        .calc-field-label{
            opacity:.8;
        }
        .calc-mat-qty-value,
        .calc-mat-sum-value{
            font-variant-numeric:tabular-nums;
        }
        @media (max-width: 480px){
            .calc-grid{
                grid-template-columns:1fr;
            }
        }
        .calc-panel-floating{
            resize: both;
            overflow: auto;
        }

        .calc-mat-list{
            max-height: 400px;
            overflow: auto;
        }
        /* Стиль как у остальных инпутов калькулятора */
        .calc-table input,
        .calc-grid input {
            background:#1a1a1a;
            border:1px solid #2a2a2a;
            border-radius:8px;
            padding:4px 6px;
            color:#eaeaea;
            width:100%;
            box-sizing:border-box;
            height:30px;
        }

        /* hover */
        .calc-table input:hover,
        .calc-grid input:hover {
            border-color:#3a3a3a;
        }

        /* focus */
        .calc-table input:focus,
        .calc-grid input:focus {
            outline:none;
            border-color:#4c6fff;
            background:#1f1f1f;
        }

    </style>
</head>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<body>
<div class="page">

    <h1>Корзина</h1>

    <div class="summary">
        <div class="pill">Позиций: <span id="positionsCount" th:text="${#lists.size(cartProducts)}">0</span></div>
        <div class="pill">Кол-во всего: <span id="totalQty" th:text="${totalQuantity}">0</span></div>
        <div class="pill">Сумма: <span id="grandTotal" th:text="${#numbers.formatDecimal(totalSum,1,2,'COMMA')}">0,00</span></div>

        <div class="toolbar">
            <a class="btn" href="/cart">Обновить</a>
            <a class="btn" href="/">На главную</a>
            <a class="btn" href="/cart/excel">Выгрузить смету (Excel)</a>
            <a class="btn btn-success"
               data-bs-toggle="modal"
               data-bs-target="#uploadEstimateModal">
                Загрузить смету (Excel)
            </a>
            <form method="post" action="/cart/confirm" style="display:inline;">
                <button class="btn btn-primary">Оформить предложение</button>
            </form>
        </div>
    </div>

    <div class="panel" style="margin-bottom:16px">
        <form class="save-form" id="saveEstimateForm" method="post" action="/cart/save-estimate">
            <span class="muted">Сохранить смету в историю:</span>
            <input name="projectName" type="text" placeholder="Название проекта" required />
            <input type="hidden" name="folderMappingJson" id="folderMappingJson" />
            <button class="btn">Сохранить</button>
        </form>
        <div class="hint" style="margin-top:6px">Смета сохранится с текущим составом корзины, количеством, коэффициентами, ценами и папками.</div>
    </div>

    <!-- Основной блок: дерево папок + таблица -->
    <div class="cart-layout">
        <aside class="panel">
            <h3>Папки <span class="hint">перетаскивайте строки таблицы на нужную папку. ПКМ по папке — меню</span></h3>

            <div class="tree" id="sectionTree"></div>

            <div style="margin-top:10px; font-size:12px; opacity:.8">
                Выбрана папка: <span id="currentFolderLabel">Общий</span>
            </div>

            <div id="folderProducts" class="folder-products">
                <h4>Товары в папке</h4>
                <div class="empty">Пока пусто</div>
            </div>
        </aside>

        <main class="panel">
            <div class="subtoolbar">
                <span class="muted">Перенести выделенные →</span>
                <select id="bulkFolderSelect" class="folder-select"></select>
                <button type="button" class="btn" id="moveSelectedBtn">Перенести</button>

                <button type="button" class="btn btn-danger" id="deleteSelectedBtn">Удалить выбранные</button>

                <div class="cluster">
                    <span class="muted">Коэфф. для выделенных:</span>
                    <input type="number" step="0.01" min="0" id="bulkCoeffInput" value="1.00" style="width:110px" />
                    <button type="button" class="btn" id="applyCoeffBtn" disabled>Применить</button>
                </div>

                <span class="muted">Фильтр по названию:</span>
                <input type="text" id="searchInput" placeholder="Начните ввод..." />
            </div>

            <div style="overflow:auto; max-height:70vh;">
                <table class="list" id="cartTable">
                    <thead>
                    <tr>
                        <th style="width:36px;"><input type="checkbox" id="toggleAll" title="Выделить все видимые"></th>
                        <th>Наименование</th>
                        <th>Бренд</th>
                        <th>Артикул</th>
                        <th>Папка</th>
                        <th style="width:110px;">Кол-во</th>
                        <th style="width:120px;">Коэфф.</th>
                        <th class="price">Цена, шт</th>
                        <th class="sum">Сумма</th>
                    </tr>
                    </thead>
                    <tbody id="cartTbody">
                    <tr th:each="p : ${cartProducts}"
                        th:attr="data-product-id=${p.productId}"
                        data-draggable="true">
                        <td><input type="checkbox" class="row-check"></td>

                        <td class="name name-cell">
                            <div th:text="${p.name}">Наименование</div>

                            <div class="params-popover"
                                 th:with="
        pidRaw=${p.productId},
        pidS=${#strings.concat('', pidRaw)},

        pp0=${paramsByProduct != null and paramsByProduct.containsKey(pidRaw) ? paramsByProduct[pidRaw] : null},
        pp1=${pp0 != null ? pp0 : (paramsByProduct != null and paramsByProduct.containsKey(pidS) ? paramsByProduct[pidS] : null)},
        pp2=${pp1 != null ? pp1 : (paramsByProduct != null and paramsByProduct.containsKey(T(java.lang.Long).valueOf(pidS)) ? paramsByProduct[T(java.lang.Long).valueOf(pidS)] : null)},
        pp3=${pp2 != null ? pp2 : (paramsByProduct != null and paramsByProduct.containsKey(T(java.lang.Integer).valueOf(pidS)) ? paramsByProduct[T(java.lang.Integer).valueOf(pidS)] : null)},
        pp=${pp3}
     ">
                                <div class="params-title">Параметры</div>

                                <div th:if="${pp == null}" class="muted">Нет параметров</div>

                                <div th:if="${pp != null}">
                                    <div th:text="${pp.param1}" th:if="${pp.param1 != null}"></div>
                                    <div th:text="${pp.param2}" th:if="${pp.param2 != null}"></div>
                                    <div th:text="${pp.param3}" th:if="${pp.param3 != null}"></div>
                                    <div th:text="${pp.param4}" th:if="${pp.param4 != null}"></div>
                                    <div th:text="${pp.param5}" th:if="${pp.param5 != null}"></div>
                                </div>
                            </div>
                        </td>
                        <td th:text="${p.brand != null ? p.brand.brandName : '—'}">Brand</td>
                        <td th:text="${p.articleCode}">code</td>

                        <td>
                            <select class="folder-select row-folder"></select>
                        </td>

                        <td>
                            <div style="display:flex; gap:6px; align-items:center;">
                                <button type="button" class="btn" onclick="cartUI.plusMinus(this,-1)">−</button>
                                <input class="qty" type="number" min="0"
                                       th:value="${quantities[p.productId]}"
                                       oninput="cartUI.updateQty(this)"
                                       th:attr="data-product-id=${p.productId}">
                                <button type="button" class="btn" onclick="cartUI.plusMinus(this,1)">+</button>
                            </div>
                        </td>

                        <td>
                            <input class="coeff" type="number" step="0.01" min="0"
                                   th:value="${(coefficientMap != null and coefficientMap.containsKey(p.productId)) ? coefficientMap[p.productId] : 1.0}"
                                   oninput="cartUI.updateCoeff(this)"
                                   th:attr="data-product-id=${p.productId}">
                        </td>

                        <td class="price"
                            th:with="
        pidRaw=${p.productId},
        pidS=${#strings.concat('', pidRaw)},

        bp0=${baseUnitPriceMap != null and baseUnitPriceMap.containsKey(pidRaw) ? baseUnitPriceMap[pidRaw] : null},
        bp1=${bp0 != null ? bp0 : (baseUnitPriceMap != null and baseUnitPriceMap.containsKey(pidS) ? baseUnitPriceMap[pidS] : null)},
        bp2=${bp1 != null ? bp1 : (baseUnitPriceMap != null and baseUnitPriceMap.containsKey(T(java.lang.Long).valueOf(pidS)) ? baseUnitPriceMap[T(java.lang.Long).valueOf(pidS)] : null)},
        bp3=${bp2 != null ? bp2 : (baseUnitPriceMap != null and baseUnitPriceMap.containsKey(T(java.lang.Integer).valueOf(pidS)) ? baseUnitPriceMap[T(java.lang.Integer).valueOf(pidS)] : null)},
        bp=${bp3 != null ? bp3 : 0}
    "
                            th:attr="data-base-price=${bp}, data-unit-price=${bp}"
                            th:text="${#numbers.formatDecimal(bp, 1, 2, 'COMMA')}">
                            0,00
                        </td>


                        <td class="sum">0,00</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<!-- Кнопка-стрелка справа -->
<button id="calcToggleFloating" class="calc-toggle-floating" type="button" title="Калькулятор">
    &lt;
</button>

<!-- Плавающая панель калькулятора -->
<!-- Плавающая панель калькулятора -->
<section id="calcFloatingPanel" class="panel calc-panel-floating">

    <div class="calc-header">
        <span class="calc-header-title">Калькулятор пустого изделия ELCOS</span>
        <button id="calcCloseBtn" type="button" class="btn">✕</button>
    </div>

    <div class="hint" style="margin-bottom:6px;">
        Формулы 1:1 с «Пустое издел». Все расходники, металл, краска, упаковка, логистика.
    </div>

    <!-- ================= ОБЩИЕ ================= -->
    <div class="calc-section">
        <div class="calc-section-title">Общие параметры</div>

        <div class="calc-grid">
            <div class="calc-field-row">
                <label>Курс Euro (C7)</label>
                <input id="calcC7" class="calc-input" type="number" step="0.01" value="621">
            </div>

            <div class="calc-field-row">
                <label>Коэффициент Елкоса (C8)</label>
                <input id="calcC8" class="calc-input" type="number" step="0.01" value="1.6">
            </div>
        </div>
    </div>

    <!-- ================= РАЗМЕРЫ ================= -->
    <div class="calc-section">
        <div class="calc-section-title">Размеры шкафа</div>

        <div class="calc-grid">
            <div class="calc-field-row">
                <label>Высота, мм (B12)</label>
                <input id="calcB12" class="calc-input" type="number" step="1" value="2100">
            </div>

            <div class="calc-field-row">
                <label>Ширина, мм (C12)</label>
                <input id="calcC12" class="calc-input" type="number" step="1" value="800">
            </div>

            <div class="calc-field-row">
                <label>Глубина, мм (D12)</label>
                <input id="calcD12" class="calc-input" type="number" step="1" value="400">
            </div>

            <div class="calc-field-row">
                <label>Толщина панели, мм (E12)</label>
                <input id="calcE12" class="calc-input" type="number" step="0.1" value="2">
            </div>
        </div>

        <div class="calc-results">
            <div class="calc-results-row">
                <span>Объем, м³ (F12)</span>
                <span id="calcF12">0</span>
            </div>

            <div class="calc-results-row">
                <span>Площадь, м² (G12)</span>
                <span id="calcG12">0</span>
            </div>
        </div>
    </div>

    <!-- ================= РАСХОДНИКИ EXACT F15..F55 ================= -->
    <div class="calc-section">
        <div class="calc-section-title">Расходные материалы (полный список из Excel)</div>

        <div class="calc-mat-list">

            <!-- 15 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Уплотнительная резина полиуретановая наливная</div>
                <input id="mat15_qty" type="number" step="0.01" value="5.8">
                <input id="mat15_price" type="number" step="0.0001" value="0.34">
                <span id="mat15_sum">0</span>
            </div>

            <!-- 16 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Шарнир стандартный  SR 408-1 DIL-1 :</div>
                <input id="mat16_qty" type="number" step="0.01" value="0">
                <input id="mat16_price" type="number" step="0.0001" value="0.82">
                <span id="mat16_sum">0</span>
            </div>

            <!-- 17 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Шарнир стандартный  SR 408-2</div>
                <input id="mat17_qty" type="number" step="0.01" value="4">
                <input id="mat17_price" type="number" step="0.0001" value="1.45">
                <span id="mat17_sum">0</span>
            </div>

            <!-- 18 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Замок распорный 002-5 + SR 303-2 +SR 302-1 + SR-303-1 SERMAK  </div>
                <input id="mat18_qty" type="number" step="0.01" value="1">
                <input id="mat18_price" type="number" step="0.0001" value="12.6">
                <span id="mat18_sum">0</span>
            </div>

            <!-- 19 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Замок  SR 299-1</div>
                <input id="mat19_qty" type="number" step="0.01" value="0">
                <input id="mat19_price" type="number" step="0.0001" value="1.75">
                <span id="mat19_sum">0</span>
            </div>

            <!-- 20 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Замок Мастер ключ IP65: 201-1+201-TK 1 (замки с разными ключами)</div>
                <input id="mat20_qty" type="number" step="0.01" value="0">
                <input id="mat20_price" type="number" step="0.0001" value="1.95">
                <span id="mat20_sum">0</span>
            </div>

            <!-- 21 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Кармашек ELCOS</div>
                <input id="mat21_qty" type="number" step="0.01" value="0">
                <input id="mat21_price" type="number" step="0.0001" value="0.96">
                <span id="mat21_sum">0</span>
            </div>

            <!-- 22 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Наклейка  знак "молния":</div>
                <input id="mat22_qty" type="number" step="0.01" value="1">
                <input id="mat22_price" type="number" step="0.0001" value="0.3">
                <span id="mat22_sum">0</span>
            </div>

            <!-- 23 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Наклейка  знак "земля":</div>
                <input id="mat23_qty" type="number" step="0.01" value="1">
                <input id="mat23_price" type="number" step="0.0001" value="0.3">
                <span id="mat23_sum">0</span>
            </div>

            <!-- 24 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Провод заземление ПВ-3-20 см 6мм2:</div>
                <input id="mat24_qty" type="number" step="0.01" value="2">
                <input id="mat24_price" type="number" step="0.0001" value="0.25">
                <span id="mat24_sum">0</span>
            </div>

            <!-- 25 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Наконечник кольцевой 6*6 мм2</div>
                <input id="mat25_qty" type="number" step="0.01" value="4">
                <input id="mat25_price" type="number" step="0.0001" value="0.05">
                <span id="mat25_sum">0</span>
            </div>

            <!-- 26 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">М6 гайка:</div>
                <input id="mat26_qty" type="number" step="0.01" value="20">
                <input id="mat26_price" type="number" step="0.0001" value="0.03">
                <span id="mat26_sum">0</span>
            </div>

            <!-- 27 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">М6 болт с потайной головкой</div>
                <input id="mat27_qty" type="number" step="0.01" value="20">
                <input id="mat27_price" type="number" step="0.0001" value="0.15">
                <span id="mat27_sum">0</span>
            </div>

            <!-- 28 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">М6*15 мм чакма вида </div>
                <input id="mat28_qty" type="number" step="0.01" value="3">
                <input id="mat28_price" type="number" step="0.0001" value="0.8">
                <span id="mat28_sum">0</span>
            </div>

            <!-- 29 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">М8 болт грибок</div>
                <input id="mat29_qty" type="number" step="0.01" value="3">
                <input id="mat29_price" type="number" step="0.0001" value="0.1">
                <span id="mat29_sum">0</span>
            </div>

            <!-- 30 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">М8 гайка </div>
                <input id="mat30_qty" type="number" step="0.01" value="3">
                <input id="mat30_price" type="number" step="0.0001" value="0.02">
                <span id="mat30_sum">0</span>
            </div>

            <!-- 31 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">М8*20мм шестигранный болт </div>
                <input id="mat31_qty" type="number" step="0.01" value="3">
                <input id="mat31_price" type="number" step="0.0001" value="0.13">
                <span id="mat31_sum">0</span>
            </div>

            <!-- 32 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Утеплитель  Самокл. С Фольгой, толщиной 19мм</div>
                <input id="mat32_qty" type="number" step="0.01" value="2">
                <input id="mat32_price" type="number" step="0.0001" value="8">
                <span id="mat32_sum">0</span>
            </div>

            <!-- 33 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">PG16 IEK</div>
                <input id="mat33_qty" type="number" step="0.01" value="0">
                <input id="mat33_price" type="number" step="0.0001" value="2">
                <span id="mat33_sum">0</span>
            </div>

            <!-- 34 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Щетка SERMAK   730-V1 </div>
                <input id="mat34_qty" type="number" step="0.01" value="1">
                <input id="mat34_price" type="number" step="0.0001" value="18.9">
                <span id="mat34_sum">0</span>
            </div>

            <!-- 35 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Окошко SR 501-2 </div>
                <input id="mat35_qty" type="number" step="0.01" value="0">
                <input id="mat35_price" type="number" step="0.0001" value="9.97">
                <span id="mat35_sum">0</span>
            </div>

            <!-- 36 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник PG13,5 IP54 d отверс. (20мм.) d проводника 6-12мм EKF PROxima</div>
                <input id="mat36_qty" type="number" step="0.01" value="0">
                <input id="mat36_price" type="number" step="0.0001" value="0.1525">
                <span id="mat36_sum">0</span>
            </div>

            <!-- 37 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник PG16 IP54 d отверс. (21мм.) d проводника 10-14мм EKF PROxima</div>
                <input id="mat37_qty" type="number" step="0.01" value="0">
                <input id="mat37_price" type="number" step="0.0001" value="0.185">
                <span id="mat37_sum">0</span>
            </div>

            <!-- 38 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник PG19 IP54 d отверс. (24мм.) d проводника 12-15мм EKF PROxima</div>
                <input id="mat38_qty" type="number" step="0.01" value="0">
                <input id="mat38_price" type="number" step="0.0001" value="0.21">
                <span id="mat38_sum">0</span>
            </div>

            <!-- 39 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник PG21 IP54 d отверс. (27мм.) d проводника 13-18мм EKF PROxima</div>
                <input id="mat39_qty" type="number" step="0.01" value="0">
                <input id="mat39_price" type="number" step="0.0001" value="0.25">
                <span id="mat39_sum">0</span>
            </div>

            <!-- 40 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник PG25 IP54 d отверс. (30мм.) d проводника 16-21мм EKF PROxima</div>
                <input id="mat40_qty" type="number" step="0.01" value="0">
                <input id="mat40_price" type="number" step="0.0001" value="0.315">
                <span id="mat40_sum">0</span>
            </div>

            <!-- 41 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник PG29 IP54 d отверс. (36мм.) d проводника 18-25мм EKF PROxima</div>
                <input id="mat41_qty" type="number" step="0.01" value="0">
                <input id="mat41_price" type="number" step="0.0001" value="0.5125">
                <span id="mat41_sum">0</span>
            </div>

            <!-- 42 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник PG36 IP54 d отверс. (46мм.) d проводника 22-32мм EKF PROxima</div>
                <input id="mat42_qty" type="number" step="0.01" value="0">
                <input id="mat42_price" type="number" step="0.0001" value="0.905">
                <span id="mat42_sum">0</span>
            </div>

            <!-- 43 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник PG42 IP54 d отверс. (53мм.) d проводника 32-38мм EKF PROxima</div>
                <input id="mat43_qty" type="number" step="0.01" value="0">
                <input id="mat43_price" type="number" step="0.0001" value="1.0525">
                <span id="mat43_sum">0</span>
            </div>

            <!-- 44 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник PG48 IP54 d отверс. (59мм.) d проводника 37-44мм EKF PROxima</div>
                <input id="mat44_qty" type="number" step="0.01" value="0">
                <input id="mat44_price" type="number" step="0.0001" value="1.1375">
                <span id="mat44_sum">0</span>
            </div>

            <!-- 45 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник MG12 (внутренний - Ø7,6-4,6)IP68</div>
                <input id="mat45_qty" type="number" step="0.01" value="0">
                <input id="mat45_price" type="number" step="0.0001" value="0.305">
                <span id="mat45_sum">0</span>
            </div>

            <!-- 46 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник MG16 (внутренний - Ø10-6)    IP68</div>
                <input id="mat46_qty" type="number" step="0.01" value="0">
                <input id="mat46_price" type="number" step="0.0001" value="0.4325">
                <span id="mat46_sum">0</span>
            </div>

            <!-- 47 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник MG20 (внутренний - Ø14-9)    IP68</div>
                <input id="mat47_qty" type="number" step="0.01" value="0">
                <input id="mat47_price" type="number" step="0.0001" value="0.595">
                <span id="mat47_sum">0</span>
            </div>

            <!-- 48 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник MG25 (внутренний - Ø18-13) IP68</div>
                <input id="mat48_qty" type="number" step="0.01" value="0">
                <input id="mat48_price" type="number" step="0.0001" value="0.78">
                <span id="mat48_sum">0</span>
            </div>

            <!-- 49 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник MG32 (внутренний - Ø25-18) IP68</div>
                <input id="mat49_qty" type="number" step="0.01" value="0">
                <input id="mat49_price" type="number" step="0.0001" value="1.355">
                <span id="mat49_sum">0</span>
            </div>

            <!-- 50 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник MG40 (внутренний - Ø30-24) IP68</div>
                <input id="mat50_qty" type="number" step="0.01" value="0">
                <input id="mat50_price" type="number" step="0.0001" value="2.145">
                <span id="mat50_sum">0</span>
            </div>

            <!-- 51 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник MG50 (внутренний - Ø39-30) IP68</div>
                <input id="mat51_qty" type="number" step="0.01" value="0">
                <input id="mat51_price" type="number" step="0.0001" value="2.835">
                <span id="mat51_sum">0</span>
            </div>

            <!-- 52 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Сальник MG63 (внутренний - Ø49-39) IP68</div>
                <input id="mat52_qty" type="number" step="0.01" value="0">
                <input id="mat52_price" type="number" step="0.0001" value="4.1375">
                <span id="mat52_sum">0</span>
            </div>

            <!-- 53 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Барашек для фальш панелей SR-506(25) </div>
                <input id="mat53_qty" type="number" step="0.01" value="0">
                <input id="mat53_price" type="number" step="0.0001" value="0.11097">
                <span id="mat53_sum">0</span>
            </div>

            <!-- 54 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Щетка MESAN   340.20.011 -1м </div>
                <input id="mat54_qty" type="number" step="0.01" value="0">
                <input id="mat54_price" type="number" step="0.0001" value="14.6">
                <span id="mat54_sum">0</span>
            </div>

            <!-- 55 -->
            <div class="calc-mat-row">
                <div class="calc-mat-name">Дин рейка  -1м</div>
                <input id="mat55_qty" type="number" step="0.01" value="0">
                <input id="mat55_price" type="number" step="0.0001" value="0.775">
                <span id="mat55_sum">0</span>
            </div>

        </div>

        <div class="calc-results">
            <div class="calc-results-row">
                <span>Монтажный набор, € (F56)</span>
                <span id="calcF56">0</span>
            </div>
        </div>
    </div>

    <div class="calc-section">
        <div class="calc-section-title">Размеры панелей</div>

        <table class="calc-table">
            <thead>
            <tr>
                <th>Шкаф, щит, панель, изделия и т.п.</th>
                <th>Кол-во листов, шт.</th>
                <th>Ширина см</th>
                <th>Высота см</th>
                <th>Площадь см²</th>
            </tr>
            </thead>

            <tbody>
            <tr>
                <td>Передняя и задняя стенки</td>
                <td><input id="r1_qty" value="2"></td>
                <td><input id="r1_w" value="80"></td>
                <td><input id="r1_h" value="210"></td>
                <td id="r1_s">33600</td>
            </tr>

            <tr>
                <td>Боковые стенки</td>
                <td><input id="r2_qty" value="2"></td>
                <td><input id="r2_w" value="40"></td>
                <td><input id="r2_h" value="210"></td>
                <td id="r2_s">16800</td>
            </tr>

            <tr>
                <td>Верх низ стенк</td>
                <td><input id="r3_qty" value="2"></td>
                <td><input id="r3_w" value="40"></td>
                <td><input id="r3_h" value="80"></td>
                <td id="r3_s">6400</td>
            </tr>

            <tr>
                <td>Фалш пан</td>
                <td><input id="r4_qty" value="1"></td>
                <td><input id="r4_w" value="80"></td>
                <td><input id="r4_h" value="210"></td>
                <td id="r4_s">16800</td>
            </tr>

            <tr>
                <td>Внутренност</td>
                <td><input id="r5_qty" value="0.5"></td>
                <td><input id="r5_w" value="80"></td>
                <td><input id="r5_h" value="210"></td>
                <td id="r5_s">8400</td>
            </tr>
            </tbody>
        </table>

        <div class="calc-results">
            <div class="calc-results-row">
                <span>Итого см²</span>
                <span id="sum127100">127100</span>
            </div>

            <div class="calc-results-row">
                <span>Лист мет</span>
                <span id="metalSheets">4.1</span>
            </div>
        </div>
    </div>


    <div class="calc-section">
        <div class="calc-section-title">Металл и покраска</div>

        <div class="calc-grid">

            <div class="calc-field-row">
                <label>Расход краски</label>
                <input id="c70" value="0.3">
            </div>

            <div class="calc-field-row">
                <label>Цена краски за кг</label>
                <input id="c71" value="2500">
            </div>

            <div class="calc-field-row">
                <label>Толщ металла</label>
                <input id="c72" value="2">
            </div>

            <div class="calc-field-row">
                <label>Цена мет за кг</label>
                <input id="c73" value="460">
            </div>

        </div>

        <div class="calc-results">

            <div class="calc-results-row">
                <span>Расход металла, вес щита</span>
                <span id="c74">200.82 кг</span>
            </div>

            <div class="calc-results-row">
                <span>Металл себестоимость</span>
                <span id="c75">92376 тг</span>
            </div>

            <div class="calc-results-row">
                <span>Краска себестоимость</span>
                <span id="c76">12300 тг</span>
            </div>

            <div class="calc-results-row">
                <span>Монтажный набор себестоимость</span>
                <span id="c77">17852 тг</span>
            </div>

            <div class="calc-results-row">
                <span>Себестоимость материалов шкафа</span>
                <span id="c78">122528 тг</span>
            </div>

            <div class="calc-results-row">
                <span>Производственные и адм наклд расходы</span>
                <span id="c79">122528 тг</span>
            </div>

            <div class="calc-results-row">
                <span>Цена продажная ELCOS:</span>
                <span id="c80">196045 тг</span>
            </div>

        </div>

    </div>


    <!-- ================= ЛОГИСТИКА ================= -->
    <div class="calc-section">
        <div class="calc-section-title">Накладные, упаковка, логистика</div>

        <div class="calc-grid">

            <div class="calc-field-row">
                <label>Упаковка</label>
                <span id="packCost">6260 тг</span>
            </div>

            <div class="calc-field-row">
                <label>Упаковка с пенопластом (стрейч-пленка, пенопласт) м3:</label>
                <span>упаковка</span>
                <input id="packFoam_qty" value="1" type="number">
                <span>15 €</span>
                <span id="packFoam_sum">10.08 Euro</span>
            </div>

            <div class="calc-field-row">
                <label>Упаковка деревянная (стрейч-пленка, пенопласт, доски) м3:</label>
                <span>упаковка</span>
                <input id="packWood_qty" value="0" type="number">
                <span>45 €</span>
                <span id="packWood_sum">0 Euro</span>
            </div>

            <div class="calc-field-row">
                <label>г. Атырау ж/д багаж тариф за кг</label>
                <input id="railCost" value="0">
                <span>тг</span>
                <span id="railSum">0 тг</span>
            </div>

        </div>

        <div class="calc-results">
            <div class="calc-results-row">
                <span>Цена продажная с упаковкой и доставкой ELCOS:</span>
                <span id="finalPrice">202305 тг</span>
            </div>
        </div>

    </div>


    <div class="calc-results">
            <div class="calc-results-row">
                <span>Себестоимость материалов (C78)</span>
                <span id="calcC78">0</span>
            </div>

            <div class="calc-results-row">
                <span>Финальная цена (C87)</span>
                <span id="calcC87">0</span>
            </div>
        </div>
    </div>

    <button id="calcAddToCartBtn" type="button" class="btn btn-primary" style="width:100%;">
        Добавить в смету
    </button>

</section>




<div class="modal fade" id="uploadEstimateModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">Загрузить смету</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <form method="post" action="/cart/upload-structured-estimate" enctype="multipart/form-data">
                <div class="modal-body">
                    <input type="file" name="file" class="form-control" accept=".xlsx" required>

                    <small class="text-muted">
                        Загрузите файл, созданный через «Выгрузить смету (Excel)».
                    </small>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Отмена
                    </button>

                    <button class="btn btn-success">
                        Загрузить
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>


<script>
    (function(){
        // ===== Helpers =====
        function getCsrfHeaders() {
            const token = document.querySelector('meta[name="_csrf"]')?.content;
            const header = document.querySelector('meta[name="_csrf_header"]')?.content;
            const h = new Headers();
            if (token && header) h.set(header, token);
            return h;
        }
        async function api(url, opts={}) {
            const headers = new Headers(opts.headers || {});
            getCsrfHeaders().forEach((v,k)=>headers.set(k,v));
            const res = await fetch(url, { credentials:'same-origin', ...opts, headers });
            if (!res.ok) throw new Error(await res.text());
            const ct = res.headers.get('content-type')||'';
            return ct.includes('application/json') ? res.json() : res.text();
        }
        function qs(sel, root=document){ return root.querySelector(sel); }
        function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
        function fmtMoney(n){
            const v = Number(n||0);
            return v.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ===== Состояние папок =====
        const treeEl = document.getElementById('sectionTree');
        const currentFolderLabel = document.getElementById('currentFolderLabel');
        const folderProductsBox = document.getElementById('folderProducts');

        const moveSelectedBtn = document.getElementById('moveSelectedBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const bulkFolderSelect = document.getElementById('bulkFolderSelect');
        const toggleAll = document.getElementById('toggleAll');
        const searchInput = document.getElementById('searchInput');
        const cartTbody = document.getElementById('cartTbody');

        const saveForm = document.getElementById('saveEstimateForm');
        const folderMappingField = document.getElementById('folderMappingJson');

        const bulkCoeffInput = document.getElementById('bulkCoeffInput');
        const applyCoeffBtn  = document.getElementById('applyCoeffBtn');

        let selectedFolderId = 1;
        let mapping = {};          // productId -> sectionId
        let idToName = {1:'Общий'};
        let currentTree = [];      // full tree cache
        let flatSections = [];     // [{id, name, path}]
        const productIndex = {};   // productId -> {row, name}

        // Контекстное меню (для папок)
        let ctxEl = null;
        function closeCtx(){ if (ctxEl && ctxEl.parentNode){ ctxEl.parentNode.removeChild(ctxEl); } ctxEl=null; }
        function openCtxMenu(node, x, y){
            closeCtx();
            ctxEl = document.createElement('div');
            ctxEl.className = 'context-menu';

            const mkItem = (label, handler, disabled=false)=>{
                const it = document.createElement('div');
                it.className = 'item';
                it.textContent = label;
                if (disabled) it.setAttribute('disabled','true');
                it.addEventListener('click', async (e)=>{
                    e.stopPropagation();
                    closeCtx();
                    await handler();
                });
                ctxEl.appendChild(it);
                return it;
            };

            const isRoot = node.id === 1;

            mkItem('Новая подпапка…', async ()=>{
                const nm = prompt('Название новой папки:');
                if (!nm) return;
                await createSection(nm, node.id);
                await reloadTree();
                updateFolderContents();
            });

            mkItem('Переименовать папку…', async ()=>{
                const current = node.name || '';
                const nm = prompt('Новое имя папки:', current);
                if (!nm || nm === current) return;
                try {
                    await renameSection(node.id, nm);
                    await reloadTree();
                    if (selectedFolderId === node.id) currentFolderLabel.textContent = nm;
                    updateFolderContents();
                } catch(e){
                    alert('Не удалось переименовать: ' + e.message);
                }
            }, false);

            const sep = document.createElement('div'); sep.className='sep'; ctxEl.appendChild(sep);

            mkItem('Переместить папку…', async ()=>{
                await showMoveDialog(node.id);
            }, isRoot);

            mkItem('Очистить папку…', async ()=> {
                try {
                    await clearSection(node.id);
                    await reloadMapping();
                    await reloadTree();
                    updateFolderContents();
                    filterRows();
                } catch (e) {
                    alert('Не удалось очистить: ' + e.message);
                }
            }, false);

            mkItem('Удалить папку…', async ()=>{
                const ok = confirm('Удалить папку «'+node.name+'»? Товары будут перенесены в «Общий».');
                if (!ok) return;
                try {
                    await deleteSection(node.id);
                } catch(e){
                    alert('Не удалось удалить папку: ' + e.message);
                    return;
                }
                if (selectedFolderId === node.id) selectedFolderId = 1;
                await reloadMapping();
                await reloadTree();
                updateFolderContents();
                filterRows();
            }, isRoot);

            document.body.appendChild(ctxEl);

            const pad = 8;
            const vw = window.innerWidth, vh = window.innerHeight;
            requestAnimationFrame(()=>{
                const rect = ctxEl.getBoundingClientRect();
                let left = Math.min(x, vw - rect.width - pad);
                let top  = Math.min(y, vh - rect.height - pad);
                ctxEl.style.left = left + 'px';
                ctxEl.style.top  = top + 'px';
            });
        }

        function showMoveDialog(sectionId){
            return new Promise(resolve=>{
                const backdrop = document.createElement('div');
                backdrop.className = 'folder-move-backdrop';
                const box = document.createElement('div');
                box.className = 'folder-move-modal';
                box.innerHTML = '<h4>Переместить папку</h4>';
                const info = document.createElement('div');
                info.className = 'muted';
                info.style.marginBottom = '8px';
                info.textContent = 'Выберите новый родитель для папки.';
                const sel = document.createElement('select');

                const forbidden = new Set([sectionId, ...descendantsOf(sectionId)]);
                flatSections.forEach(s=>{
                    if (forbidden.has(s.id)) return;
                    const opt = document.createElement('option');
                    opt.value = String(s.id);
                    opt.textContent = s.path;
                    sel.appendChild(opt);
                });

                const actions = document.createElement('div');
                actions.className = 'actions';
                const btnCancel = document.createElement('button');
                btnCancel.className = 'btn';
                btnCancel.textContent = 'Отмена';
                const btnOk = document.createElement('button');
                btnOk.className = 'btn btn-primary';
                btnOk.textContent = 'Переместить';

                actions.appendChild(btnCancel);
                actions.appendChild(btnOk);

                box.appendChild(info);
                box.appendChild(sel);
                box.appendChild(actions);
                backdrop.appendChild(box);
                document.body.appendChild(backdrop);
                requestAnimationFrame(() => {
                    backdrop.classList.add('show');
                });


                function close(){
                    backdrop.classList.remove('show');
                    setTimeout(() => {
                        backdrop.parentNode && backdrop.parentNode.removeChild(backdrop);
                        resolve();
                    }, 180);
                }
                btnCancel.addEventListener('click', close);
                backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) close(); });
                document.addEventListener('keydown', function onEsc(ev){ if(ev.key==='Escape'){ document.removeEventListener('keydown', onEsc); close(); }});

                btnOk.addEventListener('click', async ()=>{
                    const newParentId = Number(sel.value);
                    try {
                        await moveSection(sectionId, newParentId);
                        await reloadTree();
                        updateFolderContents();
                        filterRows();
                        close();
                    } catch(e){
                        alert('Не удалось переместить: ' + e.message);
                    }
                });
            });
        }

        function indexRows(){
            qsa('tr[data-product-id]', cartTbody).forEach(tr => {
                const pid = Number(tr.dataset.productId);
                if (!pid) return;
                const nm = qs('.name', tr)?.textContent?.trim() || ('#'+pid);
                productIndex[pid] = { row: tr, name: nm };
            });
        }

        function sanitizeMapping(){
            Object.keys(mapping).forEach(k => {
                const pid = Number(k);
                if (!productIndex[pid]) delete mapping[k];
            });
        }

        function countsBySection(){
            const counts = {};
            Object.entries(mapping).forEach(([pid, sid])=>{
                if (!productIndex[Number(pid)]) return;
                const s = Number(sid) || 1;
                counts[s] = (counts[s]||0)+1;
            });
            return counts;
        }

        function flattenTree(nodes, trail=[]){
            const out = [];
            (nodes||[]).forEach(n=>{
                const path = [...trail, n.name].join(' / ');
                out.push({ id:n.id, name:n.name, path });
                if (n.children?.length){
                    out.push(...flattenTree(n.children, [...trail, n.name]));
                }
            });
            return out;
        }

        function descendantsOf(rootId){
            const res = [];
            (function walk(list){
                (list||[]).forEach(n=>{
                    if (n.id === rootId){
                        collect(n.children);
                    } else if (n.children && n.children.length){
                        walk(n.children);
                    }
                });
            })(currentTree);
            function collect(children){
                (children||[]).forEach(ch=>{
                    res.push(ch.id);
                    collect(ch.children);
                });
            }
            return res;
        }

        function renderTree(nodes){
            currentTree = nodes || [];
            const counts = countsBySection();
            idToName = {1:'Общий'};

            (function walk(ns){
                (ns||[]).forEach(n=>{
                    idToName[n.id] = n.name;
                    if (n.children?.length) walk(n.children);
                });
            })(nodes);

            flatSections = flattenTree(nodes || []);
            bulkFolderSelect.innerHTML = '';
            flatSections.forEach(s=>{
                const opt = document.createElement('option');
                opt.value = String(s.id);
                opt.textContent = s.path;
                bulkFolderSelect.appendChild(opt);
            });

            if (!flatSections.some(s => s.id === selectedFolderId)) {
                selectedFolderId = 1;
            }
            currentFolderLabel.textContent = idToName[selectedFolderId] || 'Общий';

            const ulTop = document.createElement('ul');
            (nodes || []).forEach(n => ulTop.appendChild(renderNode(n, counts)));
            treeEl.innerHTML = '';
            treeEl.appendChild(ulTop);

            fillRowFolderSelects();
        }

        function renderNode(node, counts){
            const li = document.createElement('li');
            const row = document.createElement('div');
            row.className = 'node-row';
            row.dataset.id = node.id;

            const icon = document.createElement('span');
            icon.className = 'icon';
            icon.textContent = (node.children?.length ? '📁' : '📄');

            const label = document.createElement('span');
            const cnt = counts[node.id] || 0;
            label.className = 'label';
            label.textContent = node.name + ' ('+cnt+')';

            if (node.id === selectedFolderId) {
                row.classList.add('selected');
                label.classList.add('selected');
            }

            row.addEventListener('click', () => {
                selectedFolderId = node.id;
                currentFolderLabel.textContent = node.name;

                qsa('.tree .label.selected', treeEl).forEach(el => el.classList.remove('selected'));
                qsa('.tree .node-row.selected', treeEl).forEach(el => el.classList.remove('selected'));

                label.classList.add('selected');
                row.classList.add('selected');

                filterRows();
                updateFolderContents();
            });

            row.addEventListener('dragover', ev => ev.preventDefault());
            row.addEventListener('drop', async ev => {
                ev.preventDefault();
                const productId = Number(ev.dataTransfer.getData('text/product-id'));
                if (!productId) return;
                await assignProducts(node.id, [productId]);
                await reloadMapping();
                await reloadTree();
                updateFolderContents();
                filterRows();
            });

            row.addEventListener('contextmenu', (e)=>{
                e.preventDefault();
                openCtxMenu(node, e.clientX, e.clientY);
            });

            row.appendChild(icon);
            row.appendChild(label);

            li.appendChild(row);

            if (node.children?.length) {
                const ul = document.createElement('ul');
                node.children.forEach(ch => ul.appendChild(renderNode(ch, counts)));
                li.appendChild(ul);
            }
            return li;
        }

        async function reloadTree(){
            try {
                const data = await api('/cart/sections/tree');
                renderTree(data);
            } catch (e1) {
                try {
                    const flat = await api('/cart/sections/flat');
                    const nodes = Object.entries(flat).map(([id, name]) => ({
                        id: Number(id), name, children: []
                    }));
                    renderTree([{ id: 1, name: flat['1'] || flat[1] || 'Общий', children: nodes.filter(n => n.id !== 1) }]);
                } catch (e2) {
                    const list = await api('/cart/sections');
                    const map = new Map();
                    list.forEach(it => map.set(it.id, { id: it.id, name: it.name, children: [] }));
                    const roots = [];
                    list.forEach(it => {
                        const node = map.get(it.id);
                        const p = it.parentId;
                        if (p == null) roots.push(node);
                        else (map.get(p)?.children || []).push(node);
                    });
                    renderTree(roots.length ? roots : [{ id: 1, name: 'Общий', children: [] }]);
                }
            }
        }

        async function reloadMapping(){
            mapping = await api('/cart/sections/mapping');
            sanitizeMapping();
        }

        async function createSection(name, parentId){
            const params = new URLSearchParams();
            params.set('name', name);
            if (parentId) params.set('parentId', parentId);
            await api('/cart/sections', {
                method:'POST',
                headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                body: params
            });
        }

        async function renameSection(sectionId, name){
            try{
                const params = new URLSearchParams();
                params.set('sectionId', sectionId);
                params.set('name', name);
                await api('/cart/sections/rename', {
                    method:'POST',
                    headers:{'Content-Type':'application/x-www-form-urlencoded'},
                    body: params
                });
                return;
            } catch(_){}
            const params = new URLSearchParams();
            params.set('name', name);
            await api(`/cart/sections/${sectionId}/rename`, {
                method:'POST',
                headers:{'Content-Type':'application/x-www-form-urlencoded'},
                body: params
            });
        }

        async function deleteSection(sectionId){
            try {
                await api(`/cart/sections/${sectionId}`, { method:'DELETE' });
                return;
            } catch(_) {}
            try {
                const params = new URLSearchParams();
                params.set('sectionId', sectionId);
                await api('/cart/sections/delete', {
                    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params
                });
                return;
            } catch(_) {}
            await api(`/cart/sections?sectionId=${encodeURIComponent(sectionId)}`, { method:'DELETE' });
        }

        async function moveSection(sectionId, newParentId){
            const params = new URLSearchParams();
            params.set('sectionId', sectionId);
            params.set('newParentId', newParentId);
            try {
                await api('/cart/sections/move', {
                    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params
                });
                return;
            } catch(_) {}
            await api(`/cart/sections/${sectionId}/move`, {
                method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params
            });
        }

        async function clearSection(sectionId){
            let res;
            try {
                const params = new URLSearchParams();
                params.set('sectionId', sectionId);
                res = await api('/cart/sections/clear', {
                    method:'POST',
                    headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                    body: params
                });
            } catch (_) {
                res = await api(`/cart/sections/${sectionId}/clear`, { method:'POST' });
            }

            const removed = (res && res.removed) ? res.removed : [];
            removed.forEach(pid => {
                const row = productIndex[pid]?.row;
                if (row && row.parentElement) row.parentElement.removeChild(row);
                delete productIndex[pid];
                delete mapping[pid];
            });

            sanitizeMapping();
            await reloadMapping();
            await reloadTree();

            updateFolderContents();
            recalcSummary();
            updateSelectionUI();
            filterRows();
        }

        function fillRowFolderSelects(){
            qsa('tr[data-product-id]', cartTbody).forEach(tr=>{
                const pid = Number(tr.dataset.productId);
                const currentSid = Number(mapping[pid] ?? 1);
                const sel = qs('select.row-folder', tr);
                if (!sel) return;
                sel.innerHTML = '';
                flatSections.forEach(s=>{
                    const opt = document.createElement('option');
                    opt.value = String(s.id);
                    opt.textContent = s.path;
                    if (s.id === currentSid) opt.selected = true;
                    sel.appendChild(opt);
                });
                sel.addEventListener('change', async (e)=>{
                    const sid = Number(e.target.value);
                    await assignProducts(sid, [pid]);
                    mapping[pid] = sid;
                    await reloadTree();
                    updateFolderContents();
                    filterRows();
                });
            });
        }

        async function assignProducts(sectionId, productIds){
            const params = new URLSearchParams();
            params.set('sectionId', sectionId);
            productIds.forEach(id => params.append('productIds', id));
            await api('/cart/sections/assign', {
                method:'POST',
                headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                body: params
            });
        }

        async function bulkSetCoeff(ids, coeff){
            let usedBulk = false;
            try {
                const params = new URLSearchParams();
                params.set('coefficient', coeff);
                ids.forEach(id => params.append('productIds', id));
                await api('/cart/coefficient/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });
                usedBulk = true;
            } catch (_) {}

            if (!usedBulk) {
                for (const pid of ids) {
                    const params = new URLSearchParams();
                    params.set('productId', pid);
                    params.set('coefficient', coeff);
                    await api('/cart/coefficient', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params
                    });
                }
            }

            ids.forEach(pid => {
                const row = productIndex[pid]?.row;
                const input = row && row.querySelector('input.coeff');
                if (input) {
                    input.value = coeff;
                    recalcRowSum(row);
                }
            });
            recalcSummary();
        }

        function enableDnDOnRows(){
            qsa('tr[data-product-id]', cartTbody).forEach(tr=>{
                const pid = tr.dataset.productId;
                if (!pid) return;
                tr.setAttribute('draggable','true');
                tr.addEventListener('dragstart', ev=>{
                    ev.dataTransfer.setData('text/product-id', String(pid));
                });
            });
        }

        function visibleRows(){
            return qsa('tr[data-product-id]', cartTbody).filter(tr => tr.style.display !== 'none');
        }
        function setAllVisible(checked){
            visibleRows().forEach(tr=>{
                const cb = qs('.row-check', tr);
                if (cb) cb.checked = checked;
            });
        }
        function clearSelection(){
            setAllVisible(false);
            updateSelectionUI();
        }
        function updateSelectionUI(){
            const rows = visibleRows();
            const all = rows.length > 0 && rows.every(tr => qs('.row-check', tr)?.checked);
            const some = rows.some(tr => qs('.row-check', tr)?.checked);

            toggleAll.checked = all;
            toggleAll.indeterminate = !all && some;

            if (applyCoeffBtn) {
                const someSel = rows.some(tr => qs('.row-check', tr)?.checked);
                applyCoeffBtn.disabled = !someSel;
            }
        }

        function filterRows(){
            const term = (searchInput.value || '').trim().toLowerCase();
            qsa('tr[data-product-id]', cartTbody).forEach(tr=>{
                const pid = Number(tr.dataset.productId);
                const sid = Number(mapping[pid] ?? 1);
                const inFolder = (sid === selectedFolderId);
                const name = qs('.name', tr)?.textContent?.toLowerCase() || '';
                const matches = !term || name.includes(term);
                tr.style.display = (inFolder && matches) ? '' : 'none';
            });
            updateSelectionUI();
        }

        function updateFolderContents(){
            const list = Object.entries(mapping)
                .filter(([pid, sid]) => Number(sid ?? 1) === selectedFolderId)
                .map(([pid]) => Number(pid))
                .filter(pid => !!productIndex[pid]);

            folderProductsBox.innerHTML = '<h4>Товары в папке</h4>';
            if (!list.length) {
                const empty = document.createElement('div');
                empty.className = 'empty';
                empty.textContent = 'Пока пусто';
                folderProductsBox.appendChild(empty);
                return;
            }

            const ul = document.createElement('ul');
            list.forEach(pid => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.textContent = productIndex[pid]?.name || ('Товар #'+pid);
                a.addEventListener('click', () => {
                    const row = productIndex[pid]?.row;
                    if (row && row.style.display !== 'none'){
                        row.scrollIntoView({behavior:'smooth', block:'center'});
                        row.style.outline = '2px dashed #777';
                        setTimeout(()=>row.style.outline='none', 1000);
                    }
                });
                li.appendChild(a);
                ul.appendChild(li);
            });
            folderProductsBox.appendChild(ul);
        }

        // ===== Итоги по корзине =====
        function recalcSummary() {
            const rows = qsa('tr[data-product-id]', cartTbody);

            let positions = 0;
            let totalQty = 0;
            let grand = 0;

            rows.forEach(tr => {
                const qty   = Number(qs('input.qty', tr)?.value || 0);
                const coeff = Number(qs('input.coeff', tr)?.value || 1);

                const priceEl = qs('.price', tr);
                const base = Number(priceEl?.dataset.basePrice ?? 0);
                const unit = base * coeff;

                if (qty > 0) {
                    positions += 1;
                    totalQty  += qty;
                    grand     += qty * unit;
                }
            });

            document.getElementById('positionsCount')?.replaceChildren(document.createTextNode(String(positions)));
            document.getElementById('totalQty')?.replaceChildren(document.createTextNode(String(totalQty)));
            document.getElementById('grandTotal')?.replaceChildren(document.createTextNode(fmtMoney(grand)));
        }


        function recalcRowSum(tr){
            const qty = Number(qs('input.qty', tr)?.value || 0);
            const coeff = Number(qs('input.coeff', tr)?.value || 1);

            const priceEl = qs('.price', tr);
            const base = Number(priceEl?.dataset.basePrice ?? 0);

            const unit = base * coeff;      // ✅ единичная цена с коэффициентом
            const sum  = qty * unit;        // ✅ сумма без повторного coeff

            // обновляем отображение "Цена, шт"
            if (priceEl) {
                priceEl.textContent = fmtMoney(unit);
                priceEl.dataset.unitPrice = String(unit);
            }

            const sumCell = qs('.sum', tr);
            sumCell.textContent = fmtMoney(sum);
            sumCell.dataset.value = String(sum);

            recalcSummary();
        }


        function recalcAllRows(){
            qsa('tr[data-product-id]', cartTbody).forEach(recalcRowSum);
            recalcSummary();
        }

        function getVisibleCheckedIds(){
            return visibleRows()
                .filter(tr => qs('.row-check', tr)?.checked)
                .map(tr => Number(tr.dataset.productId));
        }

        async function bulkDelete(ids){
            let okBulk = false;
            try {
                const params = new URLSearchParams();
                ids.forEach(id => params.append('productIds', id));
                await api('/cart/remove-selected', {
                    method:'POST',
                    headers:{'Content-Type':'application/x-www-form-urlencoded'},
                    body: params
                });
                okBulk = true;
            } catch(_) {}

            if (!okBulk){
                for (const pid of ids){
                    try {
                        const p = new URLSearchParams();
                        p.set('productId', pid);
                        await api('/cart/remove', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p });
                    } catch(_){
                        const p = new URLSearchParams();
                        p.set('productId', pid);
                        p.set('quantity', 0);
                        await api('/cart/update', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p });
                    }
                }
            }

            ids.forEach(pid=>{
                const row = productIndex[pid]?.row;
                if (row && row.parentElement) row.parentElement.removeChild(row);
                delete productIndex[pid];
                delete mapping[pid];
            });
            sanitizeMapping();
            await reloadTree();
            updateFolderContents();
            recalcSummary();
            updateSelectionUI();
            filterRows();
        }

        // ===== UI API корзины =====
        window.cartUI = {
            async plusMinus(btn, delta){
                const tr = btn.closest('tr');
                const input = qs('input.qty', tr);
                const next = Math.max(0, Number(input.value||0) + delta);
                input.value = next;
                await window.cartUI.updateQty(input);
            },
            async updateQty(input){
                const pid = Number(input.getAttribute('data-product-id'));
                const val = Number(input.value || 0);

                let usedSetQty = false;
                try{
                    const params = new URLSearchParams();
                    params.set('productId', pid);
                    params.set('qty', val);
                    const res = await api('/cart/set-qty', {
                        method:'POST',
                        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                        body: params
                    });
                    usedSetQty = true;

                    if (val <= 0){
                        const tr = input.closest('tr');
                        tr?.parentElement?.removeChild(tr);
                        delete productIndex[pid];
                        delete mapping[pid];
                        sanitizeMapping();
                        await reloadTree();
                        updateFolderContents();
                        recalcSummary();
                        updateSelectionUI();
                        return;
                    }

                    if (res && typeof res === 'object'){
                        const row = input.closest('tr');
                        if (row){
                            if (res.unitPrice != null){
                                const priceEl = row.querySelector('.price');
                                if (priceEl){
                                    priceEl.textContent = fmtMoney(res.unitPrice);
                                    priceEl.dataset.unitPrice = String(res.unitPrice);
                                }
                            }
                            if (res.lineSum != null){
                                const sumEl = row.querySelector('.sum');
                                if (sumEl) sumEl.textContent = fmtMoney(res.lineSum);
                            } else {
                                recalcRowSum(row);
                            }
                        }
                        if (res.totalQty != null)  document.getElementById('totalQty')?.replaceChildren(document.createTextNode(res.totalQty));
                        if (res.totalSum != null)  document.getElementById('grandTotal')?.replaceChildren(document.createTextNode(fmtMoney(res.totalSum)));
                    } else {
                        recalcRowSum(input.closest('tr'));
                    }
                    updateSelectionUI();
                    return;
                } catch(_){}

                try{
                    const params = new URLSearchParams();
                    params.set('productId', pid);
                    params.set('quantity', val);
                    await api('/cart/update', {
                        method:'POST',
                        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                        body: params
                    });
                } catch(_){}

                if (val <= 0){
                    const tr = input.closest('tr');
                    tr?.parentElement?.removeChild(tr);
                    delete productIndex[pid];
                    delete mapping[pid];
                    sanitizeMapping();
                    await reloadTree();
                    updateFolderContents();
                    recalcSummary();
                    updateSelectionUI();
                } else {
                    recalcRowSum(input.closest('tr'));
                    updateSelectionUI();
                }
            },
            async updateCoeff(input){
                const pid = Number(input.getAttribute('data-product-id'));
                const val = Number(String(input.value || 1).replace(',', '.'));
                const params = new URLSearchParams();
                params.set('productId', pid);
                params.set('coefficient', val);
                await api('/cart/coefficient', {
                    method:'POST',
                    headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                    body: params
                });
                recalcRowSum(input.closest('tr'));
            }
        };

        function wireUI(){
            indexRows();

            document.addEventListener('click', closeCtx);
            window.addEventListener('scroll', closeCtx, true);
            window.addEventListener('resize', closeCtx);
            document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeCtx(); });

            if (applyCoeffBtn) {
                applyCoeffBtn.addEventListener('click', async () => {
                    const ids = getVisibleCheckedIds();
                    if (!ids.length) return;

                    const raw = String(bulkCoeffInput.value || '1').replace(',', '.');
                    const val = Number(raw);

                    if (!Number.isFinite(val) || val < 0) {
                        alert('Введите корректный коэффициент (неотрицательное число)');
                        return;
                    }

                    await bulkSetCoeff(ids, val);
                });

                bulkCoeffInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyCoeffBtn?.click();
                    }
                });
            }

            toggleAll.addEventListener('change', ()=>{
                const checked = toggleAll.checked;
                setAllVisible(checked);
                updateSelectionUI();
            });

            cartTbody.addEventListener('change', (e)=>{
                if (e.target && e.target.classList.contains('row-check')) {
                    updateSelectionUI();
                }
            });

            searchInput.addEventListener('input', filterRows);

            moveSelectedBtn.addEventListener('click', async ()=>{
                const ids = getVisibleCheckedIds();
                if (!ids.length) return;
                const sid = Number(bulkFolderSelect.value || selectedFolderId);
                await assignProducts(sid, ids);
                ids.forEach(id => mapping[id] = sid);
                await reloadTree();
                updateFolderContents();
                clearSelection();
                filterRows();
            });

            deleteSelectedBtn.addEventListener('click', async ()=>{
                const ids = getVisibleCheckedIds();
                if (!ids.length) return;
                const ok = confirm(`Удалить выбранные позиции (${ids.length} шт.) из корзины?`);
                if (!ok) return;
                await bulkDelete(ids);
            });

            (function initFormBinding(){
                if (!saveForm) return;
                saveForm.addEventListener('submit', () => {
                    const mapToSend = {};
                    Object.keys(productIndex).forEach(k => {
                        const pid = Number(k);
                        if (!productIndex[pid]) return;
                        const sid = Number(mapping[pid] ?? 1);
                        mapToSend[pid] = sid;
                    });
                    if (folderMappingField) {
                        folderMappingField.value = JSON.stringify(mapToSend);
                    }
                });
            })();

            enableDnDOnRows();
        }

        // ===== Калькулятор «Пустое издел» (формулы 1:1 с Excel) =====

        let calcState = null;

        function num(id) {
            const el = document.getElementById(id);
            if (!el) return 0;
            const raw = (el.value ?? el.textContent ?? "")
                .toString()
                .replace(/\s/g, "")
                .replace(",", ".")
                .trim();
            const n = parseFloat(raw);
            return Number.isFinite(n) ? n : 0;
        }

        function setSpan(id, value, fd = 2, suffix = "") {
            const el = document.getElementById(id);
            if (!el) return;
            const v = Number.isFinite(value) ? value : 0;
            el.textContent =
                v.toLocaleString("ru-RU", { minimumFractionDigits: fd, maximumFractionDigits: fd }) + suffix;
        }

        function setInput(id, value, fd = null) {
            const el = document.getElementById(id);
            if (!el) return;
            const v = Number.isFinite(value) ? value : 0;
            // чтобы инпуты выглядели “как числа”, без локали:
            el.value = fd == null ? String(v) : String(Number(v.toFixed(fd)));
        }

        function lockInput(id) {
            const el = document.getElementById(id);
            if (!el) return;
            el.readOnly = true;
        }

        function recalcCalc() {
            // ===== входные (как в Excel) =====
            const C7 = num("calcC7"); // курс EUR
            const C8 = num("calcC8"); // коэф Елкос

            const B12 = num("calcB12"); // высота мм
            const C12 = num("calcC12"); // ширина мм
            const D12 = num("calcD12"); // глубина мм

            // Толщина: в Excel C72 (и E12 у вас в UI). Синхронизируем.
            let C72 = num("c72");
            if (!C72) C72 = num("calcE12");
            setInput("c72", C72);
            setInput("calcE12", C72);

            const C70 = num("c70"); // расход краски
            const C71 = num("c71"); // цена краски/кг
            const C73 = num("c73"); // цена металла/кг

            const E79 = 1;       // в файле E79 = 1
            const K_AREA = 1.55; // F67 = F66*1.55
            const SHEET_CM2 = 31250;
            const DENSITY = 7.9;
            const RAIL_K = 1.2;

            // ===== F12, G12 =====
            const volumeM3 = (B12 * C12 * D12) / 1_000_000_000; // F12
            const areaM2 =
                (((B12 * C12) + (C12 * D12) + (B12 * D12)) * 2) / 1_000_000; // G12

            setSpan("calcF12", volumeM3, 3);
            setSpan("calcG12", areaM2, 2);

            // ===== Расходники: F15..F55, F56 (EUR) =====
            let F56 = 0;

            // D15 = (B12+C12)/1000*2
            const D15 = ((B12 + C12) / 1000) * 2;
            setInput("mat15_qty", D15, 2);
            lockInput("mat15_qty");

            const E15 = num("mat15_price");
            const F15 = D15 * E15;
            setSpan("mat15_sum", F15, 2, " €");
            F56 += F15;

            for (let r = 16; r <= 55; r++) {
                const qty = num(`mat${r}_qty`);
                const price = num(`mat${r}_price`);
                const sum = qty * price;
                setSpan(`mat${r}_sum`, sum, 2, " €");
                F56 += sum;
            }
            setSpan("calcF56", F56, 2, " €");

            // ===== Панели: F61..F65, F66, F67, F68 =====
            // Excel количества C61..C65: 2,2,2,1,0.5
            const q1 = 2, q2 = 2, q3 = 2, q4 = 1, q5 = 0.5;

            // Excel размеры (см):
            // D61=C12/10, E61=B12/10
            // D62=D12/10, E62=B12/10
            // D63=D12/10, E63=C12/10
            const wFront = C12 / 10, hFront = B12 / 10;
            const wSide  = D12 / 10, hSide  = B12 / 10;
            const wTop   = D12 / 10, hTop   = C12 / 10;

            setInput("r1_qty", q1); setInput("r1_w", wFront); setInput("r1_h", hFront);
            setInput("r2_qty", q2); setInput("r2_w", wSide);  setInput("r2_h", hSide);
            setInput("r3_qty", q3); setInput("r3_w", wTop);   setInput("r3_h", hTop);
            setInput("r4_qty", q4); setInput("r4_w", wFront); setInput("r4_h", hFront);
            setInput("r5_qty", q5); setInput("r5_w", wFront); setInput("r5_h", hFront);

            [
                "r1_qty","r1_w","r1_h",
                "r2_qty","r2_w","r2_h",
                "r3_qty","r3_w","r3_h",
                "r4_qty","r4_w","r4_h",
                "r5_qty","r5_w","r5_h"
            ].forEach(lockInput);

            const F61 = q1 * wFront * hFront;
            const F62 = q2 * wSide  * hSide;
            const F63 = q3 * wTop   * hTop;
            const F64 = q4 * wFront * hFront;
            const F65 = q5 * wFront * hFront;

            const F66 = F61 + F62 + F63 + F64 + F65;
            const F67 = F66 * K_AREA;
            const F68 = F67 / SHEET_CM2;

            setSpan("r1_s", F61, 0);
            setSpan("r2_s", F62, 0);
            setSpan("r3_s", F63, 0);
            setSpan("r4_s", F64, 0);
            setSpan("r5_s", F65, 0);

            // В вашем UI sum127100 — это именно F67 (82000*1.55=127100)
            setSpan("sum127100", F67, 0);
            setSpan("metalSheets", F68, 1);

            // ===== Металл / покраска: C74..C80 =====
            const C74 = (F67 * (C72 / 10) * DENSITY) / 1000; // кг
            const C75 = C73 * C74;                           // тг
            const C76 = ((F66 / 10000) * 2) * C70 * C71;     // тг
            const C77 = F56 * C7;                            // тг
            const C78 = (C75 + C76) + C77;                   // тг
            const C79 = C78 * E79;                           // тг
            const C80 = C79 + (C78 * C8 - C78);              // тг

            setSpan("c74", C74, 2, " кг");
            setSpan("c75", C75, 0, " тг");
            setSpan("c76", C76, 0, " тг");
            setSpan("c77", C77, 0, " тг");
            setSpan("c78", C78, 0, " тг");
            setSpan("c79", C79, 0, " тг");
            setSpan("c80", C80, 0, " тг");

            // ===== Упаковка / логистика: C81, E86, C87 =====
            // Excel: E82=15, E83=45 (€/м3) — у вас текстом в UI
            const D82 = num("packFoam_qty");
            const D83 = num("packWood_qty");
            const E82 = 15;
            const E83 = 45;

            const F82 = D82 * E82 * volumeM3; // €
            const F83 = D83 * E83 * volumeM3; // €
            const C81 = (F82 + F83) * C7;     // тг

            setSpan("packFoam_sum", F82, 2, " €");
            setSpan("packWood_sum", F83, 2, " €");
            setSpan("packCost", C81, 0, " тг");

            const C86 = num("railCost");         // тг/кг
            const E86v = C74 * C86 * RAIL_K;     // тг
            setSpan("railSum", E86v, 0, " тг");

            const C87 = C80 + C81 + E86v;
            setSpan("finalPrice", C87, 0, " тг");

            // нижние выводы (если оставляете)
            setSpan("calcC78", C78, 0, " тг");
            setSpan("calcC87", C87, 0, " тг");

            // payload для виртуального товара
            calcState = {
                euroRate: C7,
                elcosK: C8,
                heightMm: B12,
                widthMm: C12,
                depthMm: D12,
                thicknessMm: C72,
                paintKgPerM2: C70,
                paintPriceTengePerKg: C71,
                metalPriceTengePerKg: C73,
                overheadK: E79,
                railTariffTengePerKg: C86,
                volumeM3,
                areaM2,
                montageEuroSum: F56,
                results: {
                    areaRawCm2: F66,
                    areaAdjCm2: F67,
                    metalSheets: F68,
                    massKg: C74,
                    metalCostTenge: C75,
                    paintCostTenge: C76,
                    montageCostTenge: C77,
                    materialsCostTenge: C78,
                    overheadCostTenge: C79,
                    priceWithoutPackingTenge: C80,
                    packingCostTenge: C81,
                    railCostTenge: E86v,
                    finalPriceTenge: C87
                }
            };
        }

        function readCalcPayload() {
            if (!calcState) recalcCalc();
            return calcState;
        }

        function initCalc() {
            const panel = document.getElementById("calcFloatingPanel");
            if (!panel) return;

            const toggle = document.getElementById("calcToggleFloating");
            const closeBt = document.getElementById("calcCloseBtn");
            const header = panel.querySelector(".calc-header");

            function setVisible(v) {
                if (!toggle) return;
                if (v) {
                    panel.classList.add("visible");
                    panel.style.right = "56px";
                    panel.style.left = "auto";
                    panel.style.top = "50%";
                    panel.style.transform = "translateY(-50%)";
                    toggle.innerHTML = "&gt;";
                } else {
                    panel.classList.remove("visible");
                    toggle.innerHTML = "&lt;";
                }
            }

            if (toggle) {
                toggle.addEventListener("click", () => {
                    setVisible(!panel.classList.contains("visible"));
                });
            }
            if (closeBt) closeBt.addEventListener("click", () => setVisible(false));

            // drag по заголовку (как у вас было)
            if (header) {
                let dragging = false, offsetX = 0, offsetY = 0;

                header.addEventListener("mousedown", (e) => {
                    if (e.target.closest("button") || e.target.closest("input")) return;
                    dragging = true;

                    const rect = panel.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;

                    panel.style.right = "auto";
                    panel.style.transform = "none";

                    function onMove(ev) {
                        if (!dragging) return;
                        const w = window.innerWidth, h = window.innerHeight;
                        let left = ev.clientX - offsetX;
                        let top = ev.clientY - offsetY;

                        const r = panel.getBoundingClientRect();
                        left = Math.max(8, Math.min(w - r.width - 8, left));
                        top = Math.max(8, Math.min(h - r.height - 8, top));

                        panel.style.left = left + "px";
                        panel.style.top = top + "px";
                    }

                    function onUp() {
                        dragging = false;
                        document.removeEventListener("mousemove", onMove);
                        document.removeEventListener("mouseup", onUp);
                    }

                    document.addEventListener("mousemove", onMove);
                    document.addEventListener("mouseup", onUp);
                    e.preventDefault();
                });
            }

            // ВАЖНО: слушаем ВСЕ инпуты калькулятора, а не только .calc-input
            panel.querySelectorAll("input").forEach((i) => {
                i.addEventListener("input", recalcCalc);
                i.addEventListener("change", recalcCalc);
            });

            // кнопка добавления
            const addBtn = document.getElementById("calcAddToCartBtn");
            if (addBtn) {
                addBtn.addEventListener("click", addVirtualProductToCart);
            }

            recalcCalc();
        }



        async function addVirtualProductToCart() {
            const btn = document.getElementById("calcAddToCartBtn");
            if (!btn) return;

            const data = readCalcPayload();

            if (data.heightMm <= 0 || data.widthMm <= 0 || data.depthMm <= 0 || data.thicknessMm <= 0) {
                alert("Проверь габариты и толщину металла: значения должны быть > 0");
                return;
            }

            // ВАЖНО: фиксируем финальную цену (C87) как целое число в тенге
            const finalTenge = Math.round(Number(data?.results?.finalPriceTenge || 0));
            data.results.finalPriceTenge = finalTenge;

            // Явно передаём цену за 1 шт для корзины (сервер должен использовать её)
            data.unitPriceTenge = finalTenge;

            btn.disabled = true;
            const oldText = btn.textContent;
            btn.textContent = "Добавляем...";

            try {
                await api("/cart/virtual/add", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(data),
                });
                location.reload();
            } catch (e) {
                alert("Не удалось добавить виртуальный товар: " + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = oldText;
            }
        }



        // ===== Инициализация =====
        (async function init(){
            indexRows();
            await reloadMapping();
            await reloadTree();
            wireUI();
            recalcAllRows();
            filterRows();
            updateFolderContents();
            updateSelectionUI();
            initCalc();
        })();

    })();
    document.addEventListener('DOMContentLoaded', () => {
    const cartTbody = document.getElementById('cartTbody');
    if (!cartTbody) return;

    const tip = document.createElement('div');
    tip.className = 'vp-tooltip';
    document.body.appendChild(tip);

    function showAtCell(cell){
    const pop = cell.querySelector('.params-popover');
    if (!pop) return;

    tip.innerHTML = pop.innerHTML;
    tip.style.display = 'block';

    const rect = cell.getBoundingClientRect();
    const pad = 8;

    // базово — снизу слева
    let left = rect.left;
    let top  = rect.bottom + pad;

    // после display можно измерить tooltip
    const r = tip.getBoundingClientRect();

    // если не влезает справа — двигаем влево
    if (left + r.width > window.innerWidth - 8) {
    left = window.innerWidth - r.width - 8;
}
    // если снизу не влезает — показываем сверху
    if (top + r.height > window.innerHeight - 8) {
    top = rect.top - r.height - pad;
}

    tip.style.left = left + 'px';
    tip.style.top  = top + 'px';
}

    function hideTip(){
    tip.style.display = 'none';
}

    cartTbody.addEventListener('mouseenter', (e) => {
    const cell = e.target.closest('.name-cell');
    if (!cell) return;
    showAtCell(cell);
}, true);

    cartTbody.addEventListener('mouseleave', (e) => {
    if (e.target.closest('.name-cell')) hideTip();
}, true);
});

</script>
</body>
</html>
