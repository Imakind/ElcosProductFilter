<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ—Ä–∑–∏–Ω–∞</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">–ö–æ—Ä–∑–∏–Ω–∞</h2>
        <div class="d-flex flex-wrap gap-2 align-items-center">
            <button type="button" class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#saveProjectModal">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</button>
            <button type="button" class="btn btn-outline-danger btn-sm" onclick="removeSelected()">üóë –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
        </div>
    </div>

    <!-- ‚¨áÔ∏è –î–æ–±–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏ Excel —Å—Ä–∞–∑—É –ø–æ–¥ –∫–Ω–æ–ø–∫–∞–º–∏ -->
    <div class="mb-3 d-flex align-items-center gap-2">
        <label for="file" class="form-label mb-0 fw-bold">üì• –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–º–µ—Ç—É:</label>
        <form action="/cart/upload-estimate" method="post" enctype="multipart/form-data" class="d-flex align-items-center gap-2">
            <input type="file" id="file" name="file" accept=".xlsx" class="form-control form-control-sm" style="max-width: 200px;" required>
            <button type="submit" class="btn btn-outline-primary btn-sm">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
        </form>
    </div>

    <div class="mb-3">
        <label for="global-coefficient" class="form-label fw-bold">–û–±—â–∏–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç:</label>
        <input type="number" step="0.1" min="0.1" id="global-coefficient"
               class="form-control text-center" style="max-width: 100px;" value="1.0"
               oninput="applyGlobalCoefficient()">
    </div>



    <div class="table-responsive">
        <table class="table table-bordered align-middle text-center">
            <thead class="table-light">
            <tr>
                <th style="width:36px;">
                    <input type="checkbox" id="select-all" onchange="toggleSelectAll(this)">
                </th>
                <th>‚Ññ</th>
                <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                <th>–ë—Ä–µ–Ω–¥</th>
                <th>–ö–æ–ª-–≤–æ</th>
                <th>–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞</th>
                <th>–°—É–º–º–∞ –±–∞–∑–æ–≤–∞—è</th>
                <th>–ö–æ—ç—Ñ.</th>
                <th>–¶–µ–Ω–∞</th>
                <th>–°—É–º–º–∞</th>
                <th>–ú–∞—Ä–∂–∞</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="product, iterStat : ${cartProducts}" th:id="'row-' + ${product.productId}">
                <td>
                    <input type="checkbox" class="select-product" th:attr="data-product-id=${product.productId}">
                </td>
                <td th:text="${iterStat.count}">1</td>
                <td th:text="${product.name}">–ù–∞–∑–≤–∞–Ω–∏–µ</td>
                <td th:text="${product.articleCode}">–ö–æ–¥</td>
                <td th:text="${product.brand.brandName}">–ë—Ä–µ–Ω–¥</td>
                <td>
                    <input type="number" min="0" class="form-control form-control-sm text-center"
                           th:id="'counter-' + ${product.productId}"
                           th:value="${quantities[product.productId]}"
                           onchange="manualQuantityChange(this)">
                </td>
                <td th:id="'base-price-' + ${product.productId}"
                    th:text="${#strings.replace(#numbers.formatDecimal(product.price, 1, 'COMMA', 1, 'POINT'), ',', ' ').replace('.', ',')}">
                </td>


                <td th:id="'base-sum-' + ${product.productId}"
                    th:text="${#strings.replace(#numbers.formatDecimal(product.price * quantities[product.productId], 1, 'COMMA', 1, 'POINT'), '.', ' ').replace('.', ',')}">0</td>
                <td>
                    <input type="number" step="0.1" class="form-control form-control-sm text-center"
                           th:id="'coefficient-' + ${product.productId}"
                           th:value="${coefficientMap[product.productId] != null ? coefficientMap[product.productId] : 1.0}"
                           oninput="coefficientInputChanged(this)">
                </td>
                <td th:id="'unit-price-' + ${product.productId}">0</td>
                <td th:id="'total-sum-' + ${product.productId}">0</td>
                <td th:id="'margin-' + ${product.productId}">0</td>
            </tr>
            </tbody>
            <tfoot>
            <tr class="fw-bold">
                <td colspan="4" class="text-end">–ò—Ç–æ–≥–æ:</td >
                <td th:id="total-qty">0</td>
                <td></td>
                <td th:id="total-base">0</td>
                <td></td>
                <td></td>
                <td th:id="total-final">0</td>
                <td th:id="total-margin">0</td>
            </tr>
            </tfoot>
        </table>
    </div>

    <div class="text-center mt-3">
        <a href="/cart/excel" class="btn btn-outline-primary">üìä –°–∫–∞—á–∞—Ç—å —Å–º–µ—Ç—É (Excel)</a>
    </div>


    <div class="d-flex justify-content-between mt-5 flex-wrap gap-2">
        <a th:href="@{/filter/results(
        brandId=${filterParams['brandId']},
        groupId=${filterParams['groupId']},
        subGroupId=${filterParams['subGroupId']},
        param1=${filterParams['param1']},
        param2=${filterParams['param2']},
        param3=${filterParams['param3']},
        param4=${filterParams['param4']},
        param5=${filterParams['param5']}
    )}" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Ñ–∏–ª—å—Ç—Ä—É</a>

        <form th:action="@{/cart/confirm}" method="post">
            <button type="submit" class="btn btn-success">‚úÖ –°–æ–∑–¥–∞—Ç—å –ö–ü</button>
        </form>
    </div>

</div>




<div class="modal fade" id="saveProjectModal" tabindex="-1" aria-labelledby="saveProjectModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form th:action="@{/cart/save-estimate}" method="post">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="saveProjectModalLabel">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–µ–∫—Ç</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="projectName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞</label>
                        <input type="text" class="form-control" id="projectName" name="projectName" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const rows = document.querySelectorAll('tr[id^="product-"]');
        recalculateAll();

        document.querySelectorAll('input[id^="coefficient-"]').forEach(input => {
            input.addEventListener('input', () => recalculateAll());
        });
    });

    function manualQuantityChange(input) {
        const productId = input.id.split('-')[1];
        const qty = parseInt(input.value);

        if (isNaN(qty) || qty <= 0) {
            fetch('/cart/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'productId=' + productId
            }).then(() => {
                input.closest('tr').remove(); // —É–¥–∞–ª–∏–º —Å—Ç—Ä–æ–∫—É –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
                recalculateAll();
            });
        } else {
            fetch('/cart/update', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'productId=' + productId + '&quantity=' + qty
            }).then(() => recalculateAll());
        }
    }


    function coefficientInputChanged(input) {
        const productId = input.id.split('-')[1];
        const value = parseFloat(input.value);
        if (!isNaN(value) && value > 0) {
            fetch('/cart/coefficient', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'productId=' + productId + '&coefficient=' + value
            }).then(() => recalculateAll());
        }
    }

    function recalculateAll() {
        let totalBase = 0;
        let totalFinal = 0;
        let totalQty = 0;

        document.querySelectorAll('input[id^="counter-"]').forEach(counterInput => {
            const productId = counterInput.id.split('-')[1];
            const qty = parseFloat(counterInput.value) || 1;
            totalQty += qty;

            const basePriceText = document.getElementById('base-price-' + productId)?.innerText || '0';
            const basePrice = parseFloat(basePriceText.replace(/\s/g, '').replace(',', '.')) || 0;

            const coeff = parseFloat(document.getElementById('coefficient-' + productId)?.value || 1);

            const baseSum = basePrice * qty;
            const unitPrice = basePrice * coeff;
            const total = unitPrice * qty;
            const margin = total - baseSum;

            document.getElementById('base-sum-' + productId).innerText = formatNumber(baseSum);
            document.getElementById('unit-price-' + productId).innerText = formatNumber(unitPrice);
            document.getElementById('total-sum-' + productId).innerText = formatNumber(total);
            document.getElementById('margin-' + productId).innerText = formatNumber(margin);

            totalBase += baseSum;
            totalFinal += total;
        });

        document.getElementById('total-base').innerText = totalBase.toFixed(1);
        document.getElementById('total-final').innerText = totalFinal.toFixed(1);
        document.getElementById('total-margin').innerText = (totalFinal - totalBase).toFixed(1);
        document.getElementById('total-qty').innerText = totalQty;
    }


    function formatNumber(value) {
        return value.toLocaleString('ru-RU', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
    }

    function clearCart() {
        fetch('/cart/clear', { method: 'POST' })
            .then(() => {
                location.reload(); // –æ–±–Ω–æ–≤–∏–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
            });
    }

    function applyGlobalCoefficient() {
        const globalCoeff = parseFloat(document.getElementById('global-coefficient').value);
        if (isNaN(globalCoeff) || globalCoeff <= 0) return;

        document.querySelectorAll('input[id^="coefficient-"]').forEach(input => {
            const productId = input.id.split('-')[1];
            input.value = globalCoeff;

            fetch('/cart/coefficient', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'productId=' + productId + '&coefficient=' + globalCoeff
            });
        });

        recalculateAll();
    }

    function toggleSelectAll(master) {
        document.querySelectorAll('.select-product').forEach(cb => cb.checked = master.checked);
    }

    function getSelectedIds() {
        return Array.from(document.querySelectorAll('.select-product:checked'))
            .map(cb => parseInt(cb.dataset.productId));
    }

    function removeSelected() {
        const ids = getSelectedIds();
        if (ids.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å.');
            return;
        }

        const body = new URLSearchParams();
        ids.forEach(id => body.append('productIds', id));

        fetch('/cart/remove-selected', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: body.toString()
        }).then(() => {
            // —É–±–∏—Ä–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
            ids.forEach(id => {
                const row = document.getElementById('row-' + id);
                if (row) row.remove();
            });
            // –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –∏—Ç–æ–≥–∏
            recalculateAll();

            // —Å–Ω—è—Ç—å –æ–±—â–∏–π —á–µ–∫–±–æ–∫—Å
            const master = document.getElementById('select-all');
            if (master) master.checked = false;
        }).catch(err => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö:', err);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏');
        });
    }
</script>
</body>
</html>
