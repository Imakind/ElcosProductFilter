<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>–ö–æ—Ä–∑–∏–Ω–∞</title>

    <!-- –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–∞–∂–µ –ø—Ä–∏ –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–º CSRF -->
    <meta name="_csrf" th:content="${_csrf != null ? _csrf.token : ''}"/>
    <meta name="_csrf_header" th:content="${_csrf != null ? _csrf.headerName : ''}"/>

    <style>
        :root { --gap:16px; }
        body { margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:#0f0f0f; color:#eaeaea; }
        a, button, input, select { color:inherit; }
        .page { padding: 20px; max-width: 1280px; margin: 0 auto; }
        h1 { margin: 0 0 16px; font-size: 22px; }

        .cart-layout { display: grid; grid-template-columns: clamp(380px, 30vw, 520px) 1fr; gap: var(--gap); align-items: start; }
        .panel { border: 1px solid #2a2a2a; border-radius: 12px; padding: 12px; background:#151515; }
        .panel h3 { margin: 0 0 8px; font-size: 16px; display:flex; align-items:center; gap:8px; }

        .hint { font-size:12px; opacity:.75; }
        .muted { opacity:.85; }

        .tree { max-height: calc(100vh - 320px); overflow: auto; padding-right: 4px; }
        .tree ul { list-style: none; padding-left: 16px; margin: 6px 0; }
        .tree li { margin: 2px 0; }
        .node-row { display: flex; align-items: center; gap: 10px; padding: 8px 10px; border-radius: 8px; cursor: pointer; }
        .node-row:hover { background:#1e2833; }
        .node-row .icon { width: 22px; text-align: center; opacity:.8; }
        .node-row .label {
            flex: 1;
            min-width: 0;
            line-height: 1.3;
            white-space: normal;
            word-break: break-word;
        }
        .node-row .label.selected { text-decoration: none; font-weight: 600; }
        .node-row.selected {
            background:#253244;
            outline: 1px solid #334;
        }

        .folder-products { margin-top:10px; border-top:1px solid #2a2a2a; padding-top:8px; }
        .folder-products h4 { font-size:13px; margin:0 0 6px; opacity:.85;}
        .folder-products ul { list-style:none; padding:0; margin:0; max-height:200px; overflow:auto;}
        .folder-products li { font-size:12px; padding:3px 0; opacity:.92; }
        .folder-products li a { text-decoration:none; border-bottom:1px dashed #444; cursor:pointer; }
        .folder-products .empty { opacity:.6; font-size:12px; }

        .btn { border:1px solid #2a2a2a; background:#202020; border-radius:10px; padding:6px 10px; cursor:pointer; text-decoration:none; display:inline-block; }
        .btn:hover { background:#262626; }
        .btn-primary { border-color:#345; background:#1c2430; }
        .btn-primary:hover { background:#222c3a; }
        .btn-danger { border-color:#553; background:#2a1a1a; }
        .btn-danger:hover { background:#311; }

        .summary { display:flex; gap:16px; align-items:center; margin:8px 0 16px; font-size:14px; opacity:.95; flex-wrap:wrap; }
        .summary .pill { border:1px solid #2a2a2a; border-radius:999px; padding:6px 10px; background:#161616; }
        .toolbar { display:flex; gap:8px; flex-wrap:wrap; margin-left:auto }

        .save-form { display:flex; gap:8px; align-items:center; }
        .save-form input { background:#1a1a1a; border:1px solid #2a2a2a; border-radius:8px; padding:6px 10px; }

        .subtoolbar { display:flex; gap:8px; margin:10px 0; flex-wrap:wrap; align-items:center; }
        input[type="text"], input[type="number"], select { background:#1a1a1a; border:1px solid #2a2a2a; border-radius:8px; padding:6px 8px; color:#eaeaea; }

        table.list { width:100%; border-collapse: collapse; }
        table.list th, table.list td { padding:6px 8px; border-bottom:1px solid #212121; vertical-align: middle; }
        table.list th { text-align:left; font-weight:600; opacity:.9; position:sticky; top:0; background:#151515; z-index:1; }
        table.list tr:hover { background:#1a1a1a; }
        tr[data-draggable="true"] { cursor: grab; }
        tr[data-draggable="true"]:active { cursor: grabbing; }
        .price, .sum { white-space:nowrap; text-align:right; }
        .qty, .coeff { width:92px; }
        .folder-select { min-width: clamp(220px, 26vw, 360px); padding: 8px 10px; height: 36px; }
        table.list th:nth-child(5),
        table.list td:nth-child(5) { width: clamp(220px, 26vw, 360px); }

        .cluster { display:flex; align-items:center; gap:8px; flex-wrap:nowrap; white-space:nowrap; }

        @media (max-width: 1200px){
            .subtoolbar .folder-select { min-width: 200px; }
        }
        @media (max-width: 980px){
            .subtoolbar .folder-select { min-width: 160px; }
        }

        /* –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é */
        .context-menu {
            position: fixed;
            z-index: 9999;
            min-width: 200px;
            background:#1b1b1b;
            border:1px solid #2a2a2a;
            border-radius:10px;
            padding:6px;
            box-shadow: 0 8px 24px rgba(0,0,0,.4);
        }
        .context-menu .item {
            padding:8px 10px;
            border-radius:8px;
            cursor:pointer;
            user-select:none;
            font-size:14px;
        }
        .context-menu .item:hover { background:#262626; }
        .context-menu .item[disabled] { opacity:.5; pointer-events:none; }
        .context-menu .sep { height:1px; background:#2a2a2a; margin:6px 0; }

        /* –ú–æ–¥–∞–ª–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –ø–∞–ø–∫–∏ */
        .modal-backdrop {
            position: fixed; inset:0; z-index:9998;
            background: rgba(0,0,0,.5);
            display:flex; align-items:center; justify-content:center;
        }
        .modal {
            background:#161616; border:1px solid #2a2a2a; border-radius:12px;
            padding:12px; min-width:320px; max-width:90vw; color:#eaeaea;
            box-shadow: 0 16px 40px rgba(0,0,0,.5);
        }
        .modal h4 { margin:0 0 8px; font-size:16px; }
        .modal .actions { display:flex; gap:8px; justify-content:flex-end; margin-top:10px; }
        .modal select { width:100%; background:#1a1a1a; border:1px solid #2a2a2a; border-radius:8px; padding:6px 8px; color:#eaeaea; }
        .modal .btn { border-radius:8px; }

        #currentFolderLabel {
            font-weight: 700;
            padding: 2px 6px;
            background:#202a36;
            border:1px solid #2a2a2a;
            border-radius: 6px;
        }

        /* === –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä: –ø–ª–∞–≤–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å —Å–ø—Ä–∞–≤–∞ + –∫–Ω–æ–ø–∫–∞-—Å—Ç—Ä–µ–ª–∫–∞ === */

        .calc-toggle-floating {
            position: fixed;
            top: 50%;
            right: 0;
            transform: translateY(-50%);
            border-radius: 12px 0 0 12px;
            border: 1px solid #2a2a2a;
            border-right: none;
            background:#202020;
            width: 32px;
            height: 64px;
            display:flex;
            align-items:center;
            justify-content:center;
            cursor:pointer;
            z-index: 10001;
            font-size:18px;
            padding:0;
        }
        .calc-toggle-floating:hover { background:#262626; }

        .calc-panel-floating {
            position: fixed;
            top: 50%;
            right: 56px;
            transform: translateY(-50%);
            width: 340px;
            max-height: 80vh;
            overflow:auto;
            z-index: 10000;
            display:none;
        }
        .calc-panel-floating.visible {
            display:block;
        }

        .calc-header {
            display:flex;
            align-items:center;
            justify-content:space-between;
            margin:0 0 6px;
            cursor:move;
            gap:8px;
        }
        .calc-header-title { font-size:15px; font-weight:600; }
        .calc-header .btn {
            padding:2px 6px;
            border-radius:6px;
            font-size:12px;
        }

        .calc-table {
            width:100%;
            border-collapse:collapse;
            font-size:13px;
        }
        .calc-table td {
            padding:3px 4px;
            border-bottom:1px solid #202020;
        }
        .calc-table .section-row td {
            padding-top:6px;
            font-weight:600;
            background:#191919;
        }
        .calc-table input[type="number"]{
            width:100%;
            box-sizing:border-box;
            padding:4px 6px;
            font-size:13px;
        }
        .calc-table .result-row td {
            background:#152016;
            font-weight:600;
        }
        .calc-table .result-row strong {
            font-size:13px;
        }
        .calc-result {
            text-align:right;
            white-space:nowrap;
        }
    </style>
</head>
<body>
<div class="page">

    <h1>–ö–æ—Ä–∑–∏–Ω–∞</h1>

    <div class="summary">
        <div class="pill">–ü–æ–∑–∏—Ü–∏–π: <span id="positionsCount" th:text="${#lists.size(cartProducts)}">0</span></div>
        <div class="pill">–ö–æ–ª-–≤–æ –≤—Å–µ–≥–æ: <span id="totalQty" th:text="${totalQuantity}">0</span></div>
        <div class="pill">–°—É–º–º–∞: <span id="grandTotal" th:text="${#numbers.formatDecimal(totalSum,1,2,'COMMA')}">0,00</span></div>

        <div class="toolbar">
            <a class="btn" href="/cart">–û–±–Ω–æ–≤–∏—Ç—å</a>
            <a class="btn" href="/">–ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
            <a class="btn" href="/cart/excel">–í—ã–≥—Ä—É–∑–∏—Ç—å —Å–º–µ—Ç—É (Excel)</a>
            <form method="post" action="/cart/confirm" style="display:inline;">
                <button class="btn btn-primary">–û—Ñ–æ—Ä–º–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>
            </form>
        </div>
    </div>

    <div class="panel" style="margin-bottom:16px">
        <form class="save-form" id="saveEstimateForm" method="post" action="/cart/save-estimate">
            <span class="muted">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–º–µ—Ç—É –≤ –∏—Å—Ç–æ—Ä–∏—é:</span>
            <input name="projectName" type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞" required />
            <input type="hidden" name="folderMappingJson" id="folderMappingJson" />
            <button class="btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </form>
        <div class="hint" style="margin-top:6px">–°–º–µ—Ç–∞ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è —Å —Ç–µ–∫—É—â–∏–º —Å–æ—Å—Ç–∞–≤–æ–º –∫–æ—Ä–∑–∏–Ω—ã, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞–º–∏, —Ü–µ–Ω–∞–º–∏ –∏ –ø–∞–ø–∫–∞–º–∏.</div>
    </div>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫: –¥–µ—Ä–µ–≤–æ –ø–∞–ø–æ–∫ + —Ç–∞–±–ª–∏—Ü–∞ -->
    <div class="cart-layout">
        <aside class="panel">
            <h3>–ü–∞–ø–∫–∏ <span class="hint">–ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ —Å—Ç—Ä–æ–∫–∏ —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –Ω—É–∂–Ω—É—é –ø–∞–ø–∫—É. –ü–ö–ú –ø–æ –ø–∞–ø–∫–µ ‚Äî –º–µ–Ω—é</span></h3>

            <div class="tree" id="sectionTree"></div>

            <div style="margin-top:10px; font-size:12px; opacity:.8">
                –í—ã–±—Ä–∞–Ω–∞ –ø–∞–ø–∫–∞: <span id="currentFolderLabel">–û–±—â–∏–π</span>
            </div>

            <div id="folderProducts" class="folder-products">
                <h4>–¢–æ–≤–∞—Ä—ã –≤ –ø–∞–ø–∫–µ</h4>
                <div class="empty">–ü–æ–∫–∞ –ø—É—Å—Ç–æ</div>
            </div>
        </aside>

        <main class="panel">
            <div class="subtoolbar">
                <span class="muted">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ ‚Üí</span>
                <select id="bulkFolderSelect" class="folder-select"></select>
                <button type="button" class="btn" id="moveSelectedBtn">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏</button>

                <button type="button" class="btn btn-danger" id="deleteSelectedBtn">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>

                <div class="cluster">
                    <span class="muted">–ö–æ—ç—Ñ—Ñ. –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö:</span>
                    <input type="number" step="0.01" min="0" id="bulkCoeffInput" value="1.00" style="width:110px" />
                    <button type="button" class="btn" id="applyCoeffBtn" disabled>–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                </div>

                <span class="muted">–§–∏–ª—å—Ç—Ä –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é:</span>
                <input type="text" id="searchInput" placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥..." />
            </div>

            <div style="overflow:auto; max-height:70vh;">
                <table class="list" id="cartTable">
                    <thead>
                    <tr>
                        <th style="width:36px;"><input type="checkbox" id="toggleAll" title="–í—ã–¥–µ–ª–∏—Ç—å –≤—Å–µ –≤–∏–¥–∏–º—ã–µ"></th>
                        <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
                        <th>–ë—Ä–µ–Ω–¥</th>
                        <th>–ê—Ä—Ç–∏–∫—É–ª</th>
                        <th>–ü–∞–ø–∫–∞</th>
                        <th style="width:110px;">–ö–æ–ª-–≤–æ</th>
                        <th style="width:120px;">–ö–æ—ç—Ñ—Ñ.</th>
                        <th class="price">–¶–µ–Ω–∞, —à—Ç</th>
                        <th class="sum">–°—É–º–º–∞</th>
                    </tr>
                    </thead>
                    <tbody id="cartTbody">
                    <tr th:each="p : ${cartProducts}"
                        th:attr="data-product-id=${p.productId}"
                        data-draggable="true">
                        <td><input type="checkbox" class="row-check"></td>

                        <td class="name" th:text="${p.name}">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</td>
                        <td th:text="${p.brand != null ? p.brand.brandName : '‚Äî'}">Brand</td>
                        <td th:text="${p.articleCode}">code</td>

                        <td>
                            <select class="folder-select row-folder"></select>
                        </td>

                        <td>
                            <div style="display:flex; gap:6px; align-items:center;">
                                <button type="button" class="btn" onclick="cartUI.plusMinus(this,-1)">‚àí</button>
                                <input class="qty" type="number" min="0"
                                       th:value="${quantities[p.productId]}"
                                       oninput="cartUI.updateQty(this)"
                                       th:attr="data-product-id=${p.productId}">
                                <button type="button" class="btn" onclick="cartUI.plusMinus(this,1)">+</button>
                            </div>
                        </td>

                        <td>
                            <input class="coeff" type="number" step="0.01" min="0"
                                   th:value="${(coefficientMap != null and coefficientMap.containsKey(p.productId)) ? coefficientMap[p.productId] : 1.0}"
                                   oninput="cartUI.updateCoeff(this)"
                                   th:attr="data-product-id=${p.productId}">
                        </td>

                        <td class="price"
                            th:with="
        pidRaw=${p.productId},
        pidS=${#strings.concat('', pidRaw)},
        up0=${unitPriceMap != null and unitPriceMap.containsKey(pidRaw) ? unitPriceMap[pidRaw] : null},
        up1=${up0 != null ? up0 : (unitPriceMap != null and unitPriceMap.containsKey(pidS) ? unitPriceMap[pidS] : null)},
        up2=${up1 != null ? up1 : (unitPriceMap != null and unitPriceMap.containsKey(T(java.lang.Long).valueOf(pidS)) ? unitPriceMap[T(java.lang.Long).valueOf(pidS)] : null)},
        up3=${up2 != null ? up2 : (unitPriceMap != null and unitPriceMap.containsKey(T(java.lang.Integer).valueOf(pidS)) ? unitPriceMap[T(java.lang.Integer).valueOf(pidS)] : null)},
        up=${up3 != null ? up3 : 0}
    "
                            th:attr="data-unit-price=${up}"
                            th:text="${#numbers.formatDecimal(up, 1, 2, 'COMMA')}">
                            0,00
                        </td>

                        <td class="sum">0,00</td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞-—Å—Ç—Ä–µ–ª–∫–∞ —Å–ø—Ä–∞–≤–∞ -->
<button id="calcToggleFloating" class="calc-toggle-floating" type="button" title="–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä">
    &lt;
</button>

<!-- –ü–ª–∞–≤–∞—é—â–∞—è –ø–∞–Ω–µ–ª—å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ -->
<section id="calcFloatingPanel" class="panel calc-panel-floating">
    <div class="calc-header">
        <span class="calc-header-title">–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏</span>
        <button id="calcCloseBtn" type="button" class="btn">‚úï</button>
    </div>
    <div class="hint" style="margin-bottom:6px;">
        –§–æ—Ä–º—É–ª—ã –∫–∞–∫ –≤ Excel: –ø–ª–æ—â–∞–¥—å –º–µ—Ç–∞–ª–ª–∞, –º–∞—Å—Å–∞ –∏–∑–¥–µ–ª–∏—è –∏ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å. –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π—Ç–µ –ø–∞–Ω–µ–ª—å –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫.
    </div>

    <table class="calc-table">
        <tbody>
        <tr class="section-row"><td colspan="2">–û–±—â–∏–µ</td></tr>
        <tr>
            <td>–ö—É—Ä—Å –µ–≤—Ä–æ</td>
            <td><input id="calcC2" class="calc-input" type="number" step="0.01" value="500"></td>
        </tr>

        <tr class="section-row"><td colspan="2">–ì–∞–±–∞—Ä–∏—Ç—ã (–º–º)</td></tr>
        <tr>
            <td>–í—ã—Å–æ—Ç–∞ (–º–º)</td>
            <td><input id="calcC4" class="calc-input" type="number" step="1" value="1000"></td>
        </tr>
        <tr>
            <td>–®–∏—Ä–∏–Ω–∞ (–º–º)</td>
            <td><input id="calcC5" class="calc-input" type="number" step="1" value="1000"></td>
        </tr>
        <tr>
            <td>–ì–ª—É–±–∏–Ω–∞ (–º–º)</td>
            <td><input id="calcC6" class="calc-input" type="number" step="1" value="500"></td>
        </tr>
        <tr>
            <td>–¢–æ–ª—â–∏–Ω–∞ –º–µ—Ç–∞–ª–ª–∞ (–º–º)</td>
            <td><input id="calcC7" class="calc-input" type="number" step="0.1" value="1"></td>
        </tr>

        <tr class="section-row"><td colspan="2">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã (–∫–æ–ª-–≤–æ —á–∞—Å—Ç–µ–π)</td></tr>
        <tr>
            <td>–ü–µ—Ä–µ–¥–Ω—è—è/–∑–∞–¥–Ω—è—è —Å—Ç–µ–Ω–∫–∏ (—à—Ç.)</td>
            <td><input id="calcC9" class="calc-input" type="number" step="0.1" value="2"></td>
        </tr>
        <tr>
            <td>–ë–æ–∫–æ–≤—ã–µ —Å—Ç–µ–Ω–∫–∏ (—à—Ç.)</td>
            <td><input id="calcC10" class="calc-input" type="number" step="0.1" value="2"></td>
        </tr>
        <tr>
            <td>–í–µ—Ä—Ö/–Ω–∏–∂–Ω. —Å—Ç–µ–Ω–∫–∏ (—à—Ç.)</td>
            <td><input id="calcC11" class="calc-input" type="number" step="0.1" value="2"></td>
        </tr>
        <tr>
            <td>–§–∞–ª—å—à-–ø–∞–Ω–µ–ª—å (—à—Ç.)</td>
            <td><input id="calcC12" class="calc-input" type="number" step="0.1" value="1"></td>
        </tr>
        <tr>
            <td>–í–Ω—É—Ç—Ä–µ–Ω–Ω–æ—Å—Ç–∏ (—à—Ç.)</td>
            <td><input id="calcC13" class="calc-input" type="number" step="0.1" value="0.5"></td>
        </tr>

        <tr class="section-row"><td colspan="2">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã</td></tr>
        <tr>
            <td>–†–∞—Å—Ö–æ–¥ –∫—Ä–∞—Å–∫–∏ (–∫–≥/–∫–≤.–º)</td>
            <td><input id="calcC15" class="calc-input" type="number" step="0.01" value="0.3"></td>
        </tr>
        <tr>
            <td>–¶–µ–Ω–∞ –∫—Ä–∞—Å–∫–∏ (—Ç–≥/–∫–≥)</td>
            <td><input id="calcC16" class="calc-input" type="number" step="1" value="2500"></td>
        </tr>
        <tr>
            <td>–¶–µ–Ω–∞ –º–µ—Ç–∞–ª–ª–∞ (—Ç–≥/–∫–≥)</td>
            <td><input id="calcC17" class="calc-input" type="number" step="1" value="475"></td>
        </tr>
        <tr>
            <td>–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏</td>
            <td><input id="calcC18" class="calc-input" type="number" step="0.01" value="1"></td>
        </tr>

        <tr class="section-row"><td colspan="2">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</td></tr>
        <tr class="result-row">
            <td>–ü–ª–æ—â–∞–¥—å –º–µ—Ç–∞–ª–ª–∞ (–∫–≤.–º.)</td>
            <td class="calc-result"><strong id="calcC20">0,00</strong></td>
        </tr>
        <tr class="result-row">
            <td>–ú–∞—Å—Å–∞ –∏–∑–¥–µ–ª–∏—è (–∫–≥)</td>
            <td class="calc-result"><strong id="calcC21">0,00</strong></td>
        </tr>
        <tr class="result-row">
            <td>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (—Ç–≥)</td>
            <td class="calc-result"><strong id="calcC22">0</strong></td>
        </tr>
        <tr class="result-row">
            <td>–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–µ–≤—Ä–æ)</td>
            <td class="calc-result"><strong id="calcC23">0,00</strong></td>
        </tr>

        <!-- –Ω–æ–≤–æ–µ -->
        <tr>
            <td colspan="2" style="padding-top:8px;">
                <button id="calcAddToCartBtn" type="button" class="btn btn-primary" style="width:100%;">
                    –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–º–µ—Ç—É
                </button>
            </td>
        </tr>
        </tbody>
    </table>
</section>

<script>
    (function(){
        // ===== Helpers =====
        function getCsrfHeaders() {
            const token = document.querySelector('meta[name="_csrf"]')?.content;
            const header = document.querySelector('meta[name="_csrf_header"]')?.content;
            const h = new Headers();
            if (token && header) h.set(header, token);
            return h;
        }
        async function api(url, opts={}) {
            const headers = new Headers(opts.headers || {});
            getCsrfHeaders().forEach((v,k)=>headers.set(k,v));
            const res = await fetch(url, { credentials:'same-origin', ...opts, headers });
            if (!res.ok) throw new Error(await res.text());
            const ct = res.headers.get('content-type')||'';
            return ct.includes('application/json') ? res.json() : res.text();
        }
        function qs(sel, root=document){ return root.querySelector(sel); }
        function qsa(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
        function fmtMoney(n){
            const v = Number(n||0);
            return v.toLocaleString('ru-RU', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // ===== –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø–∞–ø–æ–∫ =====
        const treeEl = document.getElementById('sectionTree');
        const currentFolderLabel = document.getElementById('currentFolderLabel');
        const folderProductsBox = document.getElementById('folderProducts');

        const moveSelectedBtn = document.getElementById('moveSelectedBtn');
        const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const bulkFolderSelect = document.getElementById('bulkFolderSelect');
        const toggleAll = document.getElementById('toggleAll');
        const searchInput = document.getElementById('searchInput');
        const cartTbody = document.getElementById('cartTbody');

        const saveForm = document.getElementById('saveEstimateForm');
        const folderMappingField = document.getElementById('folderMappingJson');

        const bulkCoeffInput = document.getElementById('bulkCoeffInput');
        const applyCoeffBtn  = document.getElementById('applyCoeffBtn');

        let selectedFolderId = 1;
        let mapping = {};          // productId -> sectionId
        let idToName = {1:'–û–±—â–∏–π'};
        let currentTree = [];      // full tree cache
        let flatSections = [];     // [{id, name, path}]
        const productIndex = {};   // productId -> {row, name}

        // –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é (–¥–ª—è –ø–∞–ø–æ–∫)
        let ctxEl = null;
        function closeCtx(){ if (ctxEl && ctxEl.parentNode){ ctxEl.parentNode.removeChild(ctxEl); } ctxEl=null; }
        function openCtxMenu(node, x, y){
            closeCtx();
            ctxEl = document.createElement('div');
            ctxEl.className = 'context-menu';

            const mkItem = (label, handler, disabled=false)=>{
                const it = document.createElement('div');
                it.className = 'item';
                it.textContent = label;
                if (disabled) it.setAttribute('disabled','true');
                it.addEventListener('click', async (e)=>{
                    e.stopPropagation();
                    closeCtx();
                    await handler();
                });
                ctxEl.appendChild(it);
                return it;
            };

            const isRoot = node.id === 1;

            mkItem('–ù–æ–≤–∞—è –ø–æ–¥–ø–∞–ø–∫–∞‚Ä¶', async ()=>{
                const nm = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏:');
                if (!nm) return;
                await createSection(nm, node.id);
                await reloadTree();
                updateFolderContents();
            });

            mkItem('–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–∞–ø–∫—É‚Ä¶', async ()=>{
                const current = node.name || '';
                const nm = prompt('–ù–æ–≤–æ–µ –∏–º—è –ø–∞–ø–∫–∏:', current);
                if (!nm || nm === current) return;
                try {
                    await renameSection(node.id, nm);
                    await reloadTree();
                    if (selectedFolderId === node.id) currentFolderLabel.textContent = nm;
                    updateFolderContents();
                } catch(e){
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å: ' + e.message);
                }
            }, false);

            const sep = document.createElement('div'); sep.className='sep'; ctxEl.appendChild(sep);

            mkItem('–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø–∞–ø–∫—É‚Ä¶', async ()=>{
                await showMoveDialog(node.id);
            }, isRoot);

            mkItem('–û—á–∏—Å—Ç–∏—Ç—å –ø–∞–ø–∫—É‚Ä¶', async ()=> {
                try {
                    await clearSection(node.id);
                    await reloadMapping();
                    await reloadTree();
                    updateFolderContents();
                    filterRows();
                } catch (e) {
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å: ' + e.message);
                }
            }, false);

            mkItem('–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É‚Ä¶', async ()=>{
                const ok = confirm('–£–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É ¬´'+node.name+'¬ª? –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã –≤ ¬´–û–±—â–∏–π¬ª.');
                if (!ok) return;
                try {
                    await deleteSection(node.id);
                } catch(e){
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–∞–ø–∫—É: ' + e.message);
                    return;
                }
                if (selectedFolderId === node.id) selectedFolderId = 1;
                await reloadMapping();
                await reloadTree();
                updateFolderContents();
                filterRows();
            }, isRoot);

            document.body.appendChild(ctxEl);

            const pad = 8;
            const vw = window.innerWidth, vh = window.innerHeight;
            requestAnimationFrame(()=>{
                const rect = ctxEl.getBoundingClientRect();
                let left = Math.min(x, vw - rect.width - pad);
                let top  = Math.min(y, vh - rect.height - pad);
                ctxEl.style.left = left + 'px';
                ctxEl.style.top  = top + 'px';
            });
        }

        function showMoveDialog(sectionId){
            return new Promise(resolve=>{
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop';
                const box = document.createElement('div');
                box.className = 'modal';
                box.innerHTML = '<h4>–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø–∞–ø–∫—É</h4>';
                const info = document.createElement('div');
                info.className = 'muted';
                info.style.marginBottom = '8px';
                info.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π —Ä–æ–¥–∏—Ç–µ–ª—å –¥–ª—è –ø–∞–ø–∫–∏.';
                const sel = document.createElement('select');

                const forbidden = new Set([sectionId, ...descendantsOf(sectionId)]);
                flatSections.forEach(s=>{
                    if (forbidden.has(s.id)) return;
                    const opt = document.createElement('option');
                    opt.value = String(s.id);
                    opt.textContent = s.path;
                    sel.appendChild(opt);
                });

                const actions = document.createElement('div');
                actions.className = 'actions';
                const btnCancel = document.createElement('button');
                btnCancel.className = 'btn';
                btnCancel.textContent = '–û—Ç–º–µ–Ω–∞';
                const btnOk = document.createElement('button');
                btnOk.className = 'btn btn-primary';
                btnOk.textContent = '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å';

                actions.appendChild(btnCancel);
                actions.appendChild(btnOk);

                box.appendChild(info);
                box.appendChild(sel);
                box.appendChild(actions);
                backdrop.appendChild(box);
                document.body.appendChild(backdrop);

                function close(){ backdrop.parentNode && backdrop.parentNode.removeChild(backdrop); resolve(); }
                btnCancel.addEventListener('click', close);
                backdrop.addEventListener('click', (e)=>{ if(e.target===backdrop) close(); });
                document.addEventListener('keydown', function onEsc(ev){ if(ev.key==='Escape'){ document.removeEventListener('keydown', onEsc); close(); }});

                btnOk.addEventListener('click', async ()=>{
                    const newParentId = Number(sel.value);
                    try {
                        await moveSection(sectionId, newParentId);
                        await reloadTree();
                        updateFolderContents();
                        filterRows();
                        close();
                    } catch(e){
                        alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å: ' + e.message);
                    }
                });
            });
        }

        function indexRows(){
            qsa('tr[data-product-id]', cartTbody).forEach(tr => {
                const pid = Number(tr.dataset.productId);
                if (!pid) return;
                const nm = qs('.name', tr)?.textContent?.trim() || ('#'+pid);
                productIndex[pid] = { row: tr, name: nm };
            });
        }

        function sanitizeMapping(){
            Object.keys(mapping).forEach(k => {
                const pid = Number(k);
                if (!productIndex[pid]) delete mapping[k];
            });
        }

        function countsBySection(){
            const counts = {};
            Object.entries(mapping).forEach(([pid, sid])=>{
                if (!productIndex[Number(pid)]) return;
                const s = Number(sid) || 1;
                counts[s] = (counts[s]||0)+1;
            });
            return counts;
        }

        function flattenTree(nodes, trail=[]){
            const out = [];
            (nodes||[]).forEach(n=>{
                const path = [...trail, n.name].join(' / ');
                out.push({ id:n.id, name:n.name, path });
                if (n.children?.length){
                    out.push(...flattenTree(n.children, [...trail, n.name]));
                }
            });
            return out;
        }

        function descendantsOf(rootId){
            const res = [];
            (function walk(list){
                (list||[]).forEach(n=>{
                    if (n.id === rootId){
                        collect(n.children);
                    } else if (n.children && n.children.length){
                        walk(n.children);
                    }
                });
            })(currentTree);
            function collect(children){
                (children||[]).forEach(ch=>{
                    res.push(ch.id);
                    collect(ch.children);
                });
            }
            return res;
        }

        function renderTree(nodes){
            currentTree = nodes || [];
            const counts = countsBySection();
            idToName = {1:'–û–±—â–∏–π'};

            (function walk(ns){
                (ns||[]).forEach(n=>{
                    idToName[n.id] = n.name;
                    if (n.children?.length) walk(n.children);
                });
            })(nodes);

            flatSections = flattenTree(nodes || []);
            bulkFolderSelect.innerHTML = '';
            flatSections.forEach(s=>{
                const opt = document.createElement('option');
                opt.value = String(s.id);
                opt.textContent = s.path;
                bulkFolderSelect.appendChild(opt);
            });

            if (!flatSections.some(s => s.id === selectedFolderId)) {
                selectedFolderId = 1;
            }
            currentFolderLabel.textContent = idToName[selectedFolderId] || '–û–±—â–∏–π';

            const ulTop = document.createElement('ul');
            (nodes || []).forEach(n => ulTop.appendChild(renderNode(n, counts)));
            treeEl.innerHTML = '';
            treeEl.appendChild(ulTop);

            fillRowFolderSelects();
        }

        function renderNode(node, counts){
            const li = document.createElement('li');
            const row = document.createElement('div');
            row.className = 'node-row';
            row.dataset.id = node.id;

            const icon = document.createElement('span');
            icon.className = 'icon';
            icon.textContent = (node.children?.length ? 'üìÅ' : 'üìÑ');

            const label = document.createElement('span');
            const cnt = counts[node.id] || 0;
            label.className = 'label';
            label.textContent = node.name + ' ('+cnt+')';

            if (node.id === selectedFolderId) {
                row.classList.add('selected');
                label.classList.add('selected');
            }

            row.addEventListener('click', () => {
                selectedFolderId = node.id;
                currentFolderLabel.textContent = node.name;

                qsa('.tree .label.selected', treeEl).forEach(el => el.classList.remove('selected'));
                qsa('.tree .node-row.selected', treeEl).forEach(el => el.classList.remove('selected'));

                label.classList.add('selected');
                row.classList.add('selected');

                filterRows();
                updateFolderContents();
            });

            row.addEventListener('dragover', ev => ev.preventDefault());
            row.addEventListener('drop', async ev => {
                ev.preventDefault();
                const productId = Number(ev.dataTransfer.getData('text/product-id'));
                if (!productId) return;
                await assignProducts(node.id, [productId]);
                await reloadMapping();
                await reloadTree();
                updateFolderContents();
                filterRows();
            });

            row.addEventListener('contextmenu', (e)=>{
                e.preventDefault();
                openCtxMenu(node, e.clientX, e.clientY);
            });

            row.appendChild(icon);
            row.appendChild(label);

            li.appendChild(row);

            if (node.children?.length) {
                const ul = document.createElement('ul');
                node.children.forEach(ch => ul.appendChild(renderNode(ch, counts)));
                li.appendChild(ul);
            }
            return li;
        }

        async function reloadTree(){
            try {
                const data = await api('/cart/sections/tree');
                renderTree(data);
            } catch (e1) {
                try {
                    const flat = await api('/cart/sections/flat');
                    const nodes = Object.entries(flat).map(([id, name]) => ({
                        id: Number(id), name, children: []
                    }));
                    renderTree([{ id: 1, name: flat['1'] || flat[1] || '–û–±—â–∏–π', children: nodes.filter(n => n.id !== 1) }]);
                } catch (e2) {
                    const list = await api('/cart/sections');
                    const map = new Map();
                    list.forEach(it => map.set(it.id, { id: it.id, name: it.name, children: [] }));
                    const roots = [];
                    list.forEach(it => {
                        const node = map.get(it.id);
                        const p = it.parentId;
                        if (p == null) roots.push(node);
                        else (map.get(p)?.children || []).push(node);
                    });
                    renderTree(roots.length ? roots : [{ id: 1, name: '–û–±—â–∏–π', children: [] }]);
                }
            }
        }

        async function reloadMapping(){
            mapping = await api('/cart/sections/mapping');
            sanitizeMapping();
        }

        async function createSection(name, parentId){
            const params = new URLSearchParams();
            params.set('name', name);
            if (parentId) params.set('parentId', parentId);
            await api('/cart/sections', {
                method:'POST',
                headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                body: params
            });
        }

        async function renameSection(sectionId, name){
            try{
                const params = new URLSearchParams();
                params.set('sectionId', sectionId);
                params.set('name', name);
                await api('/cart/sections/rename', {
                    method:'POST',
                    headers:{'Content-Type':'application/x-www-form-urlencoded'},
                    body: params
                });
                return;
            } catch(_){}
            const params = new URLSearchParams();
            params.set('name', name);
            await api(`/cart/sections/${sectionId}/rename`, {
                method:'POST',
                headers:{'Content-Type':'application/x-www-form-urlencoded'},
                body: params
            });
        }

        async function deleteSection(sectionId){
            try {
                await api(`/cart/sections/${sectionId}`, { method:'DELETE' });
                return;
            } catch(_) {}
            try {
                const params = new URLSearchParams();
                params.set('sectionId', sectionId);
                await api('/cart/sections/delete', {
                    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params
                });
                return;
            } catch(_) {}
            await api(`/cart/sections?sectionId=${encodeURIComponent(sectionId)}`, { method:'DELETE' });
        }

        async function moveSection(sectionId, newParentId){
            const params = new URLSearchParams();
            params.set('sectionId', sectionId);
            params.set('newParentId', newParentId);
            try {
                await api('/cart/sections/move', {
                    method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params
                });
                return;
            } catch(_) {}
            await api(`/cart/sections/${sectionId}/move`, {
                method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body: params
            });
        }

        async function clearSection(sectionId){
            let res;
            try {
                const params = new URLSearchParams();
                params.set('sectionId', sectionId);
                res = await api('/cart/sections/clear', {
                    method:'POST',
                    headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                    body: params
                });
            } catch (_) {
                res = await api(`/cart/sections/${sectionId}/clear`, { method:'POST' });
            }

            const removed = (res && res.removed) ? res.removed : [];
            removed.forEach(pid => {
                const row = productIndex[pid]?.row;
                if (row && row.parentElement) row.parentElement.removeChild(row);
                delete productIndex[pid];
                delete mapping[pid];
            });

            sanitizeMapping();
            await reloadMapping();
            await reloadTree();

            updateFolderContents();
            recalcSummary();
            updateSelectionUI();
            filterRows();
        }

        function fillRowFolderSelects(){
            qsa('tr[data-product-id]', cartTbody).forEach(tr=>{
                const pid = Number(tr.dataset.productId);
                const currentSid = Number(mapping[pid] ?? 1);
                const sel = qs('select.row-folder', tr);
                if (!sel) return;
                sel.innerHTML = '';
                flatSections.forEach(s=>{
                    const opt = document.createElement('option');
                    opt.value = String(s.id);
                    opt.textContent = s.path;
                    if (s.id === currentSid) opt.selected = true;
                    sel.appendChild(opt);
                });
                sel.addEventListener('change', async (e)=>{
                    const sid = Number(e.target.value);
                    await assignProducts(sid, [pid]);
                    mapping[pid] = sid;
                    await reloadTree();
                    updateFolderContents();
                    filterRows();
                });
            });
        }

        async function assignProducts(sectionId, productIds){
            const params = new URLSearchParams();
            params.set('sectionId', sectionId);
            productIds.forEach(id => params.append('productIds', id));
            await api('/cart/sections/assign', {
                method:'POST',
                headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                body: params
            });
        }

        async function bulkSetCoeff(ids, coeff){
            let usedBulk = false;
            try {
                const params = new URLSearchParams();
                params.set('coefficient', coeff);
                ids.forEach(id => params.append('productIds', id));
                await api('/cart/coefficient/bulk', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: params
                });
                usedBulk = true;
            } catch (_) {}

            if (!usedBulk) {
                for (const pid of ids) {
                    const params = new URLSearchParams();
                    params.set('productId', pid);
                    params.set('coefficient', coeff);
                    await api('/cart/coefficient', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: params
                    });
                }
            }

            ids.forEach(pid => {
                const row = productIndex[pid]?.row;
                const input = row && row.querySelector('input.coeff');
                if (input) {
                    input.value = coeff;
                    recalcRowSum(row);
                }
            });
            recalcSummary();
        }

        function enableDnDOnRows(){
            qsa('tr[data-product-id]', cartTbody).forEach(tr=>{
                const pid = tr.dataset.productId;
                if (!pid) return;
                tr.setAttribute('draggable','true');
                tr.addEventListener('dragstart', ev=>{
                    ev.dataTransfer.setData('text/product-id', String(pid));
                });
            });
        }

        function visibleRows(){
            return qsa('tr[data-product-id]', cartTbody).filter(tr => tr.style.display !== 'none');
        }
        function setAllVisible(checked){
            visibleRows().forEach(tr=>{
                const cb = qs('.row-check', tr);
                if (cb) cb.checked = checked;
            });
        }
        function clearSelection(){
            setAllVisible(false);
            updateSelectionUI();
        }
        function updateSelectionUI(){
            const rows = visibleRows();
            const all = rows.length > 0 && rows.every(tr => qs('.row-check', tr)?.checked);
            const some = rows.some(tr => qs('.row-check', tr)?.checked);

            toggleAll.checked = all;
            toggleAll.indeterminate = !all && some;

            if (applyCoeffBtn) {
                const someSel = rows.some(tr => qs('.row-check', tr)?.checked);
                applyCoeffBtn.disabled = !someSel;
            }
        }

        function filterRows(){
            const term = (searchInput.value || '').trim().toLowerCase();
            qsa('tr[data-product-id]', cartTbody).forEach(tr=>{
                const pid = Number(tr.dataset.productId);
                const sid = Number(mapping[pid] ?? 1);
                const inFolder = (sid === selectedFolderId);
                const name = qs('.name', tr)?.textContent?.toLowerCase() || '';
                const matches = !term || name.includes(term);
                tr.style.display = (inFolder && matches) ? '' : 'none';
            });
            updateSelectionUI();
        }

        function updateFolderContents(){
            const list = Object.entries(mapping)
                .filter(([pid, sid]) => Number(sid ?? 1) === selectedFolderId)
                .map(([pid]) => Number(pid))
                .filter(pid => !!productIndex[pid]);

            folderProductsBox.innerHTML = '<h4>–¢–æ–≤–∞—Ä—ã –≤ –ø–∞–ø–∫–µ</h4>';
            if (!list.length) {
                const empty = document.createElement('div');
                empty.className = 'empty';
                empty.textContent = '–ü–æ–∫–∞ –ø—É—Å—Ç–æ';
                folderProductsBox.appendChild(empty);
                return;
            }

            const ul = document.createElement('ul');
            list.forEach(pid => {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.textContent = productIndex[pid]?.name || ('–¢–æ–≤–∞—Ä #'+pid);
                a.addEventListener('click', () => {
                    const row = productIndex[pid]?.row;
                    if (row && row.style.display !== 'none'){
                        row.scrollIntoView({behavior:'smooth', block:'center'});
                        row.style.outline = '2px dashed #777';
                        setTimeout(()=>row.style.outline='none', 1000);
                    }
                });
                li.appendChild(a);
                ul.appendChild(li);
            });
            folderProductsBox.appendChild(ul);
        }

        // ===== –ò—Ç–æ–≥–∏ –ø–æ –∫–æ—Ä–∑–∏–Ω–µ =====
        function recalcSummary() {
            const rows = qsa('tr[data-product-id]', cartTbody);
            let positions = 0;
            let totalQty = 0;
            let grand = 0;

            rows.forEach(tr => {
                const qty   = Number(qs('input.qty', tr)?.value || 0);
                const coeff = Number(qs('input.coeff', tr)?.value || 1);
                const priceEl = qs('.price', tr);
                const unit  = Number(priceEl?.dataset.unitPrice ?? priceEl?.getAttribute('data-unit-price') ?? 0);
                if (qty > 0) {
                    positions += 1;
                    totalQty  += qty;
                    grand     += qty * coeff * unit;
                }
            });

            const posEl = document.getElementById('positionsCount');
            const qtyEl = document.getElementById('totalQty');
            const sumEl = document.getElementById('grandTotal');

            if (posEl) posEl.textContent = String(positions);
            if (qtyEl) qtyEl.textContent = String(totalQty);
            if (sumEl) sumEl.textContent = fmtMoney(grand);
        }

        function recalcRowSum(tr){
            const qty = Number(qs('input.qty', tr)?.value || 0);
            const coeff = Number(qs('input.coeff', tr)?.value || 1);
            const priceEl = qs('.price', tr);
            const unit = Number(priceEl?.dataset.unitPrice ?? priceEl?.getAttribute('data-unit-price') ?? 0);
            const sum = qty * coeff * unit;
            const sumCell = qs('.sum', tr);
            sumCell.textContent = fmtMoney(sum);
            sumCell.dataset.value = String(sum);
            recalcSummary();
        }

        function recalcAllRows(){
            qsa('tr[data-product-id]', cartTbody).forEach(recalcRowSum);
            recalcSummary();
        }

        function getVisibleCheckedIds(){
            return visibleRows()
                .filter(tr => qs('.row-check', tr)?.checked)
                .map(tr => Number(tr.dataset.productId));
        }

        async function bulkDelete(ids){
            let okBulk = false;
            try {
                const params = new URLSearchParams();
                ids.forEach(id => params.append('productIds', id));
                await api('/cart/remove-selected', {
                    method:'POST',
                    headers:{'Content-Type':'application/x-www-form-urlencoded'},
                    body: params
                });
                okBulk = true;
            } catch(_) {}

            if (!okBulk){
                for (const pid of ids){
                    try {
                        const p = new URLSearchParams();
                        p.set('productId', pid);
                        await api('/cart/remove', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p });
                    } catch(_){
                        const p = new URLSearchParams();
                        p.set('productId', pid);
                        p.set('quantity', 0);
                        await api('/cart/update', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:p });
                    }
                }
            }

            ids.forEach(pid=>{
                const row = productIndex[pid]?.row;
                if (row && row.parentElement) row.parentElement.removeChild(row);
                delete productIndex[pid];
                delete mapping[pid];
            });
            sanitizeMapping();
            await reloadTree();
            updateFolderContents();
            recalcSummary();
            updateSelectionUI();
            filterRows();
        }

        // ===== UI API –∫–æ—Ä–∑–∏–Ω—ã =====
        window.cartUI = {
            async plusMinus(btn, delta){
                const tr = btn.closest('tr');
                const input = qs('input.qty', tr);
                const next = Math.max(0, Number(input.value||0) + delta);
                input.value = next;
                await window.cartUI.updateQty(input);
            },
            async updateQty(input){
                const pid = Number(input.getAttribute('data-product-id'));
                const val = Number(input.value || 0);

                let usedSetQty = false;
                try{
                    const params = new URLSearchParams();
                    params.set('productId', pid);
                    params.set('qty', val);
                    const res = await api('/cart/set-qty', {
                        method:'POST',
                        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                        body: params
                    });
                    usedSetQty = true;

                    if (val <= 0){
                        const tr = input.closest('tr');
                        tr?.parentElement?.removeChild(tr);
                        delete productIndex[pid];
                        delete mapping[pid];
                        sanitizeMapping();
                        await reloadTree();
                        updateFolderContents();
                        recalcSummary();
                        updateSelectionUI();
                        return;
                    }

                    if (res && typeof res === 'object'){
                        const row = input.closest('tr');
                        if (row){
                            if (res.unitPrice != null){
                                const priceEl = row.querySelector('.price');
                                if (priceEl){
                                    priceEl.textContent = fmtMoney(res.unitPrice);
                                    priceEl.dataset.unitPrice = String(res.unitPrice);
                                }
                            }
                            if (res.lineSum != null){
                                const sumEl = row.querySelector('.sum');
                                if (sumEl) sumEl.textContent = fmtMoney(res.lineSum);
                            } else {
                                recalcRowSum(row);
                            }
                        }
                        if (res.totalQty != null)  document.getElementById('totalQty')?.replaceChildren(document.createTextNode(res.totalQty));
                        if (res.totalSum != null)  document.getElementById('grandTotal')?.replaceChildren(document.createTextNode(fmtMoney(res.totalSum)));
                    } else {
                        recalcRowSum(input.closest('tr'));
                    }
                    updateSelectionUI();
                    return;
                } catch(_){}

                try{
                    const params = new URLSearchParams();
                    params.set('productId', pid);
                    params.set('quantity', val);
                    await api('/cart/update', {
                        method:'POST',
                        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                        body: params
                    });
                } catch(_){}

                if (val <= 0){
                    const tr = input.closest('tr');
                    tr?.parentElement?.removeChild(tr);
                    delete productIndex[pid];
                    delete mapping[pid];
                    sanitizeMapping();
                    await reloadTree();
                    updateFolderContents();
                    recalcSummary();
                    updateSelectionUI();
                } else {
                    recalcRowSum(input.closest('tr'));
                    updateSelectionUI();
                }
            },
            async updateCoeff(input){
                const pid = Number(input.getAttribute('data-product-id'));
                const val = Number(String(input.value || 1).replace(',', '.'));
                const params = new URLSearchParams();
                params.set('productId', pid);
                params.set('coefficient', val);
                await api('/cart/coefficient', {
                    method:'POST',
                    headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
                    body: params
                });
                recalcRowSum(input.closest('tr'));
            }
        };

        function wireUI(){
            indexRows();

            document.addEventListener('click', closeCtx);
            window.addEventListener('scroll', closeCtx, true);
            window.addEventListener('resize', closeCtx);
            document.addEventListener('keydown', (e)=>{ if (e.key==='Escape') closeCtx(); });

            if (applyCoeffBtn) {
                applyCoeffBtn.addEventListener('click', async () => {
                    const ids = getVisibleCheckedIds();
                    if (!ids.length) return;

                    const raw = String(bulkCoeffInput.value || '1').replace(',', '.');
                    const val = Number(raw);

                    if (!Number.isFinite(val) || val < 0) {
                        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–Ω–µ–æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–µ —á–∏—Å–ª–æ)');
                        return;
                    }

                    await bulkSetCoeff(ids, val);
                });

                bulkCoeffInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        applyCoeffBtn?.click();
                    }
                });
            }

            toggleAll.addEventListener('change', ()=>{
                const checked = toggleAll.checked;
                setAllVisible(checked);
                updateSelectionUI();
            });

            cartTbody.addEventListener('change', (e)=>{
                if (e.target && e.target.classList.contains('row-check')) {
                    updateSelectionUI();
                }
            });

            searchInput.addEventListener('input', filterRows);

            moveSelectedBtn.addEventListener('click', async ()=>{
                const ids = getVisibleCheckedIds();
                if (!ids.length) return;
                const sid = Number(bulkFolderSelect.value || selectedFolderId);
                await assignProducts(sid, ids);
                ids.forEach(id => mapping[id] = sid);
                await reloadTree();
                updateFolderContents();
                clearSelection();
                filterRows();
            });

            deleteSelectedBtn.addEventListener('click', async ()=>{
                const ids = getVisibleCheckedIds();
                if (!ids.length) return;
                const ok = confirm(`–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–∑–∏—Ü–∏–∏ (${ids.length} —à—Ç.) –∏–∑ –∫–æ—Ä–∑–∏–Ω—ã?`);
                if (!ok) return;
                await bulkDelete(ids);
            });

            (function initFormBinding(){
                if (!saveForm) return;
                saveForm.addEventListener('submit', () => {
                    const mapToSend = {};
                    Object.keys(productIndex).forEach(k => {
                        const pid = Number(k);
                        if (!productIndex[pid]) return;
                        const sid = Number(mapping[pid] ?? 1);
                        mapToSend[pid] = sid;
                    });
                    if (folderMappingField) {
                        folderMappingField.value = JSON.stringify(mapToSend);
                    }
                });
            })();

            enableDnDOnRows();
        }

        // ===== –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ (—Ñ–æ—Ä–º—É–ª—ã –∫–∞–∫ –≤ Excel) =====
        function calcNum(id){
            const el = document.getElementById(id);
            if (!el) return 0;
            const raw = String(el.value ?? '').replace(',', '.').trim();
            const n = parseFloat(raw);
            return isNaN(n) ? 0 : n;
        }
        function setText(id, text){
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }
        function recalcCalc(){
            const C2  = calcNum('calcC2');
            const C4  = calcNum('calcC4');
            const C5  = calcNum('calcC5');
            const C6  = calcNum('calcC6');
            const C7  = calcNum('calcC7');

            const C9  = calcNum('calcC9');
            const C10 = calcNum('calcC10');
            const C11 = calcNum('calcC11');
            const C12 = calcNum('calcC12');
            const C13 = calcNum('calcC13');

            const C15 = calcNum('calcC15');
            const C16 = calcNum('calcC16');
            const C17 = calcNum('calcC17');
            const C18 = calcNum('calcC18');

            const area_mm2 = (C12 + C13 + C9) * C4 * C5
                + C10 * C6 * C4
                + C11 * C5 * C6;

            const S = area_mm2 / 1_000_000;

            const mass = 0.0079 * C7 / 10 * (area_mm2 / 100);

            const metalCost = 0.0079 * C7 / 10 * C17 * (1.55 * area_mm2 / 100);
            const paintCost = (2 * S) * C15 * C16;
            const costTenge = (metalCost + paintCost) * C18;

            setText('calcC20', S.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            setText('calcC21', mass.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
            setText('calcC22', Math.round(costTenge).toLocaleString('ru-RU'));
            const costEuro = (C2 > 0) ? (costTenge / C2) : 0;
            setText('calcC23', costEuro.toLocaleString('ru-RU', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
        }

        function readCalcPayload(){
            // –∏—Å—Ö–æ–¥–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
            const payload = {
                euroRate:  calcNum('calcC2'),
                heightMm:  calcNum('calcC4'),
                widthMm:   calcNum('calcC5'),
                depthMm:   calcNum('calcC6'),
                thicknessMm: calcNum('calcC7'),

                frontBackQty: calcNum('calcC9'),
                sideQty:      calcNum('calcC10'),
                topBottomQty: calcNum('calcC11'),
                falsePanelQty: calcNum('calcC12'),
                innerQty:      calcNum('calcC13'),

                paintKgPerM2: calcNum('calcC15'),
                paintPrice:   calcNum('calcC16'),
                metalPrice:   calcNum('calcC17'),
                complexityK:  calcNum('calcC18'),
            };

            // –ø–µ—Ä–µ—Å—á–∏—Ç–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å
            const area_mm2 = (payload.falsePanelQty + payload.innerQty + payload.frontBackQty) * payload.heightMm * payload.widthMm
                + payload.sideQty * payload.depthMm * payload.heightMm
                + payload.topBottomQty * payload.widthMm * payload.depthMm;

            const areaM2 = area_mm2 / 1_000_000;
            const massKg = 0.0079 * payload.thicknessMm / 10 * (area_mm2 / 100);
            const metalCost = 0.0079 * payload.thicknessMm / 10 * payload.metalPrice * (1.55 * area_mm2 / 100);
            const paintCost = (2 * areaM2) * payload.paintKgPerM2 * payload.paintPrice;
            const costTenge = (metalCost + paintCost) * payload.complexityK;
            const costEuro  = payload.euroRate > 0 ? costTenge / payload.euroRate : 0;

            payload.results = {
                areaM2,
                massKg,
                costTenge: Math.round(costTenge),
                costEuro
            };

            return payload;
        }

        async function addVirtualProductToCart(){
            const btn = document.getElementById('calcAddToCartBtn');
            if (!btn) return;

            // –ø—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
            const data = readCalcPayload();
            if (data.heightMm <= 0 || data.widthMm <= 0 || data.depthMm <= 0 || data.thicknessMm <= 0){
                alert('–ü—Ä–æ–≤–µ—Ä—å –≥–∞–±–∞—Ä–∏—Ç—ã –∏ —Ç–æ–ª—â–∏–Ω—É –º–µ—Ç–∞–ª–ª–∞: –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å > 0');
                return;
            }

            btn.disabled = true;
            const oldText = btn.textContent;
            btn.textContent = '–î–æ–±–∞–≤–ª—è–µ–º...';

            try {
                // —ç–Ω–¥–ø–æ–∏–Ω—Ç-–∑–∞–≥–ª—É—à–∫–∞ (–ø–µ—Ä–µ–∏–º–µ–Ω—É–µ–º –ø–æ–∑–∂–µ –ø–æ–¥ —Ç–≤–æ—é –ª–æ–≥–∏–∫—É)
                const res = await api('/cart/virtual/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                // 1) –ø—Ä–æ—Å—Ç–æ–π –≤–∞—Ä–∏–∞–Ω—Ç: –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
                //   —Ç–∞–∫ –º—ã —Ç–æ—á–Ω–æ –ø–æ–¥—Ç—è–Ω–µ–º –º–∞–ø–ø–∏–Ω–≥ –ø–∞–ø–æ–∫, —Ü–µ–Ω—ã, –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã –∏ —Ç.–¥.
                location.reload();

                // 2) –µ—Å–ª–∏ –ø–æ–∑–∂–µ –∑–∞—Ö–æ—á–µ—à—å –±–µ–∑ reload ‚Äî —Å–¥–µ–ª–∞–µ–º –≤—Å—Ç–∞–≤–∫—É —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü—É –ø–æ res
            } catch(e){
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ç–æ–≤–∞—Ä: ' + e.message);
            } finally {
                btn.disabled = false;
                btn.textContent = oldText;
            }
        }


        function initCalc(){
            const inputs = qsa('.calc-input');
            if (!inputs.length) return;

            const panel   = document.getElementById('calcFloatingPanel');
            const toggle  = document.getElementById('calcToggleFloating');
            const closeBt = document.getElementById('calcCloseBtn');
            const header  = panel?.querySelector('.calc-header');

            function setVisible(v){
                if (!panel || !toggle) return;
                if (v){
                    panel.classList.add('visible');
                    panel.style.right = '56px';
                    panel.style.left  = 'auto';
                    panel.style.top   = '50%';
                    panel.style.transform = 'translateY(-50%)';
                    toggle.innerHTML = '&gt;';
                } else {
                    panel.classList.remove('visible');
                    toggle.innerHTML = '&lt;';
                }
            }

            if (toggle && panel){
                toggle.addEventListener('click', ()=>{
                    setVisible(!panel.classList.contains('visible'));
                });
            }
            if (closeBt){
                closeBt.addEventListener('click', ()=>setVisible(false));
            }

            // –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
            // –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ –∑–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫
            if (header && panel){
                let dragging = false;
                let offsetX = 0, offsetY = 0;

                header.addEventListener('mousedown', e=>{
                    // –ù–ï –Ω–∞—á–∏–Ω–∞—Ç—å drag, –µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É/–∏–Ω–ø—É—Ç (–≤ —Ç.—á. "‚úï")
                    if (e.target.closest('button') || e.target.closest('input')) {
                        return;
                    }

                    dragging = true;
                    const rect = panel.getBoundingClientRect();
                    offsetX = e.clientX - rect.left;
                    offsetY = e.clientY - rect.top;

                    panel.style.right = 'auto';
                    panel.style.transform = 'none';

                    function onMove(ev){
                        if (!dragging) return;
                        const w = window.innerWidth;
                        const h = window.innerHeight;
                        let left = ev.clientX - offsetX;
                        let top  = ev.clientY - offsetY;

                        const r = panel.getBoundingClientRect();
                        left = Math.max(8, Math.min(w - r.width - 8, left));
                        top  = Math.max(8, Math.min(h - r.height - 8, top));

                        panel.style.left = left + 'px';
                        panel.style.top  = top + 'px';
                    }
                    function onUp(){
                        dragging = false;
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onUp);
                    }

                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                    e.preventDefault();
                });
            }

            const addBtn = document.getElementById('calcAddToCartBtn');
            if (addBtn){
                addBtn.addEventListener('click', addVirtualProductToCart);
            }


            inputs.forEach(i => i.addEventListener('input', recalcCalc));
            recalcCalc();
        }

        // ===== –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è =====
        (async function init(){
            indexRows();
            await reloadMapping();
            await reloadTree();
            wireUI();
            recalcAllRows();
            filterRows();
            updateFolderContents();
            updateSelectionUI();
            initCalc();
        })();

    })();
</script>
</body>
</html>
