<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* –≤—ã—Å–æ—Ç–∞ —Ç–µ–ª–∞ –º–æ–¥–∞–ª–∫–∏ –∏ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª */
        .modal-body {
            max-height: calc(100vh - 200px); /* –º–æ–∂–Ω–æ –ø–æ–¥–ø—Ä–∞–≤–∏—Ç—å —á–∏—Å–ª–æ */
            overflow-y: auto;
        }
    </style>
</head>
<body class="p-4">
<div class="container">
    <h2 class="mb-4">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h2>

    <table class="table table-bordered text-center align-middle">
        <thead class="table-light">
        <tr>
            <th>‚Ññ</th>
            <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
            <th>–ê—Ä—Ç–∏–∫—É–ª</th>
            <th>–ë—Ä–µ–Ω–¥</th>
            <th>–ö–æ–ª-–≤–æ</th>
            <th>–¶–µ–Ω–∞</th>
            <th>–°—É–º–º–∞</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="product, stat : ${products}">
            <td th:text="${stat.index + 1}">1</td>
            <td th:text="${product.name}">–ù–∞–∑–≤–∞–Ω–∏–µ</td>
            <td th:text="${product.articleCode}">–ê—Ä—Ç–∏–∫—É–ª</td>
            <td th:text="${product.brand.brandName}">–ë—Ä–µ–Ω–¥</td>
            <td th:text="${quantities[product.productId]}">1</td>
            <td class="price-format"
                th:text="${finalPrices[product.productId]}">0</td>
            <td class="price-format"
                th:text="${totalSums[product.productId]}">0</td>
        </tr>
        </tbody>
        <tfoot>
        <tr class="fw-bold">
            <td colspan="4" class="text-end">–ò—Ç–æ–≥–æ:</td>
            <td th:text="${totalQuantity}">0</td>
            <td></td>
            <td class="price-format" th:text="${totalSum}">0</td>
        </tr>
        </tfoot>
    </table>

    <!-- –ö–Ω–æ–ø–∫–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è: —Ç–µ–ø–µ—Ä—å —Ç–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –º–æ–¥–∞–ª–∫—É -->
    <button type="button" class="btn btn-outline-secondary" id="downloadPdfBtn">
        üìÑ –°–∫–∞—á–∞—Ç—å –ö–ü –≤ PDF
    </button>
    <button type="button" class="btn btn-outline-secondary ms-2" id="downloadExcelBtn">
        üì• –°–∫–∞—á–∞—Ç—å –ö–ü –≤ Excel
    </button>

    <div class="d-flex justify-content-between mt-4">
        <a href="/cart" class="btn btn-secondary">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∫–æ—Ä–∑–∏–Ω—É</a>
        <a href="/clear-cart-and-return" class="btn btn-primary">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —Ñ–∏–ª—å—Ç—Ä—É</a>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ –ö–ü -->
<div class="modal fade" id="proposalOptionsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∫–æ–º–º–µ—Ä—á–µ—Å–∫–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="–ó–∞–∫—Ä—ã—Ç—å"></button>
            </div>

            <!-- –í–ê–ñ–ù–û: —Ñ–æ—Ä–º–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ /proposal/pdf –∏–ª–∏ /proposal/excel-kp -->
            <form id="proposalForm" method="post">
                <div class="modal-body">

                    <!-- CSRF, –µ—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω -->
                    <input type="hidden" th:if="${_csrf != null}"
                           th:name="${_csrf.parameterName}"
                           th:value="${_csrf.token}"/>

                    <!-- –ù–î–° -->
                    <div class="mb-3">
                        <label class="form-label d-block">–ù–î–°:</label>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="vatIncluded" id="vatYes" value="true" checked>
                            <label class="form-check-label" for="vatYes">–î–∞</label>
                        </div>
                        <div class="form-check form-check-inline">
                            <input class="form-check-input" type="radio" name="vatIncluded" id="vatNo" value="false">
                            <label class="form-check-label" for="vatNo">–ù–µ—Ç</label>
                        </div>
                    </div>

                    <!-- –£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã (%) -->
                    <div class="mb-3">
                        <label class="form-label">–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã (%):</label>
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label small">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</label>
                                <input type="number" class="form-control" name="prepaymentPercent"
                                       min="0" max="100" value="70">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">–û–ø–ª–∞—Ç–∞ –ø–µ—Ä–µ–¥ –æ—Ç–≥—Ä—É–∑–∫–æ–π</label>
                                <input type="number" class="form-control" name="beforeShipmentPercent"
                                       min="0" max="100" value="30">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label small">–ü–æ—Å—Ç–æ–ø–ª–∞—Ç–∞</label>
                                <input type="number" class="form-control" name="postPaymentPercent"
                                       min="0" max="100" value="0">
                            </div>
                        </div>
                        <div class="form-text">–°—É–º–º–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –ø–æ –∂–µ–ª–∞–Ω–∏—é –º–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å = 100.</div>
                    </div>

                    <!-- –£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã (–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ) -->
                    <div class="mb-3">
                        <label class="form-label">–£—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã (–ø—Ä–∏–º–µ—á–∞–Ω–∏–µ):</label>
                        <textarea class="form-control" name="paymentNote" maxlength="200" rows="2"
                                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 70% –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞, 30% –ø–æ—Å–ª–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Ç–æ–≤–∞—Ä–∞ –∫ –æ—Ç–≥—Ä—É–∑–∫–µ."></textarea>
                        <div class="form-text">–ù–µ –±–æ–ª–µ–µ 200 —Å–∏–º–≤–æ–ª–æ–≤.</div>
                    </div>

                    <!-- –°—Ä–æ–∫ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (—Ä–∞–±–æ—á–∏–µ –¥–Ω–∏) -->
                    <div class="mb-3">
                        <label class="form-label">–°—Ä–æ–∫ –∏–∑–≥–æ—Ç–æ–≤–ª–µ–Ω–∏—è (—Ä–∞–±–æ—á–∏–µ –¥–Ω–∏):</label>
                        <input type="number" class="form-control" name="productionDays" min="1" max="999" value="45">
                    </div>

                    <!-- –£—Å–ª–æ–≤–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏ -->
                    <div class="mb-3">
                        <label class="form-label">–£—Å–ª–æ–≤–∏—è –ø–æ—Å—Ç–∞–≤–∫–∏:</label>
                        <input type="text" class="form-control" name="deliveryTerms" maxlength="100"
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: DDP –≥. –ê–ª–º–∞—Ç—ã">
                        <div class="form-text">–ù–µ –±–æ–ª–µ–µ 100 —Å–∏–º–≤–æ–ª–æ–≤.</div>
                    </div>

                    <!-- –ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ -->
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–º–ø–ª–µ–∫—Ç—É—é—â–∏–µ:</label>
                        <input type="text" class="form-control" name="components" maxlength="100"
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–æ–º–ø–ª–µ–∫—Ç –ø–æ—Å—Ç–∞–≤–∫–∏ —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏.">
                        <div class="form-text">–ù–µ –±–æ–ª–µ–µ 100 —Å–∏–º–≤–æ–ª–æ–≤.</div>
                    </div>

                    <!-- –ì–∞—Ä–∞–Ω—Ç–∏—è (–º–µ—Å—è—Ü—ã) -->
                    <div class="mb-3">
                        <label class="form-label">
                            –ì–∞—Ä–∞–Ω—Ç–∏–π–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—è (–º–µ—Å—è—Ü–µ–≤):
                        </label>
                        <input type="number" class="form-control" name="warrantyMonths"
                               min="1" max="99" value="12">
                    </div>

                    <!-- –ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ -->
                    <div class="mb-3">
                        <label class="form-label">
                            –¶–µ–Ω–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –ø—Ä–∏ —Ü–µ–Ω–µ 1 $ (—Ç–µ–Ω–≥–µ –ø–æ –∫—É—Ä—Å—É –ù–ë –†–ö):
                        </label>
                        <input type="number" step="0.01" class="form-control" name="usdRate"
                               min="0" max="9999" value="540.00">
                        <div class="form-text">
                            –í –ö–ü –±—É–¥–µ—Ç —Ç–µ–∫—Å—Ç: ¬´–ø—Ä–∏ —Ü–µ–Ω–µ –∑–∞ 1 $ = &lt;–∑–Ω–∞—á–µ–Ω–∏–µ&gt; —Ç–µ–Ω–≥–µ –ø–æ –∫—É—Ä—Å—É –ù–∞—Ü–±–∞–Ω–∫–∞ –†–ö, –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫—É—Ä—Å–∞ +/- 3% –ö–ü –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ¬ª.
                        </div>
                    </div>

                    <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è -->
                    <div class="mb-3">
                        <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª–æ–≤–∏—è:</label>
                        <textarea class="form-control" name="extraConditions" maxlength="200" rows="2"></textarea>
                        <div class="form-text">–ù–µ –±–æ–ª–µ–µ 200 —Å–∏–º–≤–æ–ª–æ–≤.</div>
                    </div>

                    <!-- –°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ö–ü -->
                    <div class="mb-3">
                        <label class="form-label">–ö–æ–º–º–µ—Ä—á–µ—Å–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ (–¥–Ω–µ–π):</label>
                        <input type="number" class="form-control" name="validDays" min="1" max="99" value="3">
                    </div>

                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" class="btn btn-primary">
                        –°–∫–∞—á–∞—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ü–µ–Ω
    document.querySelectorAll(".price-format").forEach(el => {
        const num = parseFloat(el.innerText.replace(",", "."));
        if (!isNaN(num)) {
            el.innerText = num.toLocaleString('ru-RU', {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1,
                useGrouping: true
            });
        }
    });

    // –õ–æ–≥–∏–∫–∞ –º–æ–¥–∞–ª–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const pdfBtn = document.getElementById('downloadPdfBtn');
    const excelBtn = document.getElementById('downloadExcelBtn');
    const proposalForm = document.getElementById('proposalForm');
    const modalEl = document.getElementById('proposalOptionsModal');
    const modal = new bootstrap.Modal(modalEl);

    pdfBtn.addEventListener('click', () => {
        proposalForm.action = '/proposal/pdf';          // endpoint –¥–ª—è PDF
        modal.show();
    });

    excelBtn.addEventListener('click', () => {
        proposalForm.action = '/proposal/excel-kp';     // endpoint –¥–ª—è Excel
        modal.show();
    });
</script>
</body>
</html>
