<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script th:inline="javascript">
        function onBrandChange() {
            let brandId = document.querySelector('select[name="brandId"]').value;

            fetch(`/filter/groups?brandId=` + brandId)
                .then(res => res.json())
                .then(data => {
                    let groupSelect = document.querySelector('select[name="groupId"]');
                    groupSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>';
                    data.forEach(group => {
                        groupSelect.innerHTML += `<option value="${group.categoryId}">${group.name}</option>`;
                    });
                    groupSelect.disabled = false;
                });

            updateParameters();
        }

        function onGroupChange() {
            let groupId = document.querySelector('select[name="groupId"]').value;

            fetch(`/filter/subgroups?groupId=` + groupId)
                .then(res => res.json())
                .then(data => {
                    let subGroupSelect = document.querySelector('select[name="subGroupId"]');
                    subGroupSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–≥—Ä—É–ø–ø—É</option>';
                    data.forEach(sub => {
                        subGroupSelect.innerHTML += `<option value="${sub.categoryId}">${sub.name}</option>`;
                    });
                    subGroupSelect.disabled = false;
                });

            updateParameters();
        }

        function onSubGroupChange() {
            updateParameters();
        }

        function updateParameters() {
            let brandId = document.querySelector('select[name="brandId"]').value;
            let groupId = document.querySelector('select[name="groupId"]').value;
            let subGroupId = document.querySelector('select[name="subGroupId"]').value;

            let url = `/filter/parameters?brandId=` + brandId;
            if (groupId) url += `&groupId=` + groupId;
            if (subGroupId) url += `&subGroupId=` + subGroupId;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    updateSelect('param1', data.param1List);
                    updateSelect('param2', data.param2List);
                    updateSelect('param3', data.param3List);
                    updateSelect('param4', data.param4List);
                    updateSelect('param5', data.param5List);
                });
        }

        function updateSelect(paramName, values) {
            let select = document.querySelector('select[name="' + paramName + '"]');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>';
            values.forEach(val => {
                select.innerHTML += `<option value="${val}">${val}</option>`;
            });
            select.disabled = false;
        }

        function addToCart(productId) {
            fetch('/cart/add?productId=' + productId, { method: 'POST' })
                .then(() => {
                    const counter = document.getElementById('counter-' + productId);
                    if (counter) {
                        counter.value = parseInt(counter.value) + 1; // —Ä–∞–Ω—å—à–µ –±—ã–ª–æ innerText
                    }
                    const cartCounter = document.getElementById('cart-counter');
                    if (cartCounter) {
                        cartCounter.innerText = parseInt(cartCounter.innerText) + 1;
                    }
                    highlightProduct(productId);
                });
        }

        function removeFromCart(productId) {
            fetch('/cart/remove', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'productId=' + productId
            })
                .then(() => {
                    const counter = document.getElementById('counter-' + productId);
                    if (counter) {
                        const newValue = parseInt(counter.value) - 1; // —Ä–∞–Ω—å—à–µ –±—ã–ª–æ innerText
                        if (newValue <= 0) {
                            counter.value = 0;
                            unhighlightProduct(productId);
                        } else {
                            counter.value = newValue;
                        }
                    }
                    const cartCounter = document.getElementById('cart-counter');
                    if (cartCounter) {
                        cartCounter.innerText = Math.max(0, parseInt(cartCounter.innerText) - 1);
                    }
                });
        }


        function highlightProduct(productId) {
            const productBlock = document.getElementById('product-' + productId);
            if (productBlock) {
                productBlock.classList.add('border', 'border-success', 'rounded', 'shadow-sm', 'bg-light');
            }
        }

        function unhighlightProduct(productId) {
            const productBlock = document.getElementById('product-' + productId);
            if (productBlock) {
                productBlock.classList.remove('border', 'border-success', 'rounded', 'shadow-sm', 'bg-light');
            }
        }



    </script>

</head>
<body class="p-4">
<nav class="d-flex justify-content-between mb-4">
    <div>
        <a href="/admin/add-product" class="btn btn-success">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </a>
    </div>

    <div>
        <a href="/cart" class="btn btn-outline-primary position-relative">
            üõí –ö–æ—Ä–∑–∏–Ω–∞
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                <span id="cart-counter" th:text="${cartCount != null ? cartCount : 0}">0</span>
            </span>
        </a>
    </div>
</nav>


<div class="container">
    <h2 class="mb-4">–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</h2>
    <form method="get" th:action="@{/filter/results}">
        <div class="row mb-3">
            <div class="col">
                <label>–ë—Ä–µ–Ω–¥:</label>
                <select name="brandId" class="form-select" onchange="onBrandChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
                    <option th:each="brand : ${brands}"
                            th:value="${brand.brandId}"
                            th:text="${brand.brandName}"
                            th:selected="${brand.brandId == filterParams['brandId']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞:</label>
                <select name="groupId" class="form-select" onchange="onGroupChange()" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                    <option th:each="group : ${groups}"
                            th:value="${group.categoryId}"
                            th:text="${group.name}"
                            th:selected="${group.categoryId == filterParams['groupId']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ü–æ–¥–≥—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞:</label>
                <select name="subGroupId" class="form-select" onchange="onSubGroupChange()" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–≥—Ä—É–ø–ø—É</option>
                    <option th:each="sub : ${subGroups}"
                            th:value="${sub.categoryId}"
                            th:text="${sub.name}"
                            th:selected="${sub.categoryId == filterParams['subGroupId']}">
                    </option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 1:</label>
                <select name="param1" class="form-select" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param1List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param1']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 2:</label>
                <select name="param2" class="form-select" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param2List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param2']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 3:</label>
                <select name="param3" class="form-select" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param3List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param3']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 4:</label>
                <select name="param4" class="form-select" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param4List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param4']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 5:</label>
                <select name="param5" class="form-select" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param5List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param5']}">
                    </option>
                </select>
            </div>
        </div>
        <div class="row mb-3">
        <div class="col">
            <label>–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é:</label>
            <input type="text" name="keyword" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."
                   th:value="${filterParams['keyword']}">
        </div>
    </div>

        <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </form>

    <hr class="my-4">
    <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:</h4>
    <!-- –ö–ù–û–ü–ö–ê "–°–û–†–¢–ò–†–û–í–ê–¢–¨" -->
    <div class="d-flex justify-content-end mb-3">
        <button id="sortButton" class="btn btn-outline-secondary">
            üßπ –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–û–†–¢–ò–†–û–í–ö–ò -->
    <div id="sortModal" style="
    display: none;
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -30%);
    background: white;
    border: 1px solid #ccc;
    padding: 20px;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    border-radius: 8px;
">
        <h5>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</h5>
        <h5>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</h5>
        <div>
            <input type="checkbox" name="sortOption" value="priceAsc" id="priceAsc">
            <label for="priceAsc">–¶–µ–Ω–∞ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</label><br>

            <input type="checkbox" name="sortOption" value="priceDesc" id="priceDesc">
            <label for="priceDesc">–¶–µ–Ω–∞ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</label><br>

            <input type="checkbox" name="sortOption" value="nameAsc" id="nameAsc">
            <label for="nameAsc">–ù–∞–∑–≤–∞–Ω–∏–µ (A-Z)</label><br>

            <input type="checkbox" name="sortOption" value="nameDesc" id="nameDesc">
            <label for="nameDesc">–ù–∞–∑–≤–∞–Ω–∏–µ (Z-A)</label><br>

            <input type="checkbox" name="sortOption" value="brandAsc" id="brandAsc">
            <label for="brandAsc">–ë—Ä–µ–Ω–¥ (A-Z)</label><br>

            <input type="checkbox" name="sortOption" value="brandDesc" id="brandDesc">
            <label for="brandDesc">–ë—Ä–µ–Ω–¥ (Z-A)</label><br>
        </div>
        <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-primary" onclick="applySort()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>




    <div id="product-list" class="list-group" th:if="${products != null}">
        <div class="list-group-item d-flex justify-content-between align-items-center"
             th:each="prod : ${products}"
             th:id="'product-' + ${prod.productId}"
             th:classappend="${quantities != null and quantities[prod.productId] != null} ? ' border border-success rounded shadow-sm bg-light' : ''">
            <div>
                <h5 class="mb-1" th:text="${prod.name}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h5>
                <small th:text="'–ë—Ä–µ–Ω–¥: ' + ${prod.brand.brandName}"></small><br>
                <small class="text-danger" th:if="${prod.price != null}"
                       th:text="'–¶–µ–Ω–∞: ' + ${#strings.replace(#numbers.formatDecimal(prod.price, 1, 'COMMA', 2, 'POINT'), ',', ' ')} + ' ‚Ç∏'"></small>
                <small class="text-danger" th:if="${prod.price == null}" th:text="'–¶–µ–Ω–∞: –ù–µ —É–∫–∞–∑–∞–Ω–∞'"></small><br>
            </div>

            <div class="input-group" style="max-width: 160px;">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        th:onclick="'removeFromCart(' + ${prod.productId} + ')'">‚ûñ</button>

                <input type="number" min="0" class="form-control form-control-sm text-center"
                       th:id="'counter-' + ${prod.productId}"
                       th:value="${quantities[prod.productId] != null ? quantities[prod.productId] : 0}"
                       onchange="manualQuantityChange(this)"
                style="max-width: 60px;">


                <button type="button" class="btn btn-outline-secondary btn-sm"
                        th:onclick="'addToCart(' + ${prod.productId} + ')'">‚ûï</button>
            </div>


        </div>
    </div>



</div>
<div id="loader" class="text-center my-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script th:inline="javascript">
    let currentPage = /*[[${currentPage}]]*/ 0;
    const totalPages = /*[[${totalPages}]]*/ 1;
    let loading = false;

    window.addEventListener('scroll', () => {
        if (loading) return;
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
            if (currentPage + 1 < totalPages) {
                loadNextPage();
            }
        }
    });

    function loadNextPage() {
        loading = true;
        document.getElementById('loader').style.display = 'block';
        currentPage++;

        const params = new URLSearchParams({
            brandId: document.querySelector('select[name="brandId"]').value,
            groupId: document.querySelector('select[name="groupId"]').value,
            subGroupId: document.querySelector('select[name="subGroupId"]').value,
            param1: document.querySelector('select[name="param1"]').value,
            param2: document.querySelector('select[name="param2"]').value,
            param3: document.querySelector('select[name="param3"]').value,
            param4: document.querySelector('select[name="param4"]').value,
            param5: document.querySelector('select[name="param5"]').value,
            sort: (new URLSearchParams(window.location.search)).get('sort'), // –í–ê–ñ–ù–û: –±–µ—Ä–µ–º —Ç–µ–∫—É—â—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–∑ URL!
            page: currentPage
        });

        fetch('/filter/results?' + params.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const newProducts = tempDiv.querySelectorAll('.list-group-item');
                newProducts.forEach(item => {
                    item.style.opacity = '0';
                    item.style.transition = 'opacity 0.5s ease';
                    document.getElementById('product-list').appendChild(item);
                    setTimeout(() => {
                        item.style.opacity = '1';
                    }, 50);
                });
                document.getElementById('loader').style.display = 'none';
                loading = false;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
                document.getElementById('loader').style.display = 'none';
                loading = false;
            });
    }


    document.addEventListener('DOMContentLoaded', function () {
        const brandId = document.querySelector('select[name="brandId"]').value;
        const groupId = document.querySelector('select[name="groupId"]').value;

        if (brandId) {
            fetch(`/filter/groups?brandId=${brandId}`)
                .then(res => res.json())
                .then(data => {
                    updateSelect('groupId', data.map(group => ({ value: group.categoryId, text: group.name })));
                    document.querySelector('select[name="groupId"]').disabled = false;

                    // –¢–µ–ø–µ—Ä—å –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞, –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–≥—Ä—É–ø–ø—ã
                    if (groupId) {
                        fetch(`/filter/subgroups?groupId=${groupId}`)
                            .then(res => res.json())
                            .then(data => {
                                updateSelect('subGroupId', data.map(sub => ({ value: sub.categoryId, text: sub.name })));
                                document.querySelector('select[name="subGroupId"]').disabled = false;
                            });
                    }
                });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–∂–µ:
        updateParameters();
    });


    function applySort() {
        const selected = document.querySelectorAll('input[name="sortOption"]:checked');
        let sortValues = [];
        selected.forEach(item => sortValues.push(item.value));

        const params = new URLSearchParams(window.location.search);

        // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É:
        if (sortValues.length > 0) {
            params.set('sort', sortValues.join(','));
        } else {
            params.delete('sort');
        }

        params.set('page', 0); // –ü—Ä–∏ –Ω–æ–≤–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ 0!

        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π URL
        window.location.href = '/filter/results?' + params.toString();
    }

    // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
    document.getElementById('sortButton').addEventListener('click', function() {
        document.getElementById('sortModal').style.display = 'block';
    });

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É, –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É—Ç—å –º–∏–º–æ –Ω–µ—ë (–ø–æ –∂–µ–ª–∞–Ω–∏—é, –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã)
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('sortModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    function manualQuantityChange(input) {
        const productId = input.id.split('-')[1];
        const newQuantity = parseInt(input.value);

        if (isNaN(newQuantity) || newQuantity < 0) {
            input.value = 0;
            return;
        }

        fetch('/cart/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'productId=' + productId + '&quantity=' + newQuantity
        })
            .then(() => {
                if (newQuantity === 0) {
                    unhighlightProduct(productId);
                } else {
                    highlightProduct(productId);
                }

                updateCartCounterManually();
            });
    }


    function refreshCartCounter() {
        fetch('/cart/count')
            .then(response => response.text())
            .then(count => {
                const cartCounter = document.getElementById('cart-counter');
                if (cartCounter) {
                    const parsedCount = parseInt(count);
                    cartCounter.innerText = isNaN(parsedCount) ? 0 : parsedCount;
                }
            });
    }

    function updateCartCounterManually() {
        let total = 0;
        const counters = document.querySelectorAll('input[id^="counter-"]');
        counters.forEach(counter => {
            total += parseInt(counter.value) || 0;
        });

        const cartCounter = document.getElementById('cart-counter');
        if (cartCounter) {
            cartCounter.innerText = total;
        }
    }

</script>


</body>
</html>