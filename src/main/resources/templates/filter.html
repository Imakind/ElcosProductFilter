<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script th:inline="javascript">
        let allSubGroups = [];

        function onAnyFilterChange() {
            updateGroups();
            updateSubGroups();
            updateParameters();
        }

        function updateGroups() {
            const brandId = document.querySelector('select[name="brandId"]').value;
            if (!brandId) return;
            fetch(`/filter/groups?brandId=${brandId}`)
                .then(res => res.json())
                .then(data => updateSelect('groupId', data.map(g => ({value: g.categoryId, text: g.name}))));
        }

        function updateSubGroups() {
            const groupId = document.querySelector('select[name="groupId"]').value;
            const brandId = document.querySelector('select[name="brandId"]').value;
            if (!groupId) return;
            let subgroups = allSubGroups.filter(sg => sg.parentCategoryId == groupId);
            updateSelect('subGroupId', subgroups.map(sg => ({ value: sg.categoryId, text: sg.name })));
        }

        function updateParameters() {
            const brandId = document.querySelector('select[name="brandId"]').value;
            const groupId = document.querySelector('select[name="groupId"]').value;
            const subGroupId = document.querySelector('select[name="subGroupId"]').value;

            let url = `/filter/parameters?`;
            if (brandId) url += `brandId=${brandId}&`;
            if (groupId) url += `groupId=${groupId}&`;
            if (subGroupId) url += `subGroupId=${subGroupId}`;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    ['param1', 'param2', 'param3', 'param4', 'param5'].forEach(param => {
                        updateSelect(param, data[param + 'List'] || []);
                    });
                });
        }

        function updateSelect(selectName, items) {
            const select = document.querySelector(`select[name="${selectName}"]`);
            const currentValue = select.value;
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>';
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.value || item;
                option.text = item.text || item;
                if (option.value == currentValue) option.selected = true;
                select.appendChild(option);
            });
        }

        function onSubGroupChange() {
            const subGroupId = document.querySelector('select[name="subGroupId"]').value;
            if (!subGroupId) return;
            const selected = allSubGroups.find(sg => sg.categoryId == subGroupId);
            if (selected) {
                document.querySelector('select[name="groupId"]').value = selected.parentCategoryId;
                updateSubGroups();
            }
            updateParameters();
        }

        function resetFilter() {
            document.querySelectorAll('select, input').forEach(e => e.value = '');
            updateGroups();
            updateSubGroups();
            updateParameters();
        }

        document.addEventListener('DOMContentLoaded', function () {
            fetch('/filter/subgroups/all')
                .then(res => res.json())
                .then(data => {
                    allSubGroups = data;

                    // –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–∏ (–µ—Å–ª–∏ –±—ã–ª–∞ –≤—ã–±—Ä–∞–Ω–∞ –≥—Ä—É–ø–ø–∞)
                    const groupId = document.querySelector('select[name="groupId"]').value;
                    if (groupId) {
                        updateSubGroups();
                    }

                    onAnyFilterChange();
                });

            ['brandId', 'groupId'].forEach(name => {
                document.querySelector(`select[name="${name}"]`)?.addEventListener('change', onAnyFilterChange);
            });
            document.querySelector('select[name="subGroupId"]').addEventListener('change', onSubGroupChange);
        });


        function addToCart(productId) {
            fetch('/cart/add?productId=' + productId, { method: 'POST' })
                .then(() => {
                    const counter = document.getElementById('counter-' + productId);
                    if (counter) {
                        counter.value = parseInt(counter.value) + 1;
                    }
                    const cartCounter = document.getElementById('cart-counter');
                    if (cartCounter) {
                        cartCounter.innerText = parseInt(cartCounter.innerText) + 1;
                    }
                    highlightProduct(productId);
                });
        }

        function removeFromCart(productId) {
            fetch('/cart/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: 'productId=' + productId
            }).then(() => {
                const counter = document.getElementById('counter-' + productId);
                if (counter) {
                    const newValue = parseInt(counter.value) - 1;
                    if (newValue <= 0) {
                        counter.value = 0;
                        unhighlightProduct(productId);
                    } else {
                        counter.value = newValue;
                    }
                }
                const cartCounter = document.getElementById('cart-counter');
                if (cartCounter) {
                    cartCounter.innerText = Math.max(0, parseInt(cartCounter.innerText) - 1);
                }
            });
        }

        function highlightProduct(productId) {
            const productBlock = document.getElementById('product-' + productId);
            if (productBlock) {
                productBlock.classList.add('border', 'border-success', 'rounded', 'shadow-sm', 'bg-light');
            }
        }

        function unhighlightProduct(productId) {
            const productBlock = document.getElementById('product-' + productId);
            if (productBlock) {
                productBlock.classList.remove('border', 'border-success', 'rounded', 'shadow-sm', 'bg-light');
            }
        }
    </script>


</head>
<body class="p-4">
    <nav class="d-flex justify-content-between mb-4 fixed-top bg-white shadow-sm p-3">
        <div>
            <a href="/admin/add-product" class="btn btn-success">
                ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
            </a>
        </div>

        <div>
            <a href="/cart" class="btn btn-outline-primary position-relative">
                üõí –ö–æ—Ä–∑–∏–Ω–∞
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                    <span id="cart-counter" th:text="${cartCount != null ? cartCount : 0}">0</span>
                </span>
            </a>
        </div>
    </nav>


    <div class="container">
        <h2 class="mb-4">–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</h2>
        <form method="get" th:action="@{/filter/results}">
            <div class="row mb-3">
                <div class="col">
                    <label>–ë—Ä–µ–Ω–¥:</label>
                    <select name="brandId" class="form-select" onchange="onBrandChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
                        <option th:each="brand : ${brands}"
                                th:value="${brand.brandId}"
                                th:text="${brand.brandName}"
                                th:selected="${brand.brandId == filterParams['brandId']}">
                        </option>
                    </select>
                </div>
                <div class="col">
                    <label>–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞:</label>
                    <select name="groupId" class="form-select" onchange="onGroupChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                        <option th:each="group : ${groups}"
                                th:value="${group.categoryId}"
                                th:text="${group.name}"
                                th:selected="${group.categoryId == filterParams['groupId']}">
                        </option>
                    </select>
                </div>
                <div class="col">
                    <label>–ü–æ–¥–≥—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞:</label>
                    <select name="subGroupId" class="form-select" onchange="onSubGroupChange()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–≥—Ä—É–ø–ø—É</option>
                        <option th:each="sub : ${subGroups}"
                                th:value="${sub.categoryId}"
                                th:text="${sub.name}"
                                th:selected="${sub.categoryId == filterParams['subGroupId']}">
                        </option>
                    </select>
                </div>
            </div>

            <div class="row mb-3">
                <div class="col">
                    <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 1:</label>
                    <select name="param1" class="form-select" onchange="updateParameters()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                        <option th:each="val : ${param1List}"
                                th:value="${val}" th:text="${val}"
                                th:selected="${val == filterParams['param1']}">
                        </option>
                    </select>
                </div>
                <div class="col">
                    <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 2:</label>
                    <select name="param2" class="form-select" onchange="updateParameters()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                        <option th:each="val : ${param2List}"
                                th:value="${val}" th:text="${val}"
                                th:selected="${val == filterParams['param2']}">
                        </option>
                    </select>
                </div>
                <div class="col">
                    <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 3:</label>
                    <select name="param3" class="form-select" onchange="updateParameters()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                        <option th:each="val : ${param3List}"
                                th:value="${val}" th:text="${val}"
                                th:selected="${val == filterParams['param3']}">
                        </option>
                    </select>
                </div>
                <div class="col">
                    <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 4:</label>
                    <select name="param4" class="form-select" onchange="updateParameters()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                        <option th:each="val : ${param4List}"
                                th:value="${val}" th:text="${val}"
                                th:selected="${val == filterParams['param4']}">
                        </option>
                    </select>
                </div>
                <div class="col">
                    <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 5:</label>
                    <select name="param5" class="form-select" onchange="updateParameters()">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                        <option th:each="val : ${param5List}"
                                th:value="${val}" th:text="${val}"
                                th:selected="${val == filterParams['param5']}">
                        </option>
                    </select>
                </div>
            </div>
            <div class="row mb-3">
                <div class="col">
                    <label>–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é:</label>
                    <input type="text" name="keyword" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."
                           th:value="${filterParams['keyword']}">
                </div>
            </div>

            <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </form>

        <hr class="my-4">
        <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:</h4>
        <!-- –ö–ù–û–ü–ö–ê "–°–û–†–¢–ò–†–û–í–ê–¢–¨" -->
        <div class="d-flex justify-content-end mb-3">
            <button id="sortButton" class="btn btn-outline-secondary">
                üßπ –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
        </div>

        <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–û–†–¢–ò–†–û–í–ö–ò -->
        <div id="sortModal" style="
        display: none;
        position: fixed;
        top: 30%;
        left: 50%;
        transform: translate(-50%, -30%);
        background: white;
        border: 1px solid #ccc;
        padding: 20px;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        border-radius: 8px;
    ">
            <h5>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</h5>
            <h5>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</h5>
            <div>
                <input type="checkbox" name="sortOption" value="priceAsc" id="priceAsc">
                <label for="priceAsc">–¶–µ–Ω–∞ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</label><br>

                <input type="checkbox" name="sortOption" value="priceDesc" id="priceDesc">
                <label for="priceDesc">–¶–µ–Ω–∞ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</label><br>

                <input type="checkbox" name="sortOption" value="nameAsc" id="nameAsc">
                <label for="nameAsc">–ù–∞–∑–≤–∞–Ω–∏–µ (A-Z)</label><br>

                <input type="checkbox" name="sortOption" value="nameDesc" id="nameDesc">
                <label for="nameDesc">–ù–∞–∑–≤–∞–Ω–∏–µ (Z-A)</label><br>

                <input type="checkbox" name="sortOption" value="brandAsc" id="brandAsc">
                <label for="brandAsc">–ë—Ä–µ–Ω–¥ (A-Z)</label><br>

                <input type="checkbox" name="sortOption" value="brandDesc" id="brandDesc">
                <label for="brandDesc">–ë—Ä–µ–Ω–¥ (Z-A)</label><br>
            </div>
            <div class="d-flex justify-content-end mt-3">
                <button class="btn btn-primary" onclick="applySort()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>




        <div id="product-list" class="list-group" th:if="${products != null}">
            <div class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center"
                 style="min-height: 100px;"
                 th:each="prod : ${products}"
                 th:id="'product-' + ${prod.productId}"
                 th:classappend="${quantities != null and quantities[prod.productId] != null} ? ' border border-success rounded shadow-sm bg-light' : ''">

                <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –∫–Ω–æ–ø–∫–∏ –∏ –∏–Ω—Ñ–æ -->
                <div class="d-flex flex-grow-1 flex-column flex-md-row w-100">
                    <!-- –ö–Ω–æ–ø–∫–∏ —Å–ª–µ–≤–∞ -->
                    <div class="me-3 d-flex flex-row flex-md-column gap-1">
                        <!-- –°–∫—Ä—ã—Ç–∞—è –∫–Ω–æ–ø–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                        <button class="btn btn-outline-secondary btn-sm"
                                style="display: none;"
                                th:attr="onclick='openEditModal(' + ${prod.productId} + ')'"
                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä">‚úè</button>

                        <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è -->
                        <button class="btn btn-outline-danger btn-sm"
                                th:attr="onclick='showDeleteConfirmation(' + ${prod.productId} + ')'"
                                title="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä">üóë</button>
                    </div>

                    <!-- –¢–µ–∫—Å—Ç -->
                    <div class="flex-grow-1">
                        <h5 class="mb-1" style="word-break: break-word;">
                            <span th:text="${prod.name}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</span>
                        </h5>
                        <small th:text="'–ë—Ä–µ–Ω–¥: ' + ${prod.brand.brandName}"></small><br>
                        <small class="text-danger" th:if="${prod.price != null}"
                               th:text="'–¶–µ–Ω–∞: ' + ${#strings.replace(#numbers.formatDecimal(prod.price, 1, 'COMMA', 1, 'POINT'), ',', ' ')} + ' ‚Ç∏'"></small>
                        <small class="text-danger" th:if="${prod.price == null}" th:text="'–¶–µ–Ω–∞: –ù–µ —É–∫–∞–∑–∞–Ω–∞'"></small>
                    </div>
                </div>

                <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
                <div class="input-group" style="max-width: 160px;">
                    <button type="button" class="btn btn-outline-secondary btn-sm"
                            th:onclick="'removeFromCart(' + ${prod.productId} + ')'">‚ûñ</button>

                    <input type="number" min="0" class="form-control form-control-sm text-center"
                           th:id="'counter-' + ${prod.productId}"
                           th:value="${quantities[prod.productId] != null ? quantities[prod.productId] : 0}"
                           onchange="manualQuantityChange(this)"
                           style="max-width: 60px;">

                    <button type="button" class="btn btn-outline-secondary btn-sm"
                            th:onclick="'addToCart(' + ${prod.productId} + ')'">‚ûï</button>
                </div>
            </div>
        </div>


    </div>
    </div>

    <div id="loader" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Modal -->
    <div id="editModal" class="modal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
            background:white; border:1px solid #ccc; padding:20px; z-index:10000; width:400px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
        <h5>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h5>
        <form id="editProductForm">
            <input type="hidden" name="productId" id="edit-product-id">
            <div class="mb-2">
                <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" name="name" class="form-control" id="edit-name">
            </div>
            <div class="mb-2">
                <label>–¶–µ–Ω–∞:</label>
                <input type="number" step="0.01" name="price" class="form-control" id="edit-price">
            </div>
            <div class="mb-2">
                <label>–ê—Ä—Ç–∏–∫—É–ª:</label>
                <input type="text" name="articleCode" class="form-control" id="edit-article">
            </div>
            <!-- –º–æ–∂–µ—à—å –ø–æ–∑–∂–µ –¥–æ–±–∞–≤–∏—Ç—å brandId, param1-5 –∏ –ø—Ä–æ—á–µ–µ -->
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
                <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </form>
    </div>

    <!-- –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Ñ–æ–Ω -->
    <div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
         background: rgba(0, 0, 0, 0.5); z-index: 9998;"></div>

    <!-- –°–∞–º–æ –æ–∫–Ω–æ -->
    <div id="deleteModal" style="display: none; position: fixed; top: 50%; left: 50%;
         transform: translate(-50%, -50%); background: white; padding: 20px;
         border: 1px solid #ccc; border-radius: 10px; z-index: 9999; width: 300px; max-width: 90%;">
        <p class="mb-3">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?</p>
        <div class="d-flex justify-content-end gap-2">
            <button class="btn btn-secondary" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-danger" id="confirmDeleteBtn">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
    </div>


    <div th:replace="~{fragments/history_modal :: proposalHistoryModal}"></div>

    <button id="scrollTopBtn" class="scroll-to-top" aria-label="–ù–∞–≤–µ—Ä—Ö">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
             stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up">
            <line x1="12" y1="19" x2="12" y2="5"/>
            <polyline points="5 12 12 5 19 12"/>
        </svg>
    </button>

    <style>
        .scroll-to-top {
        position: fixed;
        bottom: 24px;
        right: 24px;
        z-index: 1050;
        width: 48px;
        height: 48px;
        border: none;
        border-radius: 50%;
        background-color: #343a40;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        visibility: hidden;
        transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .scroll-to-top.show {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
        }

        .scroll-to-top:hover {
        background-color: #495057;
        transform: translateY(0) scale(1.1);
        }
    </style>


    <script th:inline="javascript">
    let currentPage = /*[[${currentPage}]]*/ 0;
    const totalPages = /*[[${totalPages}]]*/ 1;
    let loading = false;

    window.addEventListener('scroll', () => {
        if (loading) return;
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
            if (currentPage + 1 < totalPages) {
                loadNextPage();
            }
        }
    });

    function loadNextPage() {
        loading = true;
        document.getElementById('loader').style.display = 'block';
        currentPage++;

        const params = new URLSearchParams({
            brandId: document.querySelector('select[name="brandId"]').value,
            groupId: document.querySelector('select[name="groupId"]').value,
            subGroupId: document.querySelector('select[name="subGroupId"]').value,
            param1: document.querySelector('select[name="param1"]').value,
            param2: document.querySelector('select[name="param2"]').value,
            param3: document.querySelector('select[name="param3"]').value,
            param4: document.querySelector('select[name="param4"]').value,
            param5: document.querySelector('select[name="param5"]').value,
            sort: (new URLSearchParams(window.location.search)).get('sort'), // –í–ê–ñ–ù–û: –±–µ—Ä–µ–º —Ç–µ–∫—É—â—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–∑ URL!
            page: currentPage
        });

        fetch('/filter/results?' + params.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const newProducts = tempDiv.querySelectorAll('.list-group-item');
                newProducts.forEach(item => {
                    item.style.opacity = '0';
                    item.style.transition = 'opacity 0.5s ease';
                    document.getElementById('product-list').appendChild(item);
                    setTimeout(() => {
                        item.style.opacity = '1';
                        attachProductHandlers(item);
                    }, 50);
                });
                document.getElementById('loader').style.display = 'none';
                loading = false;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
                document.getElementById('loader').style.display = 'none';
                loading = false;
            });
    }


    document.addEventListener('DOMContentLoaded', function () {
        const brandId = document.querySelector('select[name="brandId"]').value;
        const groupId = document.querySelector('select[name="groupId"]').value;

        if (brandId) {
            fetch(`/filter/groups?brandId=${brandId}`)
                .then(res => res.json())
                .then(data => {
                    updateSelect('groupId', data.map(group => ({ value: group.categoryId, text: group.name })));
                    document.querySelector('select[name="groupId"]').disabled = false;

                    // –¢–µ–ø–µ—Ä—å –µ—Å–ª–∏ –µ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–∞—è –≥—Ä—É–ø–ø–∞, –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–¥–≥—Ä—É–ø–ø—ã
                    if (groupId) {
                        fetch(`/filter/subgroups?groupId=${groupId}`)
                            .then(res => res.json())
                            .then(data => {
                                updateSelect('subGroupId', data.map(sub => ({ value: sub.categoryId, text: sub.name })));
                                document.querySelector('select[name="subGroupId"]').disabled = false;
                            });
                    }
                });
        }

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç–æ–∂–µ:
        updateParameters();
    });


    function applySort() {
        const selected = document.querySelectorAll('input[name="sortOption"]:checked');
        let sortValues = [];
        selected.forEach(item => sortValues.push(item.value));

        const params = new URLSearchParams(window.location.search);

        // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç—å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É:
        if (sortValues.length > 0) {
            params.set('sort', sortValues.join(','));
        } else {
            params.delete('sort');
        }

        params.set('page', 0); // –ü—Ä–∏ –Ω–æ–≤–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–µ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞ 0!

        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π URL
        window.location.href = '/filter/results?' + params.toString();
    }

    // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É
    document.getElementById('sortButton').addEventListener('click', function() {
        document.getElementById('sortModal').style.display = 'block';
    });

    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É, –µ—Å–ª–∏ –∫–ª–∏–∫–Ω—É—Ç—å –º–∏–º–æ –Ω–µ—ë (–ø–æ –∂–µ–ª–∞–Ω–∏—é, –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã)
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('sortModal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });

    function manualQuantityChange(input) {
        const productId = input.id.split('-')[1];
        const newQuantity = parseInt(input.value);

        if (isNaN(newQuantity) || newQuantity < 0) {
            input.value = 0;
            return;
        }

        fetch('/cart/update', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'productId=' + productId + '&quantity=' + newQuantity
        })
            .then(() => {
                if (newQuantity === 0) {
                    unhighlightProduct(productId);
                } else {
                    highlightProduct(productId);
                }

                updateCartCounterManually();
            });
    }


    function refreshCartCounter() {
        fetch('/cart/count')
            .then(response => response.text())
            .then(count => {
                const cartCounter = document.getElementById('cart-counter');
                if (cartCounter) {
                    const parsedCount = parseInt(count);
                    cartCounter.innerText = isNaN(parsedCount) ? 0 : parsedCount;
                }
            });
    }

    function updateCartCounterManually() {
        let total = 0;
        const counters = document.querySelectorAll('input[id^="counter-"]');
        counters.forEach(counter => {
            total += parseInt(counter.value) || 0;
        });

        const cartCounter = document.getElementById('cart-counter');
        if (cartCounter) {
            cartCounter.innerText = total;
        }
    }


    function openEditModal(productId) {
        fetch('/admin/api/product?id=' + productId)
            .then(response => response.json())
            .then(product => {
                document.getElementById('edit-product-id').value = product.productId;
                document.getElementById('edit-name').value = product.name;
                document.getElementById('edit-price').value = product.price;
                document.getElementById('edit-article').value = product.articleCode;
                document.getElementById('editModal').style.display = 'block';
            });
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editProductForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        fetch('/admin/api/edit-product', {
            method: 'POST',
            body: new URLSearchParams(formData)
        }).then(() => {
            closeEditModal();
            location.reload();
        });
    });



    let productToDelete = null;

    function showDeleteConfirmation(productId) {
        productToDelete = productId;
        document.getElementById('deleteModal').style.display = 'block';
        document.getElementById('confirmDeleteBtn').focus();
    }

    function closeDeleteModal() {
        productToDelete = null;
        document.getElementById('deleteModal').style.display = 'none';
    }

    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        if (productToDelete) {
            fetch('/admin/api/product/' + productToDelete, {
                method: 'DELETE'
            }).then(() => {
                document.getElementById('product-' + productToDelete)?.remove();
                closeDeleteModal();
            });
        }
    });

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && document.getElementById('deleteModal').style.display === 'block') {
            document.getElementById('confirmDeleteBtn').click();
        }
        if (e.key === 'Escape') {
            closeDeleteModal();
        }
    });
    function showDeleteConfirmation(productId) {
        productToDelete = productId;
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('deleteModal').style.display = 'block';
        document.getElementById('confirmDeleteBtn').focus();
    }

    function closeDeleteModal() {
        productToDelete = null;
        document.getElementById('deleteModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }


    function attachProductHandlers(item) {
        const editBtn = item.querySelector('button[title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä"]');
        const deleteBtn = item.querySelector('button[title="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä"]');

        if (editBtn) {
            const id = editBtn.getAttribute('onclick').match(/\d+/)[0];
            editBtn.onclick = () => openEditModal(parseInt(id));
        }

        if (deleteBtn) {
            const id = deleteBtn.getAttribute('onclick').match(/\d+/)[0];
            deleteBtn.onclick = () => showDeleteConfirmation(parseInt(id));
        }
    }

    const scrollTopBtn = document.getElementById("scrollTopBtn");

    window.addEventListener("scroll", function () {
        if (window.scrollY > 200) {
            scrollTopBtn.classList.add("show");
        } else {
            scrollTopBtn.classList.remove("show");
        }
    });

    scrollTopBtn.addEventListener("click", function () {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

</script>


</body>
</html>