<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script th:inline="javascript">
        function onBrandChange() {
            let brandId = document.querySelector('select[name="brandId"]').value;

            fetch(`/filter/groups?brandId=` + brandId)
                .then(res => res.json())
                .then(data => {
                    let groupSelect = document.querySelector('select[name="groupId"]');
                    groupSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>';
                    data.forEach(group => {
                        groupSelect.innerHTML += `<option value="${group.categoryId}">${group.name}</option>`;
                    });
                    groupSelect.disabled = false;
                });

            updateParameters();
        }

        function onGroupChange() {
            let groupId = document.querySelector('select[name="groupId"]').value;

            fetch(`/filter/subgroups?groupId=` + groupId)
                .then(res => res.json())
                .then(data => {
                    let subGroupSelect = document.querySelector('select[name="subGroupId"]');
                    subGroupSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–≥—Ä—É–ø–ø—É</option>';
                    data.forEach(sub => {
                        subGroupSelect.innerHTML += `<option value="${sub.categoryId}">${sub.name}</option>`;
                    });
                    subGroupSelect.disabled = false;
                });

            updateParameters();
        }

        function onSubGroupChange() {
            updateParameters();
        }

        function updateParameters() {
            let brandId = document.querySelector('select[name="brandId"]').value;
            let groupId = document.querySelector('select[name="groupId"]').value;
            let subGroupId = document.querySelector('select[name="subGroupId"]').value;

            let url = `/filter/parameters?brandId=` + brandId;
            if (groupId) url += `&groupId=` + groupId;
            if (subGroupId) url += `&subGroupId=` + subGroupId;

            fetch(url)
                .then(res => res.json())
                .then(data => {
                    updateSelect('param1', data.param1List);
                    updateSelect('param2', data.param2List);
                    updateSelect('param3', data.param3List);
                    updateSelect('param4', data.param4List);
                    updateSelect('param5', data.param5List);
                });
        }

        function updateSelect(paramName, values) {
            let select = document.querySelector('select[name="' + paramName + '"]');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>';
            values.forEach(val => {
                select.innerHTML += `<option value="${val}">${val}</option>`;
            });
            select.disabled = false;
        }

        function addToCart(productId) {
            fetch('/cart/add?productId=' + productId, { method: 'POST' })
                .then(() => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á—ë—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã –≤ —à–∞–ø–∫–µ
                    const counter = document.getElementById('cart-counter');
                    if (counter) {
                        const current = parseInt(counter.innerText);
                        counter.innerText = current + 1;
                    }

                    // –ù–∞–π—Ç–∏ –∫–Ω–æ–ø–∫—É –∏ –±–ª–æ–∫ —Ç–æ–≤–∞—Ä–∞
                    const btn = document.getElementById('btn-' + productId);
                    const productBlock = document.getElementById('product-' + productId);

                    if (btn && productBlock) {
                        // –°—á–∏—Ç–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–∂–∞—Ç–∏–π
                        if (!btn.dataset.count) btn.dataset.count = 0;
                        btn.dataset.count = parseInt(btn.dataset.count) + 1;

                        // –¢–æ–ª—å–∫–æ –º–µ–Ω—è–µ–º —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏!
                        btn.innerText = '–î–æ–±–∞–≤–∏—Ç—å (' + btn.dataset.count + ')';

                        // –î–µ–ª–∞–µ–º —Ä–∞–º–∫—É —Ç–æ–≤–∞—Ä–∞
                        productBlock.classList.add('border', 'border-success', 'rounded', 'shadow-sm', 'bg-light');
                    }
                });
        }


    </script>

</head>
<body class="p-4">
<nav class="d-flex justify-content-between mb-4">
    <div>
        <a href="/admin/add-product" class="btn btn-success">
            ‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä
        </a>
    </div>

    <div>
        <a href="/cart" class="btn btn-outline-primary position-relative">
            üõí –ö–æ—Ä–∑–∏–Ω–∞
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                <span id="cart-counter" th:text="${cartCount != null ? cartCount : 0}">0</span>
            </span>
        </a>
    </div>
</nav>


<div class="container">
    <h2 class="mb-4">–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</h2>
    <form method="get" th:action="@{/filter/results}">
        <div class="row mb-3">
            <div class="col">
                <label>–ë—Ä–µ–Ω–¥:</label>
                <select name="brandId" class="form-select" onchange="onBrandChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
                    <option th:each="brand : ${brands}"
                            th:value="${brand.brandId}"
                            th:text="${brand.brandName}"
                            th:selected="${brand.brandId == filterParams['brandId']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞:</label>
                <select name="groupId" class="form-select" onchange="onGroupChange()" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                    <option th:each="group : ${groups}"
                            th:value="${group.categoryId}"
                            th:text="${group.name}"
                            th:selected="${group.categoryId == filterParams['groupId']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ü–æ–¥–≥—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞:</label>
                <select name="subGroupId" class="form-select" onchange="onSubGroupChange()" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–≥—Ä—É–ø–ø—É</option>
                    <option th:each="sub : ${subGroups}"
                            th:value="${sub.categoryId}"
                            th:text="${sub.name}"
                            th:selected="${sub.categoryId == filterParams['subGroupId']}">
                    </option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 1:</label>
                <select name="param1" class="form-select" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param1List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param1']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 2:</label>
                <select name="param2" class="form-select" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param2List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param2']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 3:</label>
                <select name="param3" class="form-select" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param3List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param3']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 4:</label>
                <select name="param4" class="form-select" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param4List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param4']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label>–ü–∞—Ä–∞–º–µ—Ç—Ä 5:</label>
                <select name="param5" class="form-select" disabled>
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param5List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param5']}">
                    </option>
                </select>
            </div>
        </div>
        <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </form>

    <hr class="my-4">
    <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:</h4>
    <!-- –ö–ù–û–ü–ö–ê "–°–û–†–¢–ò–†–û–í–ê–¢–¨" -->
    <div class="d-flex justify-content-end mb-3">
        <button id="sortButton" class="btn btn-outline-secondary">
            üßπ –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
        </button>
    </div>

    <!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–û–†–¢–ò–†–û–í–ö–ò -->
    <div id="sortModal" style="
    display: none;
    position: fixed;
    top: 30%;
    left: 50%;
    transform: translate(-50%, -30%);
    background: white;
    border: 1px solid #ccc;
    padding: 20px;
    z-index: 10000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    border-radius: 8px;
">
        <h5>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</h5>
        <h5>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</h5>
        <div>
            <input type="checkbox" name="sortOption" value="priceAsc" id="priceAsc">
            <label for="priceAsc">–¶–µ–Ω–∞ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</label><br>

            <input type="checkbox" name="sortOption" value="priceDesc" id="priceDesc">
            <label for="priceDesc">–¶–µ–Ω–∞ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</label><br>

            <input type="checkbox" name="sortOption" value="nameAsc" id="nameAsc">
            <label for="nameAsc">–ù–∞–∑–≤–∞–Ω–∏–µ (A-Z)</label><br>

            <input type="checkbox" name="sortOption" value="nameDesc" id="nameDesc">
            <label for="nameDesc">–ù–∞–∑–≤–∞–Ω–∏–µ (Z-A)</label><br>

            <input type="checkbox" name="sortOption" value="brandAsc" id="brandAsc">
            <label for="brandAsc">–ë—Ä–µ–Ω–¥ (A-Z)</label><br>

            <input type="checkbox" name="sortOption" value="brandDesc" id="brandDesc">
            <label for="brandDesc">–ë—Ä–µ–Ω–¥ (Z-A)</label><br>
        </div>
        <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-primary" onclick="applySort()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>




    <div id="product-list" class="list-group" th:if="${products != null}">
        <div class="list-group-item d-flex justify-content-between align-items-center"
             th:each="prod : ${products}"
             th:id="'product-' + ${prod.productId}">
            <div>
                <h5 class="mb-1" th:text="${prod.name}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h5>
                <small th:text="'–ë—Ä–µ–Ω–¥: ' + ${prod.brand.brandName}"></small><br>
                <small class="text-danger" th:if="${prod.price != null}"
                       th:text="'–¶–µ–Ω–∞: ' + ${#strings.replace(#numbers.formatDecimal(prod.price, 1, 'COMMA', 2, 'POINT'), ',', ' ')} + ' ‚Ç∏'"></small>
                <small class="text-danger" th:if="${prod.price == null}" th:text="'–¶–µ–Ω–∞: –ù–µ —É–∫–∞–∑–∞–Ω–∞'"></small><br>
            </div>

            <button class="btn btn-success btn-sm"
                    th:id="'btn-' + ${prod.productId}"
                    th:attr="onclick='addToCart(' + ${prod.productId} + ')'">
                +
            </button>
        </div>
    </div>



</div>
<div id="loader" class="text-center my-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<script th:inline="javascript">
    let currentPage = /*[[${currentPage}]]*/ 0;
    const totalPages = /*[[${totalPages}]]*/ 1;
    let loading = false;

    window.addEventListener('scroll', () => {
        if (loading) return;
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
            if (currentPage + 1 < totalPages) {
                loadNextPage();
            }
        }
    });

    function loadNextPage() {
        loading = true;
        document.getElementById('loader').style.display = 'block';
        currentPage++;

        const params = new URLSearchParams({
            brandId: document.querySelector('select[name="brandId"]').value,
            groupId: document.querySelector('select[name="groupId"]').value,
            subGroupId: document.querySelector('select[name="subGroupId"]').value,
            param1: document.querySelector('select[name="param1"]').value,
            param2: document.querySelector('select[name="param2"]').value,
            param3: document.querySelector('select[name="param3"]').value,
            param4: document.querySelector('select[name="param4"]').value,
            param5: document.querySelector('select[name="param5"]').value,
            sort: (new URLSearchParams(window.location.search)).get('sort'), // –í–ê–ñ–ù–û: –±–µ—Ä–µ–º —Ç–µ–∫—É—â—É—é —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –∏–∑ URL!
            page: currentPage
        });

        fetch('/filter/results?' + params.toString(), {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const newProducts = tempDiv.querySelectorAll('.list-group-item');
                newProducts.forEach(item => {
                    item.style.opacity = '0';
                    item.style.transition = 'opacity 0.5s ease';
                    document.getElementById('product-list').appendChild(item);
                    setTimeout(() => {
                        item.style.opacity = '1';
                    }, 50);
                });
                document.getElementById('loader').style.display = 'none';
                loading = false;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
                document.getElementById('loader').style.display = 'none';
                loading = false;
            });
    }


    document.addEventListener('DOMContentLoaded', function () {
        const sortButton = document.getElementById('sortButton');
        const sortModal = document.getElementById('sortModal');

        sortButton.addEventListener('click', function () {
            if (sortModal.style.display === 'none') {
                sortModal.style.display = 'block';
            } else {
                sortModal.style.display = 'none';
            }
        });
    });

    function applySort() {
        const selected = document.querySelectorAll('input[name="sortOption"]:checked');
        let sortValues = [];
        selected.forEach(item => sortValues.push(item.value));

        if (sortValues.length > 0) {
            const params = new URLSearchParams({
                brandId: document.querySelector('select[name="brandId"]').value,
                groupId: document.querySelector('select[name="groupId"]').value,
                subGroupId: document.querySelector('select[name="subGroupId"]').value,
                param1: document.querySelector('select[name="param1"]').value,
                param2: document.querySelector('select[name="param2"]').value,
                param3: document.querySelector('select[name="param3"]').value,
                param4: document.querySelector('select[name="param4"]').value,
                param5: document.querySelector('select[name="param5"]').value,
                sort: sortValues.join(',') // –æ–±—ä–µ–¥–∏–Ω—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
            });

            // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –Ω–æ–≤—ã–π URL
            window.location.href = '/filter/results?' + params.toString();
        }
    }

</script>


</body>
</html>