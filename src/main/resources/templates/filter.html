<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ Bootstrap) -->
<nav class="navbar navbar-expand-md navbar-light bg-white shadow-sm fixed-top">
    <div class="container">
        <a class="navbar-brand fw-semibold" href="/">ProductFilter</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav"
                aria-controls="topNav" aria-expanded="false" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="topNav">
            <ul class="navbar-nav me-auto align-items-md-center gap-2">
                <li class="nav-item">
                    <button class="btn btn-outline-secondary"
                            type="button"
                            data-bs-toggle="offcanvas" data-bs-target="#historySidebar">
                        üìÇ –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤
                    </button>
                </li>

                <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                    <a href="/admin/add-product" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</a>
                </li>

                <!-- –ö–ù–û–ü–ö–ê –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–û–í -->
                <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                    <button class="btn btn-warning"
                            type="button"
                            data-bs-toggle="modal"
                            data-bs-target="#coefModal">
                        ‚öô –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
                    </button>
                </li>
            </ul>

            <ul class="navbar-nav ms-auto align-items-md-center gap-2">
                <li class="nav-item">
                    <a href="/cart" class="btn btn-outline-primary position-relative">
                        üõí –ö–æ—Ä–∑–∏–Ω–∞
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                          <span id="cart-counter" th:text="${cartCount != null ? cartCount : 0}">0</span>
                        </span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/logout" class="btn btn-outline-dark">–í—ã–π—Ç–∏</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<style>
    body { padding-top: 72px; }
    .scroll-to-top {
        position: fixed; bottom: 24px; right: 24px; z-index: 1050;
        width: 48px; height: 48px; border: none; border-radius: 50%;
        background-color: #343a40; color: #fff; display: flex;
        align-items: center; justify-content: center; opacity: 0;
        visibility: hidden; transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .scroll-to-top.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .scroll-to-top:hover { background-color: #495057; transform: translateY(0) scale(1.1); }
</style>

<div class="container">
    <h2 class="mb-4">–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</h2>

    <form method="get" th:action="@{/filter/results}">
        <div class="row mb-3">
            <div class="col">
                <label class="form-label" for="brandId">–ë—Ä–µ–Ω–¥:</label>
                <select id="brandId" name="brandId" class="form-select" onchange="onBrandChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
                    <option th:each="brand : ${brands}"
                            th:value="${brand.brandId}"
                            th:text="${brand.brandName}"
                            th:selected="${filterParams['brandId'] != null and brand.brandId == T(java.lang.Integer).valueOf(filterParams['brandId'])}">
                    </option>
                </select>
            </div>

            <div class="col">
                <label class="form-label" for="groupId">–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞:</label>
                <select id="groupId" name="groupId" class="form-select" onchange="onGroupChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                    <option th:each="group : ${groups}"
                            th:value="${group.categoryId}"
                            th:text="${group.name}"
                            th:selected="${filterParams['groupId'] != null and group.categoryId == T(java.lang.Integer).valueOf(filterParams['groupId'])}">
                    </option>
                </select>
            </div>

            <div class="col">
                <label class="form-label" for="subGroupId">–ü–æ–¥–≥—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞:</label>
                <select id="subGroupId" name="subGroupId" class="form-select" onchange="onSubGroupChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–≥—Ä—É–ø–ø—É</option>
                    <option th:each="sub : ${subGroups}"
                            th:value="${sub.categoryId}"
                            th:text="${sub.name}"
                            th:selected="${filterParams['subGroupId'] != null and sub.categoryId == T(java.lang.Integer).valueOf(filterParams['subGroupId'])}">
                    </option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col" id="param1-container">
                <label id="label-param1" for="param1" class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä 1:</label>
                <select id="param1" name="param1" class="form-select" onchange="onParamChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param1List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param1']}"></option>
                </select>
            </div>

            <div class="col" id="param2-container">
                <label id="label-param2" for="param2" class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä 2:</label>
                <select id="param2" name="param2" class="form-select" onchange="onParamChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param2List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param2']}"></option>
                </select>
            </div>

            <div class="col" id="param3-container">
                <label id="label-param3" for="param3" class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä 3:</label>
                <select id="param3" name="param3" class="form-select" onchange="onParamChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param3List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param3']}"></option>
                </select>
            </div>

            <div class="col" id="param4-container">
                <label id="label-param4" for="param4" class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä 4:</label>
                <select id="param4" name="param4" class="form-select" onchange="onParamChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param4List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param4']}"></option>
                </select>
            </div>

            <div class="col" id="param5-container">
                <label id="label-param5" for="param5" class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä 5:</label>
                <select id="param5" name="param5" class="form-select" onchange="onParamChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param5List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param5']}"></option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <label class="form-label" for="keyword">–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é:</label>
                <input id="keyword" type="text" name="keyword" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."
                       th:value="${filterParams['keyword']}">
            </div>
        </div>

        <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <input type="hidden" name="page" id="page" th:value="${currentPage}">
        <input type="hidden" name="sort" id="sort" th:value="${filterParams['sort']}">
    </form>

    <hr class="my-4">
    <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:</h4>

    <div class="d-flex justify-content-end mb-3">
        <button id="sortButton" class="btn btn-outline-secondary">üßπ –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
    <div id="sortModal" style="
        display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-30%);
        background:white; border:1px solid #ccc; padding:20px; z-index:10000;
        box-shadow:0 4px 12px rgba(0,0,0,0.2); border-radius:8px;">
        <h5>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</h5>
        <div>
            <input type="checkbox" name="sortOption" value="priceAsc" id="priceAsc">
            <label for="priceAsc">–¶–µ–Ω–∞ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</label><br>
            <input type="checkbox" name="sortOption" value="priceDesc" id="priceDesc">
            <label for="priceDesc">–¶–µ–Ω–∞ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</label><br>
            <input type="checkbox" name="sortOption" value="nameAsc" id="nameAsc">
            <label for="nameAsc">–ù–∞–∑–≤–∞–Ω–∏–µ (A-Z)</label><br>
            <input type="checkbox" name="sortOption" value="nameDesc" id="nameDesc">
            <label for="nameDesc">–ù–∞–∑–≤–∞–Ω–∏–µ (Z-A)</label><br>
            <input type="checkbox" name="sortOption" value="brandAsc" id="brandAsc">
            <label for="brandAsc">–ë—Ä–µ–Ω–¥ (A-Z)</label><br>
            <input type="checkbox" name="sortOption" value="brandDesc" id="brandDesc">
            <label for="brandDesc">–ë—Ä–µ–Ω–¥ (Z-A)</label><br>
        </div>
        <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-primary" onclick="applySort()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <div id="product-list" class="list-group" th:if="${products != null}">
        <div class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center"
             style="min-height: 100px;"
             th:each="prod : ${products}"
             th:id="'product-' + ${prod.productId}"
             th:classappend="${quantities != null and quantities[prod.productId] != null} ? ' border border-success rounded shadow-sm bg-light' : ''">

            <div class="d-flex flex-grow-1 flex-column flex-md-row w-100">
                <div class="me-3 d-flex flex-row flex-md-column gap-1">
                    <button class="btn btn-outline-secondary btn-sm"
                            th:attr="onclick='openEditModal(' + ${prod.productId} + ')'"
                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä">‚úè</button>

                    <button class="btn btn-outline-danger btn-sm"
                            th:attr="onclick='showDeleteConfirmation(' + ${prod.productId} + ')'"
                            title="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä"
                            sec:authorize="hasRole('ADMIN')">üóë</button>
                </div>

                <div class="flex-grow-1">
                    <h5 class="mb-1" style="word-break: break-word;">
                        <span th:text="${prod.name}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</span>
                    </h5>
                    <small th:text="'–ë—Ä–µ–Ω–¥: ' + ${prod.brand.brandName}"></small><br>
                    <small th:if="${prod.supplier != null}" th:text="'–ü–æ—Å—Ç–∞–≤—â–∏–∫: ' + ${prod.supplier.name}"></small><br>
                    <small th:if="${prod.importPriceDate != null && prod.importPriceDate != ''}"
                           th:text="'–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–Ω—ã: ' + ${#strings.replace(prod.importPriceDate, ':', '.')}"></small><br>
                    <small class="text-danger" th:if="${prod.price != null}"
                           th:text="'–¶–µ–Ω–∞: ' + ${#strings.replace(#numbers.formatDecimal(prod.price, 1, 'COMMA', 1, 'POINT'), ',', ' ')} + ' ‚Ç∏'"></small>
                    <small class="text-danger" th:if="${prod.price == null}" th:text="'–¶–µ–Ω–∞: –ù–µ —É–∫–∞–∑–∞–Ω–∞'"></small>
                </div>
            </div>

            <div class="input-group" style="max-width: 160px;">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        th:onclick="'removeFromCart(' + ${prod.productId} + ')'">‚ûñ</button>
                <input type="number" min="0" class="form-control form-control-sm text-center"
                       th:id="'counter-' + ${prod.productId}"
                       th:value="${quantities[prod.productId] != null ? quantities[prod.productId] : 0}"
                       onchange="manualQuantityChange(this)"
                       style="max-width: 60px;">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        th:onclick="'addToCart(' + ${prod.productId} + ')'">‚ûï</button>
            </div>
        </div>
    </div>
    <div id="infinite-sentinel" style="height: 1px;"></div>

    <div id="loader" class="text-center my-4" style="display: none;">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
</div>

<!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ / –£–¥–∞–ª–µ–Ω–∏–µ -->
<div id="editModal" class="modal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
        background:white; border:1px solid #ccc; padding:20px; z-index:10000; width:400px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
    <h5>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h5>
    <form id="editProductForm">
        <input type="hidden" name="productId" id="edit-product-id">
        <div class="mb-2">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" name="name" class="form-control" id="edit-name">
        </div>
        <div class="mb-2">
            <label>–¶–µ–Ω–∞:</label>
            <input type="number" step="0.01" name="price" class="form-control" id="edit-price">
        </div>
        <div class="mb-2">
            <label>–ê—Ä—Ç–∏–∫—É–ª:</label>
            <input type="text" name="articleCode" class="form-control" id="edit-article">
        </div>
        <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-secondary me-2" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </form>
</div>

<div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
     background: rgba(0, 0, 0, 0.5); z-index: 9998;"></div>

<div id="deleteModal" style="display: none; position: fixed; top: 50%; left: 50%;
     transform: translate(-50%, -50%); background: white; padding: 20px;
     border: 1px solid #ccc; border-radius: 10px; z-index: 9999; width: 300px; max-width: 90%;">
    <p class="mb-3">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?</p>
    <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
</div>

<div th:replace="~{fragments/history_modal :: proposalHistoryModal}"></div>

<button id="scrollTopBtn" class="scroll-to-top" aria-label="–ù–∞–≤–µ—Ä—Ö">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up">
        <line x1="12" y1="19" x2="12" y2="5"/>
        <polyline points="5 12 12 5 19 12"/>
    </svg>
</button>

<!-- ====== –ú–û–î–ê–õ–ö–ê –ö–û–≠–§–§–ò–¶–ò–ï–ù–¢–û–í ====== -->
<div class="modal fade" id="coefModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">

            <div class="modal-header">
                <h5 class="modal-title">–ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç–∞ —Ü–µ–Ω</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫:</label>
                    <div class="d-flex gap-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="coefType"
                                   id="coefByBrand" value="brand" checked>
                            <label class="form-check-label" for="coefByBrand">–ë—Ä–µ–Ω–¥—É</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="coefType"
                                   id="coefBySupplier" value="supplier">
                            <label class="form-check-label" for="coefBySupplier">–ü–æ—Å—Ç–∞–≤—â–∏–∫—É</label>
                        </div>
                    </div>
                </div>

                <!-- –í—ã–±–æ—Ä –±—Ä–µ–Ω–¥–∞ -->
                <div class="mb-3" id="brandSelectBlock">
                    <label class="form-label">–ë—Ä–µ–Ω–¥</label>
                    <select class="form-select" id="coefBrandId">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
                        <option th:each="b : ${brands}"
                                th:value="${b.brandId}"
                                th:text="${b.brandName}"></option>
                    </select>
                </div>

                <!-- –í—ã–±–æ—Ä –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ -->
                <div class="mb-3 d-none" id="supplierSelectBlock">
                    <label class="form-label">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                    <select class="form-select" id="coefSupplierId">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</option>
                    </select>
                </div>

                <!-- –ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç -->
                <div class="mb-3">
                    <label class="form-label">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç (–º–Ω–æ–∂–∏—Ç–µ–ª—å)</label>
                    <input type="number" step="0.01" min="0"
                           class="form-control" id="coefValue" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä 1.10">
                    <div class="form-text">
                        –¶–µ–Ω–∞ —Å—Ç–∞–Ω–µ—Ç: –Ω–æ–≤–∞—è–¶–µ–Ω–∞ = —Å—Ç–∞—Ä–∞—è–¶–µ–Ω–∞ √ó –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç
                    </div>
                </div>

                <div class="alert alert-secondary small mb-0">
                    –ü—Ä–∏–º–µ—Ä: –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç 1.10 —É–≤–µ–ª–∏—á–∏—Ç —Ü–µ–Ω—ã –Ω–∞ 10%.
                    0.90 —É–º–µ–Ω—å—à–∏—Ç –Ω–∞ 10%.
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button class="btn btn-primary" onclick="applyCoefficient()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    let currentPage = /*[[${currentPage}]]*/ 0;
    const totalPages = /*[[${totalPages}]]*/ 1;
    let loading = false;

    // ===== URL STATE =====
    const urlState = (() => {
        const qs = new URLSearchParams(window.location.search);
        const keys = ['brandId','groupId','subGroupId','param1','param2','param3','param4','param5','keyword','sort'];
        const s = {};
        keys.forEach(k => {
            const v = qs.get(k);
            if (v !== null && String(v).trim() !== '') s[k] = v;
        });
        return s;
    })();

    function applyUrlStateToForm() {
        Object.keys(urlState).forEach(name => {
            const el = document.querySelector(`[name="${name}"]`);
            if (!el) return;
            if (String(el.value ?? '').trim() === '') {
                el.value = urlState[name];
            }
        });
    }

    function buildFilterParams() {
        const params = new URLSearchParams();
        ['brandId','groupId','subGroupId','param1','param2','param3','param4','param5','keyword','sort']
            .forEach(name => {
                const el = document.querySelector(`[name="${name}"]`);
                if (el && el.value !== null && el.value !== undefined && String(el.value).trim() !== '') {
                    params.set(name, el.value);
                }
            });
        return params;
    }

    function updateSelect(selectName, items) {
        const select = document.querySelector(`select[name="${selectName}"]`);
        if (!select) return;

        const currentValue = (String(select.value ?? '').trim() !== '')
            ? select.value
            : (urlState[selectName] ?? '');

        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>';

        (items || []).forEach(item => {
            const option = document.createElement('option');
            option.value = item.value ?? item;
            option.text  = item.text  ?? item;
            if (String(option.value) === String(currentValue)) option.selected = true;
            select.appendChild(option);
        });

        if (['param1','param2','param3','param4','param5'].includes(selectName)) {
            select.disabled = (items || []).length === 0;
        } else {
            select.disabled = false;
        }
    }

    function resetSelect(name, disable = false) {
        const s = document.querySelector(`select[name="${name}"]`);
        if (!s) return;
        s.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>';
        s.value = '';
        s.disabled = disable;
    }

    function resetParams() {
        ['param1','param2','param3','param4','param5'].forEach(p => resetSelect(p, true));
    }

    // ====== LOADERS ======
    async function loadGroups() {
        const brandId = document.querySelector('[name="brandId"]')?.value?.trim();
        const url = (brandId)
            ? `/filter/groups?brandId=${encodeURIComponent(brandId)}`
            : `/filter/groups/all`;

        const r = await fetch(url);
        const data = r.ok ? await r.json() : [];
        updateSelect('groupId', (data || []).map(g => ({ value: g.categoryId, text: g.name })));
    }

    async function loadSubGroups() {
        const brandId = document.querySelector('[name="brandId"]')?.value?.trim();
        const groupId = document.querySelector('[name="groupId"]')?.value?.trim();

        const subGroupId = document.querySelector('[name="subGroupId"]')?.value?.trim()
            || (urlState.subGroupId ? String(urlState.subGroupId) : '');

        const params = new URLSearchParams();
        if (brandId) params.set('brandId', brandId);
        if (groupId) params.set('groupId', groupId);
        if (subGroupId) params.set('subGroupId', subGroupId);

        const url = '/filter/subgroups' + (params.toString() ? ('?' + params.toString()) : '');

        const r = await fetch(url);
        const data = r.ok ? await r.json() : [];
        const list = (Array.isArray(data) ? data : [])
            .map(x => ({ value: x.categoryId, text: x.name }))
            .filter(x => x.value != null && x.text != null);

        updateSelect('subGroupId', list);
    }

    async function loadParameters() {
        const params = buildFilterParams();
        const r = await fetch('/filter/parameters?' + params.toString());
        const data = r.ok ? await r.json() : {};
        const d = data || {};
        ['param1','param2','param3','param4','param5'].forEach(p => {
            updateSelect(p, d[p + 'List'] || []);
        });
    }

    async function fetchAndApplyParamLabels() {
        const groupId = document.querySelector('select[name="groupId"]')?.value || urlState.groupId;
        const subGroupId = document.querySelector('select[name="subGroupId"]')?.value || urlState.subGroupId;

        const url = new URL('/filter/parameter-labels', window.location.origin);
        if (groupId) url.searchParams.set('groupId', groupId);
        if (subGroupId) url.searchParams.set('subGroupId', subGroupId);

        const r = await fetch(url);
        const labels = r.ok ? await r.json() : {};
        const lbl = labels || {};

        for (let i = 1; i <= 5; i++) {
            const key = 'param' + i;
            const container = document.getElementById(key + '-container');
            const labelEl   = document.getElementById('label-' + key);
            const select    = document.querySelector(`select[name="${key}"]`);
            if (!container || !labelEl || !select) continue;

            const text = (lbl[key] !== undefined && lbl[key] !== null) ? lbl[key] : ('–ü–∞—Ä–∞–º–µ—Ç—Ä ' + i);

            if (text === '') {
                container.style.display = 'none';
                select.value = '';
            } else {
                labelEl.textContent = String(text).endsWith(':') ? text : (text + ':');
                container.style.display = '';
            }
        }
    }

    function autoSubmit() {
        const form = document.querySelector('form[method="get"]');
        if (!form) return;

        const pageEl = document.getElementById('page');
        if (pageEl) pageEl.value = String(currentPage ?? 0);

        if (form.requestSubmit) form.requestSubmit();
        else form.submit();
    }

    // ====== FILTER CHANGE HANDLERS ======
    async function onBrandChange() {
        resetParams();
        resetSelect('groupId', false);
        resetSelect('subGroupId', false);

        await loadGroups();
        await loadSubGroups();
        await loadParameters();
        await fetchAndApplyParamLabels();

        currentPage = 0;
        // autoSubmit();
    }

    async function onGroupChange() {
        resetParams();
        resetSelect('subGroupId', false);

        await loadSubGroups();
        await loadParameters();
        await fetchAndApplyParamLabels();

        currentPage = 0;
        // autoSubmit();
    }

    async function onSubGroupChange() {
        resetParams();

        await loadParameters();
        await fetchAndApplyParamLabels();

        currentPage = 0;
        // autoSubmit();
    }

    function onParamChange() {
        currentPage = 0;
        // autoSubmit();
    }

    let done = false;
    let io = null;

    function getExistingIds() {
        return new Set(Array.from(document.querySelectorAll('[id^="product-"]')).map(e => e.id));
    }

    function extractItemsFromResponse(html) {
        const temp = document.createElement('div');
        temp.innerHTML = html;

        // –í–∞—Ä–∏–∞–Ω—Ç A: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –§–†–ê–ì–ú–ï–ù–¢ (items ‚Äî –ø—Ä—è–º—ã–µ –¥–µ—Ç–∏)
        let items = Array.from(temp.children).filter(n => n.classList?.contains('list-group-item'));

        // –í–∞—Ä–∏–∞–Ω—Ç B: —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –ü–û–õ–ù–£–Æ –°–¢–†–ê–ù–ò–¶–£ ‚Äî –≤—ã—Ç–∞—â–∏–º items –∏–∑ #product-list
        if (items.length === 0) {
            items = Array.from(temp.querySelectorAll('#product-list .list-group-item'));
        }

        // –ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å: –ø—Ä–æ—Å—Ç–æ –ø–æ —Å–µ–ª–µ–∫—Ç–æ—Ä—É
        if (items.length === 0) {
            items = Array.from(temp.querySelectorAll('.list-group-item[id^="product-"]'));
        }

        return items;
    }

    async function loadNextPage() {
        if (loading || done) return;

        loading = true;
        const loader = document.getElementById('loader');
        if (loader) loader.style.display = 'block';

        try {
            const nextPage = (Number(currentPage) || 0) + 1;

            const params = buildFilterParams();
            params.set('page', String(nextPage));

            const r = await fetch('/filter/results?' + params.toString(), {
                headers: { 'X-Requested-With': 'XMLHttpRequest' }
            });
            if (!r.ok) return;

            const html = await r.text();

            const list = document.getElementById('product-list');
            if (!list) return;

            const existing = getExistingIds();
            const items = extractItemsFromResponse(html);

            // —Ñ–∏–ª—å—Ç—Ä—É–µ–º –¥—É–±–ª–∏–∫–∞—Ç—ã –ø–æ product-*
            const newItems = items.filter(n => {
                const id = n.getAttribute?.('id');
                return id && id.startsWith('product-') && !existing.has(id);
            });

            if (newItems.length === 0) {
                // –ª–∏–±–æ –∫–æ–Ω–µ—Ü, –ª–∏–±–æ —Å–µ—Ä–≤–µ—Ä –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç page –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ –∂–µ —Å–∞–º–æ–µ
                done = true;
                if (io) io.disconnect();
                return;
            }

            newItems.forEach(n => list.appendChild(n));
            currentPage = nextPage;

        } finally {
            if (loader) loader.style.display = 'none';
            loading = false;
        }
    }

    function initInfiniteScroll() {
        const sentinel = document.getElementById('infinite-sentinel');
        if (!sentinel) return;

        if (io) io.disconnect();

        io = new IntersectionObserver(async (entries) => {
            if (!entries[0].isIntersecting) return;
            await loadNextPage();
        }, { root: null, rootMargin: '400px 0px', threshold: 0 });

        io.observe(sentinel);
    }


    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', async () => {
        applyUrlStateToForm();

        await loadGroups();
        await loadSubGroups();
        await loadParameters();
        await fetchAndApplyParamLabels();

        initInfiniteScroll();
    });
    window.addToCart = function(productId) {
        fetch("/cart/add", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded"
            },
            body: "productId=" + encodeURIComponent(productId)
        }).then(r => {
            if (!r.ok) return;

            // –ª–æ–∫–∞–ª—å–Ω–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º input —É —Ç–æ–≤–∞—Ä–∞
            const input = document.getElementById("counter-" + productId);
            if (input) input.value = (parseInt(input.value || "0") + 1);

            // –æ–±–Ω–æ–≤–ª—è–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã
            const cartCounter = document.getElementById("cart-counter");
            if (cartCounter) cartCounter.innerText =
                parseInt(cartCounter.innerText || "0") + 1;
        }).catch(e => console.error("addToCart error", e));
    };
    window.removeFromCart = function(productId) {
        fetch('/cart/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'productId=' + productId
        }).then(() => {
            const counter = document.getElementById('counter-' + productId);
            if (counter) {
                const newValue = (parseInt(counter.value) || 0) - 1;
                counter.value = Math.max(newValue, 0);
                if (counter.value == 0) unhighlightProduct(productId);
            }

            const cartCounter = document.getElementById('cart-counter');
            if (cartCounter)
                cartCounter.innerText = Math.max(0, parseInt(cartCounter.innerText) - 1);
        }).catch(e => console.error("removeFromCart error", e));
    };

    window.manualQuantityChange = function(input) {
        const productId = input.id.split('-')[1];
        const newQuantity = parseInt(input.value);

        if (isNaN(newQuantity) || newQuantity < 0) {
            input.value = 0;
            return;
        }

        fetch('/cart/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'productId=' + productId + '&quantity=' + newQuantity
        }).then(() => {
            if (newQuantity === 0) unhighlightProduct(productId);
            else highlightProduct(productId);
            updateCartCounterManually();
        }).catch(e => console.error("manualQuantityChange error", e));
    };

    window.highlightProduct = function(productId) {
        const el = document.getElementById('product-' + productId);
        if (el) el.classList.add('border','border-success','rounded','shadow-sm','bg-light');
    };

    window.unhighlightProduct = function(productId) {
        const el = document.getElementById('product-' + productId);
        if (el) el.classList.remove('border','border-success','rounded','shadow-sm','bg-light');
    };

    window.updateCartCounterManually = function() {
        let total = 0;
        document.querySelectorAll('input[id^="counter-"]').forEach(c =>
            total += parseInt(c.value) || 0
        );
        const cartCounter = document.getElementById('cart-counter');
        if (cartCounter) cartCounter.innerText = total;
    };

    const scrollTopBtn = document.getElementById("scrollTopBtn");

    window.addEventListener("scroll", function () {
        if (window.scrollY > 200) scrollTopBtn.classList.add("show");
        else scrollTopBtn.classList.remove("show");
    });

    scrollTopBtn.addEventListener("click", function () {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    document.addEventListener('DOMContentLoaded', () => {
        function updateCoefTypeUI() {
            const type = document.querySelector('input[name="coefType"]:checked')?.value;
            document.getElementById('brandSelectBlock').classList.toggle('d-none', type !== 'brand');
            document.getElementById('supplierSelectBlock').classList.toggle('d-none', type !== 'supplier');
        }

        document.querySelectorAll('input[name="coefType"]').forEach(r =>
            r.addEventListener('change', updateCoefTypeUI)
        );

        function loadSuppliersForCoefModal() {
            fetch('/admin/api/suppliers')
                .then(r => r.json())
                .then(list => {
                    const sel = document.getElementById('coefSupplierId');
                    sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞</option>';
                    list.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s.supplierId;
                        opt.textContent = s.name;
                        sel.appendChild(opt);
                    });
                });
        }

        const coefModalEl = document.getElementById('coefModal');
        if (coefModalEl) {
            coefModalEl.addEventListener('shown.bs.modal', () => {
                updateCoefTypeUI();
                loadSuppliersForCoefModal();
            });
        }
    });
    function applyCoefficient() {
        const type = document.querySelector('input[name="coefType"]:checked').value;
        const coef = parseFloat(document.getElementById('coefValue').value);

        if (isNaN(coef) || coef <= 0) { alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç > 0'); return; }

        let id = (type === 'brand')
            ? document.getElementById('coefBrandId').value
            : document.getElementById('coefSupplierId').value;

        if (!id) { alert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç'); return; }

        fetch('/admin/api/prices/apply-coef', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ type, id: parseInt(id), coef })
        }).then(r => {
            if (!r.ok) throw new Error();
            alert('–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –ø—Ä–∏–º–µ–Ω—ë–Ω');
            location.reload();
        }).catch(() => alert('–û—à–∏–±–∫–∞'));
    }

</script>

</body>
</html>
