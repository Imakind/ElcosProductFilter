<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è (—Ç–æ–ª—å–∫–æ Bootstrap) -->
<nav class="navbar navbar-expand-md navbar-light bg-white shadow-sm fixed-top">
    <div class="container">
        <a class="navbar-brand fw-semibold" href="/">ProductFilter</a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#topNav"
                aria-controls="topNav" aria-expanded="false" aria-label="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏—é">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="topNav">
            <ul class="navbar-nav me-auto align-items-md-center gap-2">
                <li class="nav-item">
                    <button class="btn btn-outline-secondary"
                            type="button"
                            data-bs-toggle="offcanvas" data-bs-target="#historySidebar">
                        üìÇ –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–æ–≤
                    </button>
                </li>
                <li class="nav-item" sec:authorize="hasRole('ADMIN')">
                    <a href="/admin/add-product" class="btn btn-success">‚ûï –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</a>
                </li>
            </ul>

            <ul class="navbar-nav ms-auto align-items-md-center gap-2">
                <li class="nav-item">
                    <a href="/cart" class="btn btn-outline-primary position-relative">
                        üõí –ö–æ—Ä–∑–∏–Ω–∞
                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
                          <span id="cart-counter" th:text="${cartCount != null ? cartCount : 0}">0</span>
                        </span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/logout" class="btn btn-outline-dark">–í—ã–π—Ç–∏</a>
                </li>
            </ul>
        </div>
    </div>
</nav>

<style>
    body { padding-top: 72px; }
    .scroll-to-top {
        position: fixed; bottom: 24px; right: 24px; z-index: 1050;
        width: 48px; height: 48px; border: none; border-radius: 50%;
        background-color: #343a40; color: #fff; display: flex;
        align-items: center; justify-content: center; opacity: 0;
        visibility: hidden; transform: translateY(20px);
        transition: opacity 0.3s ease, transform 0.3s ease;
    }
    .scroll-to-top.show { opacity: 1; visibility: visible; transform: translateY(0); }
    .scroll-to-top:hover { background-color: #495057; transform: translateY(0) scale(1.1); }
</style>

<div class="container">
    <h2 class="mb-4">–§–∏–ª—å—Ç—Ä —Ç–æ–≤–∞—Ä–æ–≤</h2>
    <form method="get" th:action="@{/filter/results}">
        <div class="row mb-3">
            <div class="col">
                <label class="form-label" for="brandId">–ë—Ä–µ–Ω–¥:</label>
                <select id="brandId" name="brandId" class="form-select" onchange="onBrandChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>
                    <option th:each="brand : ${brands}"
                            th:value="${brand.brandId}"
                            th:text="${brand.brandName}"
                            th:selected="${brand.brandId == filterParams['brandId']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label class="form-label" for="groupId">–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞:</label>
                <select id="groupId" name="groupId" class="form-select" onchange="onGroupChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–ø–ø—É</option>
                    <option th:each="group : ${groups}"
                            th:value="${group.categoryId}"
                            th:text="${group.name}"
                            th:selected="${group.categoryId == filterParams['groupId']}">
                    </option>
                </select>
            </div>
            <div class="col">
                <label class="form-label" for="subGroupId">–ü–æ–¥–≥—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞:</label>
                <select id="subGroupId" name="subGroupId" class="form-select" onchange="onSubGroupChange()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥–≥—Ä—É–ø–ø—É</option>
                    <option th:each="sub : ${subGroups}"
                            th:value="${sub.categoryId}"
                            th:text="${sub.name}"
                            th:selected="${sub.categoryId == filterParams['subGroupId']}">
                    </option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col" id="param1-container">
                <label id="label-param1" for="param1" class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä 1:</label>
                <select id="param1" name="param1" class="form-select" onchange="updateParameters()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param1List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param1']}"></option>
                </select>
            </div>

            <div class="col" id="param2-container">
                <label id="label-param2" for="param2" class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä 2:</label>
                <select id="param2" name="param2" class="form-select" onchange="updateParameters()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param2List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param2']}"></option>
                </select>
            </div>

            <div class="col" id="param3-container">
                <label id="label-param3" for="param3" class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä 3:</label>
                <select id="param3" name="param3" class="form-select" onchange="updateParameters()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param3List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param3']}"></option>
                </select>
            </div>

            <div class="col" id="param4-container">
                <label id="label-param4" for="param4" class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä 4:</label>
                <select id="param4" name="param4" class="form-select" onchange="updateParameters()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param4List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param4']}"></option>
                </select>
            </div>

            <div class="col" id="param5-container">
                <label id="label-param5" for="param5" class="form-label">–ü–∞—Ä–∞–º–µ—Ç—Ä 5:</label>
                <select id="param5" name="param5" class="form-select" onchange="updateParameters()">
                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>
                    <option th:each="val : ${param5List}"
                            th:value="${val}" th:text="${val}"
                            th:selected="${val == filterParams['param5']}"></option>
                </select>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col">
                <label class="form-label" for="keyword">–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é:</label>
                <input id="keyword" type="text" name="keyword" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."
                       th:value="${filterParams['keyword']}">
            </div>
        </div>

        <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
    </form>

    <hr class="my-4">
    <h4>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:</h4>

    <div class="d-flex justify-content-end mb-3">
        <button id="sortButton" class="btn btn-outline-secondary">üßπ –°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
    <div id="sortModal" style="
        display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-30%);
        background:white; border:1px solid #ccc; padding:20px; z-index:10000;
        box-shadow:0 4px 12px rgba(0,0,0,0.2); border-radius:8px;">
        <h5>–°–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ:</h5>
        <div>
            <input type="checkbox" name="sortOption" value="priceAsc" id="priceAsc">
            <label for="priceAsc">–¶–µ–Ω–∞ (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é)</label><br>
            <input type="checkbox" name="sortOption" value="priceDesc" id="priceDesc">
            <label for="priceDesc">–¶–µ–Ω–∞ (–ø–æ —É–±—ã–≤–∞–Ω–∏—é)</label><br>
            <input type="checkbox" name="sortOption" value="nameAsc" id="nameAsc">
            <label for="nameAsc">–ù–∞–∑–≤–∞–Ω–∏–µ (A-Z)</label><br>
            <input type="checkbox" name="sortOption" value="nameDesc" id="nameDesc">
            <label for="nameDesc">–ù–∞–∑–≤–∞–Ω–∏–µ (Z-A)</label><br>
            <input type="checkbox" name="sortOption" value="brandAsc" id="brandAsc">
            <label for="brandAsc">–ë—Ä–µ–Ω–¥ (A-Z)</label><br>
            <input type="checkbox" name="sortOption" value="brandDesc" id="brandDesc">
            <label for="brandDesc">–ë—Ä–µ–Ω–¥ (Z-A)</label><br>
        </div>
        <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-primary" onclick="applySort()">‚úÖ –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
    </div>

    <div id="product-list" class="list-group" th:if="${products != null}">
        <div class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center"
             style="min-height: 100px;"
             th:each="prod : ${products}"
             th:id="'product-' + ${prod.productId}"
             th:classappend="${quantities != null and quantities[prod.productId] != null} ? ' border border-success rounded shadow-sm bg-light' : ''">
            <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å: –∫–Ω–æ–ø–∫–∏ –∏ –∏–Ω—Ñ–æ -->
            <div class="d-flex flex-grow-1 flex-column flex-md-row w-100">
                <div class="me-3 d-flex flex-row flex-md-column gap-1">
                    <button class="btn btn-outline-secondary btn-sm"
                            style="display: none;"
                            th:attr="onclick='openEditModal(' + ${prod.productId} + ')'"
                            title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä">‚úè</button>
                    <button class="btn btn-outline-danger btn-sm"
                            th:attr="onclick='showDeleteConfirmation(' + ${prod.productId} + ')'"
                            title="–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä"
                            sec:authorize="hasRole('ADMIN')">üóë</button>
                </div>

                <div class="flex-grow-1">
                    <h5 class="mb-1" style="word-break: break-word;">
                        <span th:text="${prod.name}">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</span>
                    </h5>
                    <small th:text="'–ë—Ä–µ–Ω–¥: ' + ${prod.brand.brandName}"></small><br>
                    <small th:if="${prod.supplier != null}" th:text="'–ü–æ—Å—Ç–∞–≤—â–∏–∫: ' + ${prod.supplier.name}"></small><br>
                    <small th:if="${prod.importPriceDate != null && prod.importPriceDate != ''}"
                           th:text="'–î–∞—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ü–µ–Ω—ã: ' + ${#strings.replace(prod.importPriceDate, ':', '.')}"></small><br>
                    <small class="text-danger" th:if="${prod.price != null}"
                           th:text="'–¶–µ–Ω–∞: ' + ${#strings.replace(#numbers.formatDecimal(prod.price, 1, 'COMMA', 1, 'POINT'), ',', ' ')} + ' ‚Ç∏'"></small>
                    <small class="text-danger" th:if="${prod.price == null}" th:text="'–¶–µ–Ω–∞: –ù–µ —É–∫–∞–∑–∞–Ω–∞'"></small>
                </div>
            </div>

            <!-- –ö–æ—Ä–∑–∏–Ω–∞ -->
            <div class="input-group" style="max-width: 160px;">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        th:onclick="'removeFromCart(' + ${prod.productId} + ')'">‚ûñ</button>
                <input type="number" min="0" class="form-control form-control-sm text-center"
                       th:id="'counter-' + ${prod.productId}"
                       th:value="${quantities[prod.productId] != null ? quantities[prod.productId] : 0}"
                       onchange="manualQuantityChange(this)"
                       style="max-width: 60px;">
                <button type="button" class="btn btn-outline-secondary btn-sm"
                        th:onclick="'addToCart(' + ${prod.productId} + ')'">‚ûï</button>
            </div>
        </div>
    </div>
</div>

<div id="loader" class="text-center my-4" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ / –£–¥–∞–ª–µ–Ω–∏–µ -->
<div id="editModal" class="modal" style="display:none; position:fixed; top:10%; left:50%; transform:translateX(-50%);
        background:white; border:1px solid #ccc; padding:20px; z-index:10000; width:400px; box-shadow:0 4px 12px rgba(0,0,0,0.2);">
    <h5>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä</h5>
    <form id="editProductForm">
        <input type="hidden" name="productId" id="edit-product-id">
        <div class="mb-2">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
            <input type="text" name="name" class="form-control" id="edit-name">
        </div>
        <div class="mb-2">
            <label>–¶–µ–Ω–∞:</label>
            <input type="number" step="0.01" name="price" class="form-control" id="edit-price">
        </div>
        <div class="mb-2">
            <label>–ê—Ä—Ç–∏–∫—É–ª:</label>
            <input type="text" name="articleCode" class="form-control" id="edit-article">
        </div>
        <div class="d-flex justify-content-end">
            <button type="button" class="btn btn-secondary me-2" onclick="closeEditModal()">–û—Ç–º–µ–Ω–∞</button>
            <button type="submit" class="btn btn-primary">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </form>
</div>

<div id="modalOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
     background: rgba(0, 0, 0, 0.5); z-index: 9998;"></div>

<div id="deleteModal" style="display: none; position: fixed; top: 50%; left: 50%;
     transform: translate(-50%, -50%); background: white; padding: 20px;
     border: 1px solid #ccc; border-radius: 10px; z-index: 9999; width: 300px; max-width: 90%;">
    <p class="mb-3">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?</p>
    <div class="d-flex justify-content-end gap-2">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-danger" id="confirmDeleteBtn">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
</div>

<div th:replace="~{fragments/history_modal :: proposalHistoryModal}"></div>

<button id="scrollTopBtn" class="scroll-to-top" aria-label="–ù–∞–≤–µ—Ä—Ö">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-arrow-up">
        <line x1="12" y1="19" x2="12" y2="5"/>
        <polyline points="5 12 12 5 19 12"/>
    </svg>
</button>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script th:inline="javascript">
    let allSubGroups = [];
    let currentPage = /*[[${currentPage}]]*/ 0;
    const totalPages = /*[[${totalPages}]]*/ 1;
    let loading = false;

    // ====== DATA LOADERS ======
    function updateSelect(selectName, items) {
        const select = document.querySelector(`select[name="${selectName}"]`);
        if (!select) return;
        const currentValue = select.value;
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ</option>';
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.value || item;
            option.text  = item.text  || item;
            if (option.value == currentValue) option.selected = true;
            select.appendChild(option);
        });
        select.disabled = items.length === 0;
    }

    function updateGroups() {
        const brandId = document.querySelector('select[name="brandId"]').value;
        if (!brandId) return;
        fetch(`/filter/groups?brandId=${brandId}`)
            .then(res => res.json())
            .then(data => updateSelect('groupId', data.map(g => ({value: g.categoryId, text: g.name}))));
    }

    function updateSubGroups() {
        const groupId = document.querySelector('select[name="groupId"]').value;
        if (!groupId) { updateSelect('subGroupId', []); return; }
        const subgroups = allSubGroups.filter(sg => sg.parentCategoryId == groupId);
        updateSelect('subGroupId', subgroups.map(sg => ({value: sg.categoryId, text: sg.name})));
    }

    function updateParameters() {
        const brandId = document.querySelector('select[name="brandId"]').value;
        const groupId = document.querySelector('select[name="groupId"]').value;
        const subGroupId = document.querySelector('select[name="subGroupId"]').value;

        let url = `/filter/parameters?`;
        if (brandId)  url += `brandId=${brandId}&`;
        if (groupId)  url += `groupId=${groupId}&`;
        if (subGroupId) url += `subGroupId=${subGroupId}`;

        fetch(url)
            .then(res => res.json())
            .then(data => {
                ['param1','param2','param3','param4','param5'].forEach(param => {
                    updateSelect(param, data[param + 'List'] || []);
                });
            });
    }

    function fetchAndApplyParamLabels() {
        const groupId = document.querySelector('select[name="groupId"]').value;
        const subGroupId = document.querySelector('select[name="subGroupId"]').value;

        const url = new URL('/filter/parameter-labels', window.location.origin);
        if (groupId) url.searchParams.set('groupId', groupId);
        if (subGroupId) url.searchParams.set('subGroupId', subGroupId);

        fetch(url)
            .then(r => r.json())
            .then(labels => {
                for (let i = 1; i <= 5; i++) {
                    const key = 'param' + i;
                    const container = document.getElementById(key + '-container');
                    const labelEl   = document.getElementById('label-' + key);
                    const select    = document.querySelector(`select[name="${key}"]`);
                    if (!container || !labelEl || !select) continue;

                    const text = (labels[key] !== undefined && labels[key] !== null)
                        ? labels[key] : ('–ü–∞—Ä–∞–º–µ—Ç—Ä ' + i);

                    if (text === '') {
                        labelEl.textContent = '–ü–∞—Ä–∞–º–µ—Ç—Ä ' + i;
                        container.style.display = 'none';
                        select.value = '';
                    } else {
                        labelEl.textContent = text.endsWith(':') ? text : (text + ':');
                        container.style.display = '';
                    }
                }
            })
            .catch(err => console.error('parameter-labels failed', err));
    }

    // ====== FILTER CHANGE HANDLERS ======
    function onAnyFilterChange() {
        updateGroups();
        updateSubGroups();
        updateParameters();
        fetchAndApplyParamLabels();
    }
    function onBrandChange() { onAnyFilterChange(); }
    function onGroupChange() { updateSubGroups(); updateParameters(); fetchAndApplyParamLabels(); }
    function onSubGroupChange() {
        const subGroupId = document.querySelector('select[name="subGroupId"]').value;
        if (subGroupId) {
            const selected = allSubGroups.find(sg => sg.categoryId == subGroupId);
            if (selected) {
                document.querySelector('select[name="groupId"]').value = selected.parentCategoryId;
                updateSubGroups();
            }
        }
        updateParameters();
        fetchAndApplyParamLabels();
    }

    // ====== CART HELPERS ======
    function addToCart(productId) {
        fetch('/cart/add?productId=' + productId, { method: 'POST' })
            .then(() => {
                const counter = document.getElementById('counter-' + productId);
                if (counter) counter.value = (parseInt(counter.value) || 0) + 1;
                const cartCounter = document.getElementById('cart-counter');
                if (cartCounter) cartCounter.innerText = parseInt(cartCounter.innerText) + 1;
                highlightProduct(productId);
            });
    }

    function removeFromCart(productId) {
        fetch('/cart/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'productId=' + productId
        }).then(() => {
            const counter = document.getElementById('counter-' + productId);
            if (counter) {
                const newValue = (parseInt(counter.value) || 0) - 1;
                counter.value = Math.max(newValue, 0);
                if (counter.value == 0) unhighlightProduct(productId);
            }
            const cartCounter = document.getElementById('cart-counter');
            if (cartCounter) cartCounter.innerText = Math.max(0, parseInt(cartCounter.innerText) - 1);
        });
    }

    function manualQuantityChange(input) {
        const productId = input.id.split('-')[1];
        const newQuantity = parseInt(input.value);
        if (isNaN(newQuantity) || newQuantity < 0) { input.value = 0; return; }

        fetch('/cart/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
            body: 'productId=' + productId + '&quantity=' + newQuantity
        })
            .then(() => {
                if (newQuantity === 0) unhighlightProduct(productId);
                else highlightProduct(productId);
                updateCartCounterManually();
            });
    }

    function highlightProduct(productId) {
        const productBlock = document.getElementById('product-' + productId);
        if (productBlock) productBlock.classList.add('border','border-success','rounded','shadow-sm','bg-light');
    }
    function unhighlightProduct(productId) {
        const productBlock = document.getElementById('product-' + productId);
        if (productBlock) productBlock.classList.remove('border','border-success','rounded','shadow-sm','bg-light');
    }
    function updateCartCounterManually() {
        let total = 0;
        document.querySelectorAll('input[id^="counter-"]').forEach(c => total += parseInt(c.value) || 0);
        const cartCounter = document.getElementById('cart-counter');
        if (cartCounter) cartCounter.innerText = total;
    }

    // ====== INFINITE SCROLL ======
    window.addEventListener('scroll', () => {
        if (loading) return;
        if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 200) {
            if (currentPage + 1 < totalPages) loadNextPage();
        }
    });

    function loadNextPage() {
        loading = true;
        document.getElementById('loader').style.display = 'block';
        currentPage++;

        const params = new URLSearchParams({
            brandId: document.querySelector('select[name="brandId"]').value,
            groupId: document.querySelector('select[name="groupId"]').value,
            subGroupId: document.querySelector('select[name="subGroupId"]').value,
            param1: document.querySelector('select[name="param1"]').value,
            param2: document.querySelector('select[name="param2"]').value,
            param3: document.querySelector('select[name="param3"]').value,
            param4: document.querySelector('select[name="param4"]').value,
            param5: document.querySelector('select[name="param5"]').value,
            sort: (new URLSearchParams(window.location.search)).get('sort'),
            page: currentPage
        });

        fetch('/filter/results?' + params.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(response => response.text())
            .then(html => {
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                const newProducts = tempDiv.querySelectorAll('.list-group-item');
                newProducts.forEach(item => {
                    item.style.opacity = '0';
                    item.style.transition = 'opacity 0.5s ease';
                    document.getElementById('product-list').appendChild(item);
                    setTimeout(() => { item.style.opacity = '1'; }, 50);
                });
                document.getElementById('loader').style.display = 'none';
                loading = false;
            })
            .catch(error => {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:', error);
                document.getElementById('loader').style.display = 'none';
                loading = false;
            });
    }

    // ====== SORT UI ======
    document.getElementById('sortButton').addEventListener('click', function() {
        document.getElementById('sortModal').style.display = 'block';
    });
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('sortModal');
        if (event.target === modal) modal.style.display = 'none';
    });
    function applySort() {
        const selected = document.querySelectorAll('input[name="sortOption"]:checked');
        const sortValues = Array.from(selected).map(i => i.value);
        const params = new URLSearchParams(window.location.search);
        if (sortValues.length > 0) params.set('sort', sortValues.join(','));
        else params.delete('sort');
        params.set('page', 0);
        window.location.href = '/filter/results?' + params.toString();
    }

    // ====== EDIT / DELETE ======
    function openEditModal(productId) {
        fetch('/admin/api/product?id=' + productId)
            .then(r => r.json())
            .then(product => {
                document.getElementById('edit-product-id').value = product.productId;
                document.getElementById('edit-name').value = product.name;
                document.getElementById('edit-price').value = product.price;
                document.getElementById('edit-article').value = product.articleCode;
                document.getElementById('editModal').style.display = 'block';
            });
    }
    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }
    document.getElementById('editProductForm')?.addEventListener('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        fetch('/admin/api/edit-product', { method: 'POST', body: new URLSearchParams(formData) })
            .then(() => { closeEditModal(); location.reload(); });
    });

    let productToDelete = null;
    function showDeleteConfirmation(productId) {
        productToDelete = productId;
        document.getElementById('modalOverlay').style.display = 'block';
        document.getElementById('deleteModal').style.display = 'block';
        document.getElementById('confirmDeleteBtn').focus();
    }
    function closeDeleteModal() {
        productToDelete = null;
        document.getElementById('deleteModal').style.display = 'none';
        document.getElementById('modalOverlay').style.display = 'none';
    }
    document.getElementById('confirmDeleteBtn').addEventListener('click', function () {
        if (!productToDelete) return;
        fetch('/admin/api/product/' + productToDelete, { method: 'DELETE' })
            .then(() => {
                document.getElementById('product-' + productToDelete)?.remove();
                closeDeleteModal();
            });
    });
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' && document.getElementById('deleteModal').style.display === 'block')
            document.getElementById('confirmDeleteBtn').click();
        if (e.key === 'Escape') closeDeleteModal();
    });

    // ====== SCROLL TO TOP ======
    const scrollTopBtn = document.getElementById("scrollTopBtn");
    window.addEventListener("scroll", function () {
        if (window.scrollY > 200) scrollTopBtn.classList.add("show");
        else scrollTopBtn.classList.remove("show");
    });
    scrollTopBtn.addEventListener("click", function () {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // ====== INITIALIZE ======
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/filter/subgroups/all')
            .then(res => res.json())
            .then(data => {
                allSubGroups = data || [];
                const groupId = document.querySelector('select[name="groupId"]').value;
                if (groupId) updateSubGroups();
                onAnyFilterChange();
            });
        // –ø–µ—Ä–≤–∏—á–Ω–∞—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–¥–ø–∏—Å–µ–π (–µ—Å–ª–∏ —É–∂–µ –≤—ã–±—Ä–∞–Ω—ã –≥—Ä—É–ø–ø–∞/–ø–æ–¥–≥—Ä—É–ø–ø–∞)
        fetchAndApplyParamLabels();
    });
</script>
</body>
</html>
